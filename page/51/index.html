<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content=""><meta name="keywords" content=""><meta name="author" content="Joe Huang"><meta name="copyright" content="Joe Huang"><title>Awaken Desparado</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.6.1"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.6.1"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  }
} </script><meta name="generator" content="Hexo 4.1.1"></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="false"><div class="author-info"><div class="author-info__avatar text-center"><img src="/img/avatar.png"></div><div class="author-info__name text-center">Joe Huang</div><div class="author-info__description text-center"></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">298</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">25</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">Categories</span><span class="pull-right">45</span></a></div></div></div><nav class="no-bg" id="nav"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Awaken Desparado</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span><span class="pull-right"></span></div><div id="site-info"><div id="site-title">Awaken Desparado</div><div id="site-sub-title"></div></div></nav><div id="content-outer"><div class="layout" id="content-inner"><div class="recent-post-item article-container"><a class="article-title" href="/2019/04/10/Web/Django/2019-04-10-Django%20note/">Web/Django/2019-04-10-Django note</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2019-04-10</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/Web/">Web</a></span><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/Django/">Django</a></span><div class="content"></div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2019/04/05/System-Design/9p/2019-04-05-Location%20Based%20Service%20Design%20&amp;%20Uber/">System-Design/9p/2019-04-05-Location Based Service Design &amp; Uber</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2019-04-05</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/SystemDesign/">SystemDesign</a></span><div class="content"><h3 id="Index"><a href="#Index" class="headerlink" title="Index"></a>Index</h3><p><img src="https://tva1.sinaimg.cn/large/00831rSTgy1gdj89p8x7zj31140fqdpo.jpg" alt="image-20200405214845930"></p>
<p><img src="https://tva1.sinaimg.cn/large/00831rSTgy1gdj8bi4vkpj31180gw105.jpg" alt="image-20200405215030180"></p>
<p>為了減少磁盤磁頭挪動找的次數，二叉的話樹會太高。</p>
<p><img src="https://tva1.sinaimg.cn/large/00831rSTgy1gdj8czu4cmj30tu0dyjxn.jpg" alt="image-20200405215156714"></p>
<p>唯一：如user_name, email, phone_number</p>
<p>聯合：關手到兩個col的需求要建聯合索合</p>
<p>條件：去篩掉不付錢的，他們的index太大了，我不想查到他們</p>
<p>★聯合索引不能解決分別查 A 的範圍和 B 的範圍然後再求交集這件事情，它是照第一鍵排序後，當第一鍵有相等值的話再照第二鍵去排。然後將查到的id再去原表裡查，也是座標排序法–x不等的照x排序，x相等的按照y排序。</p>
<h1 id="LBS"><a href="#LBS" class="headerlink" title="LBS"></a>LBS</h1><p>Location Based Service</p>
<h2 id="Uber-技術棧"><a href="#Uber-技術棧" class="headerlink" title="Uber 技術棧"></a>Uber 技術棧</h2><p>派單 vs 搶單</p>
<h3 id="派單模式"><a href="#派單模式" class="headerlink" title="派單模式"></a>派單模式</h3><ul>
<li>ringpop ，一種去中心化的架構</li>
<li>Channel, 高效 RPC</li>
<li>Google S2</li>
<li>Riak</li>
</ul>
<h3 id="T-Channel"><a href="#T-Channel" class="headerlink" title="T Channel"></a>T Channel</h3><p>一種RPC(遠程函數調用)協議。怎麼把不同進程間內存作序列化傳輸及反序列化解析。</p>
<p>RPC 服務器之間的，HTTPS話還要對資訊作加密，防用戶端的hacker之類。</p>
<p>如果流量不大的話用 http 也ok, http 比較現成，比較好寫，如果要寫thrift還要定義結構，不如json方便。http相對rpc要慢一些，其實主要是設計為客戶端跟服務器之間的通信，而客戶端問題多，搗亂的人多，需要驗證，要提供放cookie裡的驗證，一下就好幾k到好幾10k，而服務器之間其實可能就只要幾百個字節。</p>
<p>RPC還多了壓縮，讓效率高、延遲低。server2server就放LAN, 也不用加密。不用擔心不合理的傳來的數據。防驗證該是firewall該做的。</p>
<blockquote>
<h5 id="多选题-现有的比较成熟的、广泛使用的RPC协议有哪些？"><a href="#多选题-现有的比较成熟的、广泛使用的RPC协议有哪些？" class="headerlink" title="[多选题]现有的比较成熟的、广泛使用的RPC协议有哪些？"></a>[多选题]现有的比较成熟的、广泛使用的RPC协议有哪些？</h5><p>A.HTTP27.04% 选择</p>
<p>B.Thrift38.66% 选择</p>
<p>C.ProtoBuf34.30% 选择</p>
<p><img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBzdGFuZGFsb25lPSJubyI/PjwhRE9DVFlQRSBzdmcgUFVCTElDICItLy9XM0MvL0RURCBTVkcgMS4xLy9FTiIgImh0dHA6Ly93d3cudzMub3JnL0dyYXBoaWNzL1NWRy8xLjEvRFREL3N2ZzExLmR0ZCI+PHN2ZyB0PSIxNTQxNzAwNjYyNTQzIiBjbGFzcz0iaWNvbiIgc3R5bGU9IiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgdmVyc2lvbj0iMS4xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHAtaWQ9IjEwODgiIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB3aWR0aD0iNjQiIGhlaWdodD0iNjQiPjxkZWZzPjxzdHlsZSB0eXBlPSJ0ZXh0L2NzcyI+PC9zdHlsZT48L2RlZnM+PHBhdGggZD0iTTUxMiAwYTUxMiA1MTIgMCAxIDAgMCAxMDI0QTUxMiA1MTIgMCAwIDAgNTEyIDB6IG0xNjUuOTUyIDYzNy43NmwxNS4wNCAxNC45NzZhMjguNDE2IDI4LjQxNiAwIDEgMS00MC4yNTYgNDAuMjU2bC0xNC45NzYtMTUuMDRMNTA5LjUwNCA1NDkuNzYgMzcxLjIgNjg4YTI4LjQxNiAyOC40MTYgMCAxIDEtNDAuMjU2LTQwLjI1NmwxMzguMzA0LTEzOC4yNC0xMjMuMi0xMjMuMi0xNS4xMDQtMTUuMTA0YTI4LjU0NCAyOC41NDQgMCAwIDEgMC00MC4yNTYgMjguNTQ0IDI4LjU0NCAwIDAgMSA0MC4yNTYgMGwxNS4wNCAxNS4xMDRMNTA5LjQ0IDQ2OS4yNDhsMTQzLjIzMi0xNDMuMjk2YTI4LjQxNiAyOC40MTYgMCAxIDEgNDAuMjU2IDQwLjI1Nkw1NDkuNzYgNTA5LjUwNGwxMjguMTkyIDEyOC4yNTZ6IiBmaWxsPSIjRjY1RTVFIiBwLWlkPSIxMDg5Ij48L3BhdGg+PC9zdmc+" alt="img">答错了，您选择的答案是AB</p>
<p><strong>正确答案:</strong>ABC</p>
<p><strong>解析:</strong></p>
<p>Thrift 是 Facebook 的，ProtoBuf 是 Google 的。<br>Http 也可以认为是一个 RPC。</p>
</blockquote>
<blockquote>
<h5 id="单选题-生活中运用地最广泛的RPC协议是？"><a href="#单选题-生活中运用地最广泛的RPC协议是？" class="headerlink" title="[单选题]生活中运用地最广泛的RPC协议是？"></a>[单选题]生活中运用地最广泛的RPC协议是？</h5><p>A.HTTP97.39% 选择</p>
<p>B.Thrift1.21% 选择</p>
<p>C.ProtoBuf1.40% 选择</p>
<p><img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBzdGFuZGFsb25lPSJubyI/PjwhRE9DVFlQRSBzdmcgUFVCTElDICItLy9XM0MvL0RURCBTVkcgMS4xLy9FTiIgImh0dHA6Ly93d3cudzMub3JnL0dyYXBoaWNzL1NWRy8xLjEvRFREL3N2ZzExLmR0ZCI+PHN2ZyB0PSIxNTM0MTgxMjgxODM5IiBjbGFzcz0iaWNvbiIgc3R5bGU9IiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgdmVyc2lvbj0iMS4xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHAtaWQ9IjM3NjIiIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB3aWR0aD0iMzIiIGhlaWdodD0iMzIiPjxkZWZzPjxzdHlsZSB0eXBlPSJ0ZXh0L2NzcyI+PC9zdHlsZT48L2RlZnM+PHBhdGggZD0iTTUxOC4xMiA1MTYuMTZtLTQ5MCAwYTQ5MCA0OTAgMCAxIDAgOTgwIDAgNDkwIDQ5MCAwIDEgMC05ODAgMFoiIGZpbGw9IiM1NkI0MzIiIHAtaWQ9IjM3NjMiPjwvcGF0aD48cGF0aCBkPSJNMzkzLjIxMzYxOSA2NjQuMzM1NDk1bTI4LjI4NDI3MS0yOC4yODQyNzFsMjk2Ljk4NDg0OS0yOTYuOTg0ODQ4cTI4LjI4NDI3MS0yOC4yODQyNzEgNTYuNTY4NTQyIDBsMCAwcTI4LjI4NDI3MSAyOC4yODQyNzEgMCA1Ni41Njg1NDJsLTI5Ni45ODQ4NDggMjk2Ljk4NDg0OHEtMjguMjg0MjcxIDI4LjI4NDI3MS01Ni41Njg1NDMgMGwwIDBxLTI4LjI4NDI3MS0yOC4yODQyNzEgMC01Ni41Njg1NDJaIiBmaWxsPSIjRkZGRkZGIiBwLWlkPSIzNzY0Ij48L3BhdGg+PHBhdGggZD0iTTI4OS40Njk4NCA0NTIuODQ3ODgzbTI4LjI4NDI3MSAyOC4yODQyNzFsMTU1LjU2MzQ5MiAxNTUuNTYzNDkycTI4LjI4NDI3MSAyOC4yODQyNzEgMCA1Ni41Njg1NDNsMCAwcS0yOC4yODQyNzEgMjguMjg0MjcxLTU2LjU2ODU0MyAwbC0xNTUuNTYzNDkxLTE1NS41NjM0OTJxLTI4LjI4NDI3MS0yOC4yODQyNzEgMC01Ni41Njg1NDNsMCAwcTI4LjI4NDI3MS0yOC4yODQyNzEgNTYuNTY4NTQyIDBaIiBmaWxsPSIjRkZGRkZGIiBwLWlkPSIzNzY1Ij48L3BhdGg+PC9zdmc+" alt="img">答对了，您选择的答案是A</p>
<p><strong>正确答案:</strong>A</p>
<p><strong>解析:</strong></p>
<p>HTTP 是 client （如 Browser) 与 server 通信的协议。是非常典型的 RPC。</p>
</blockquote>
<blockquote>
<ul>
<li>RPC跟REST API有什么不一样<ul>
<li>rest api一般指的是定义好的http 接口，rpc是一种通信协议</li>
</ul>
</li>
<li>Thrift, ProtoBuf和HTTP协议差别在哪里呢？<ul>
<li>差别可多了，比如最主要的差别是 thrift 和protobuf 的通信量相对 http 都很小，速度也就快很多。其他的差别，建议您可以去 Google 一下 thrift 和 protobuf，或者写一下 thrift 的调用代码和http 的调用代码来体会。</li>
</ul>
</li>
<li>RPC跟RESTful API 有什么不同？<ul>
<li>RPC 是一类协议的统称，Restful API 是一种编码规范。<br>Restful API 也是一种 RPC。我们说过 RPC 的时候通常说的意思是“远程调用”，我们说 Restful API 的时候通常指的是 “GET <a href="https://xxx/api/users/&quot;" target="_blank" rel="noopener">https://xxx/api/users/&quot;</a> 之类的 Web API 设计。Web API 当然也是一种“远程调用”</li>
</ul>
</li>
<li>请问 用Flask写的API和用grpc写的API有什么区别？两者对比有什么好处呢<ul>
<li><strong>Flask 之类的 Web Framework 写的 API就是一个 HTTP API。相比于 GRPC 或者 Thrift 之类写的 API 而言，最主要的区别是 HTTP 的 Request 整个数据传输一般比较大，因为要包含 HTTP Header, Cookie 之类的很多东西，其实很多时候用不上。所以 GRPC 之类的会高效不少</strong>。</li>
</ul>
</li>
<li>client make a request to server 是都要用HTTP协议？<ul>
<li>不一定的，也有用其他协议的。只是大部分都用 http，简单方便成熟。</li>
</ul>
</li>
<li>server to server之间的通信的内容什么？不同伺服器上的数据？<ul>
<li>server to server 当然也是有通信的需求的。<strong>比如在Uber设计中，GeoService 里的 server 就存储了地理位置信息，并提供了访问地理位置信息的接口。这个 GeoService 可以服务于 Uber 打车，还可以服务于 Uber 外卖。不同的其他的 server 都可以调用 GeoService 来存取数据，这就是服务器间通信。</strong></li>
</ul>
</li>
<li>RESTful API 是基于http protocol的？<ul>
<li>是的。</li>
</ul>
</li>
</ul>
</blockquote>
<h3 id="Google-S2-amp-Riak"><a href="#Google-S2-amp-Riak" class="headerlink" title="Google S2 &amp; Riak"></a>Google S2 &amp; Riak</h3><h2 id="Scenario"><a href="#Scenario" class="headerlink" title="Scenario"></a>Scenario</h2><blockquote>
<h5 id="多选题-对于一个打车软件来说，最核心的两个功能是什么？"><a href="#多选题-对于一个打车软件来说，最核心的两个功能是什么？" class="headerlink" title="[多选题]对于一个打车软件来说，最核心的两个功能是什么？"></a>[多选题]对于一个打车软件来说，最核心的两个功能是什么？</h5><p>A.支付功能10.34% 选择</p>
<p>B.汇报位置34.47% 选择</p>
<p>C.匹配乘客和车辆45.34% 选择</p>
<p>D.评分系统0.31% 选择</p>
<p>E.一键报警0.31% 选择</p>
<p>F.路线导航9.22% 选择</p>
<p><img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBzdGFuZGFsb25lPSJubyI/PjwhRE9DVFlQRSBzdmcgUFVCTElDICItLy9XM0MvL0RURCBTVkcgMS4xLy9FTiIgImh0dHA6Ly93d3cudzMub3JnL0dyYXBoaWNzL1NWRy8xLjEvRFREL3N2ZzExLmR0ZCI+PHN2ZyB0PSIxNTM0MTgxMjgxODM5IiBjbGFzcz0iaWNvbiIgc3R5bGU9IiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgdmVyc2lvbj0iMS4xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHAtaWQ9IjM3NjIiIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB3aWR0aD0iMzIiIGhlaWdodD0iMzIiPjxkZWZzPjxzdHlsZSB0eXBlPSJ0ZXh0L2NzcyI+PC9zdHlsZT48L2RlZnM+PHBhdGggZD0iTTUxOC4xMiA1MTYuMTZtLTQ5MCAwYTQ5MCA0OTAgMCAxIDAgOTgwIDAgNDkwIDQ5MCAwIDEgMC05ODAgMFoiIGZpbGw9IiM1NkI0MzIiIHAtaWQ9IjM3NjMiPjwvcGF0aD48cGF0aCBkPSJNMzkzLjIxMzYxOSA2NjQuMzM1NDk1bTI4LjI4NDI3MS0yOC4yODQyNzFsMjk2Ljk4NDg0OS0yOTYuOTg0ODQ4cTI4LjI4NDI3MS0yOC4yODQyNzEgNTYuNTY4NTQyIDBsMCAwcTI4LjI4NDI3MSAyOC4yODQyNzEgMCA1Ni41Njg1NDJsLTI5Ni45ODQ4NDggMjk2Ljk4NDg0OHEtMjguMjg0MjcxIDI4LjI4NDI3MS01Ni41Njg1NDMgMGwwIDBxLTI4LjI4NDI3MS0yOC4yODQyNzEgMC01Ni41Njg1NDJaIiBmaWxsPSIjRkZGRkZGIiBwLWlkPSIzNzY0Ij48L3BhdGg+PHBhdGggZD0iTTI4OS40Njk4NCA0NTIuODQ3ODgzbTI4LjI4NDI3MSAyOC4yODQyNzFsMTU1LjU2MzQ5MiAxNTUuNTYzNDkycTI4LjI4NDI3MSAyOC4yODQyNzEgMCA1Ni41Njg1NDNsMCAwcS0yOC4yODQyNzEgMjguMjg0MjcxLTU2LjU2ODU0MyAwbC0xNTUuNTYzNDkxLTE1NS41NjM0OTJxLTI4LjI4NDI3MS0yOC4yODQyNzEgMC01Ni41Njg1NDNsMCAwcTI4LjI4NDI3MS0yOC4yODQyNzEgNTYuNTY4NTQyIDBaIiBmaWxsPSIjRkZGRkZGIiBwLWlkPSIzNzY1Ij48L3BhdGg+PC9zdmc+" alt="img">答对了，您选择的答案是BC</p>
<p><strong>正确答案:</strong>BC</p>
<p><strong>解析:</strong></p>
<p>支付并不是最重要的，完全可以做一个免费的打车软件，但让司机汇报自己的位置和为乘客匹配一个合适的司机是构成一个打车软件的基本功能。</p>
</blockquote>
<ul>
<li>該可以時不時更新司機位置</li>
<li>為乘客匹配司機</li>
<li>司機同意就繼續完成派單</li>
<li>直接司機告訴服務器自己在哪</li>
</ul>
<p>會發現他一天會有幾單，會橫跨幾個城市，全市</p>
<ul>
<li>有集會時會有大量單，所以透過偷偷蒐集用戶地點，我們可以提前調度司機往那邊跑。</li>
<li>但這理論上是蒐集隱私的行為哈</li>
</ul>
<h2 id="Service-Geo-amp-Dispatch"><a href="#Service-Geo-amp-Dispatch" class="headerlink" title="Service - Geo &amp; Dispatch"></a>Service - Geo &amp; Dispatch</h2><blockquote>
<h5 id="单选题-图中漏了什么？"><a href="#单选题-图中漏了什么？" class="headerlink" title="[单选题]图中漏了什么？"></a>[单选题]图中漏了什么？</h5><p><img src="https://tva1.sinaimg.cn/large/00831rSTgy1gdkglvyl64j30ky0c8ju9.jpg" alt="图片"></p>
<p>A.司机和乘客的双向联系23.16% 选择</p>
<p>B.司机获取到打车订单信息45.00% 选择</p>
<p>C.司机当前接单与否的状态31.84% 选择</p>
<p><img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBzdGFuZGFsb25lPSJubyI/PjwhRE9DVFlQRSBzdmcgUFVCTElDICItLy9XM0MvL0RURCBTVkcgMS4xLy9FTiIgImh0dHA6Ly93d3cudzMub3JnL0dyYXBoaWNzL1NWRy8xLjEvRFREL3N2ZzExLmR0ZCI+PHN2ZyB0PSIxNTQxNzAwNjYyNTQzIiBjbGFzcz0iaWNvbiIgc3R5bGU9IiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgdmVyc2lvbj0iMS4xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHAtaWQ9IjEwODgiIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB3aWR0aD0iNjQiIGhlaWdodD0iNjQiPjxkZWZzPjxzdHlsZSB0eXBlPSJ0ZXh0L2NzcyI+PC9zdHlsZT48L2RlZnM+PHBhdGggZD0iTTUxMiAwYTUxMiA1MTIgMCAxIDAgMCAxMDI0QTUxMiA1MTIgMCAwIDAgNTEyIDB6IG0xNjUuOTUyIDYzNy43NmwxNS4wNCAxNC45NzZhMjguNDE2IDI4LjQxNiAwIDEgMS00MC4yNTYgNDAuMjU2bC0xNC45NzYtMTUuMDRMNTA5LjUwNCA1NDkuNzYgMzcxLjIgNjg4YTI4LjQxNiAyOC40MTYgMCAxIDEtNDAuMjU2LTQwLjI1NmwxMzguMzA0LTEzOC4yNC0xMjMuMi0xMjMuMi0xNS4xMDQtMTUuMTA0YTI4LjU0NCAyOC41NDQgMCAwIDEgMC00MC4yNTYgMjguNTQ0IDI4LjU0NCAwIDAgMSA0MC4yNTYgMGwxNS4wNCAxNS4xMDRMNTA5LjQ0IDQ2OS4yNDhsMTQzLjIzMi0xNDMuMjk2YTI4LjQxNiAyOC40MTYgMCAxIDEgNDAuMjU2IDQwLjI1Nkw1NDkuNzYgNTA5LjUwNGwxMjguMTkyIDEyOC4yNTZ6IiBmaWxsPSIjRjY1RTVFIiBwLWlkPSIxMDg5Ij48L3BhdGg+PC9zdmc+" alt="img">答错了，您选择的答案是C</p>
<p><strong>正确答案:</strong>B</p>
</blockquote>
<blockquote>
<ul>
<li>Dispatch service 里面包含逻辑处理 + 数据存储。能否解释一下数据储存？这里的数据储存存的是什么数据？是否是司机的地理位置数据？<ul>
<li>地理位置数据可以存在 GeoService 里。Dispatch Service 里存的是派单（Dispatch）信息的数据，比如我把哪个司机分配给了哪个乘客，这个在我们的课程中是存在 Trip Table 里。即用户点击打车就创建了一个 Trip，当分配了一个司机以后，就往里填进去被分配的司机。</li>
</ul>
</li>
</ul>
</blockquote>
<h2 id="Storage-Trip-amp-Location"><a href="#Storage-Trip-amp-Location" class="headerlink" title="Storage - Trip &amp; Location"></a>Storage - Trip &amp; Location</h2><blockquote>
<h5 id="单选题-Trip-Table-的读写情况如何？"><a href="#单选题-Trip-Table-的读写情况如何？" class="headerlink" title="[单选题]Trip Table 的读写情况如何？"></a>[单选题]Trip Table 的读写情况如何？</h5><p>A.读多写少25.16% 选择</p>
<p>B.读少写多36.25% 选择</p>
<p>C.读写一样多38.58% 选择</p>
<p><img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBzdGFuZGFsb25lPSJubyI/PjwhRE9DVFlQRSBzdmcgUFVCTElDICItLy9XM0MvL0RURCBTVkcgMS4xLy9FTiIgImh0dHA6Ly93d3cudzMub3JnL0dyYXBoaWNzL1NWRy8xLjEvRFREL3N2ZzExLmR0ZCI+PHN2ZyB0PSIxNTQxNzAwNjYyNTQzIiBjbGFzcz0iaWNvbiIgc3R5bGU9IiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgdmVyc2lvbj0iMS4xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHAtaWQ9IjEwODgiIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB3aWR0aD0iNjQiIGhlaWdodD0iNjQiPjxkZWZzPjxzdHlsZSB0eXBlPSJ0ZXh0L2NzcyI+PC9zdHlsZT48L2RlZnM+PHBhdGggZD0iTTUxMiAwYTUxMiA1MTIgMCAxIDAgMCAxMDI0QTUxMiA1MTIgMCAwIDAgNTEyIDB6IG0xNjUuOTUyIDYzNy43NmwxNS4wNCAxNC45NzZhMjguNDE2IDI4LjQxNiAwIDEgMS00MC4yNTYgNDAuMjU2bC0xNC45NzYtMTUuMDRMNTA5LjUwNCA1NDkuNzYgMzcxLjIgNjg4YTI4LjQxNiAyOC40MTYgMCAxIDEtNDAuMjU2LTQwLjI1NmwxMzguMzA0LTEzOC4yNC0xMjMuMi0xMjMuMi0xNS4xMDQtMTUuMTA0YTI4LjU0NCAyOC41NDQgMCAwIDEgMC00MC4yNTYgMjguNTQ0IDI4LjU0NCAwIDAgMSA0MC4yNTYgMGwxNS4wNCAxNS4xMDRMNTA5LjQ0IDQ2OS4yNDhsMTQzLjIzMi0xNDMuMjk2YTI4LjQxNiAyOC40MTYgMCAxIDEgNDAuMjU2IDQwLjI1Nkw1NDkuNzYgNTA5LjUwNGwxMjguMTkyIDEyOC4yNTZ6IiBmaWxsPSIjRjY1RTVFIiBwLWlkPSIxMDg5Ij48L3BhdGg+PC9zdmc+" alt="img">答错了，您选择的答案是C</p>
<p><strong>正确答案:</strong>A</p>
<p><strong>解析:</strong></p>
<p>只有产生用户请求时才会产生写操作，查询操作比较多，因为每隔四秒司机都会需要查询是否有与之匹配的订单</p>
</blockquote>
<blockquote>
<h5 id="单选题-Location-Table-的读写情况如何？"><a href="#单选题-Location-Table-的读写情况如何？" class="headerlink" title="[单选题]Location Table 的读写情况如何？"></a>[单选题]Location Table 的读写情况如何？</h5><p>A.读多写少8.05% 选择</p>
<p>B.读少写多71.88% 选择</p>
<p>C.读写一样多20.08% 选择</p>
<p><img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBzdGFuZGFsb25lPSJubyI/PjwhRE9DVFlQRSBzdmcgUFVCTElDICItLy9XM0MvL0RURCBTVkcgMS4xLy9FTiIgImh0dHA6Ly93d3cudzMub3JnL0dyYXBoaWNzL1NWRy8xLjEvRFREL3N2ZzExLmR0ZCI+PHN2ZyB0PSIxNTM0MTgxMjgxODM5IiBjbGFzcz0iaWNvbiIgc3R5bGU9IiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgdmVyc2lvbj0iMS4xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHAtaWQ9IjM3NjIiIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB3aWR0aD0iMzIiIGhlaWdodD0iMzIiPjxkZWZzPjxzdHlsZSB0eXBlPSJ0ZXh0L2NzcyI+PC9zdHlsZT48L2RlZnM+PHBhdGggZD0iTTUxOC4xMiA1MTYuMTZtLTQ5MCAwYTQ5MCA0OTAgMCAxIDAgOTgwIDAgNDkwIDQ5MCAwIDEgMC05ODAgMFoiIGZpbGw9IiM1NkI0MzIiIHAtaWQ9IjM3NjMiPjwvcGF0aD48cGF0aCBkPSJNMzkzLjIxMzYxOSA2NjQuMzM1NDk1bTI4LjI4NDI3MS0yOC4yODQyNzFsMjk2Ljk4NDg0OS0yOTYuOTg0ODQ4cTI4LjI4NDI3MS0yOC4yODQyNzEgNTYuNTY4NTQyIDBsMCAwcTI4LjI4NDI3MSAyOC4yODQyNzEgMCA1Ni41Njg1NDJsLTI5Ni45ODQ4NDggMjk2Ljk4NDg0OHEtMjguMjg0MjcxIDI4LjI4NDI3MS01Ni41Njg1NDMgMGwwIDBxLTI4LjI4NDI3MS0yOC4yODQyNzEgMC01Ni41Njg1NDJaIiBmaWxsPSIjRkZGRkZGIiBwLWlkPSIzNzY0Ij48L3BhdGg+PHBhdGggZD0iTTI4OS40Njk4NCA0NTIuODQ3ODgzbTI4LjI4NDI3MSAyOC4yODQyNzFsMTU1LjU2MzQ5MiAxNTUuNTYzNDkycTI4LjI4NDI3MSAyOC4yODQyNzEgMCA1Ni41Njg1NDNsMCAwcS0yOC4yODQyNzEgMjguMjg0MjcxLTU2LjU2ODU0MyAwbC0xNTUuNTYzNDkxLTE1NS41NjM0OTJxLTI4LjI4NDI3MS0yOC4yODQyNzEgMC01Ni41Njg1NDNsMCAwcTI4LjI4NDI3MS0yOC4yODQyNzEgNTYuNTY4NTQyIDBaIiBmaWxsPSIjRkZGRkZGIiBwLWlkPSIzNzY1Ij48L3BhdGg+PC9zdmc+" alt="img">答对了，您选择的答案是B</p>
<p><strong>正确答案:</strong>B</p>
<p><strong>解析:</strong></p>
<p>每隔四秒司机的位置都需要被更新，属于写操作；读取操作只有在查找乘客附近的司机时才会发生。</p>
</blockquote>
<blockquote>
<ul>
<li>对这个流程有些疑惑，为什么不等到driver同意pick up之后再往trip里写一个新的record，这样不是可以避免driver反复查询吗<ul>
<li>有很多原因。首先，对那么没有成单的打车请求，也有记录数据和分析数据的需求，不仅仅是记录那些匹配上的单子。其次，当一个打车请求产生一个，我们需要提供给打车的人一个查询主体去让他查询有没有匹配上，因此势必是要创建一个 Record 的。至于这个 Record 是一个 Trip 的 Record 还是一个 PendingRequest 的 Record，这个就看你自己愿意怎么设计了。我是觉得统一都是 Trip ，用 status 来标记不同时期的状态是比较好的做法。</li>
</ul>
</li>
<li>如果app上要显示location的话是要读的吧，所以是不是应该是读写一样多呢<ul>
<li>是的。<br>这是属于另外一个功能点的要实现的service-trip routing service。<br>其实这个系统中的Dispatch Service和Geo Web Server还可以分化出来一个专门复杂计算匹配功能的Matching Service 出来。</li>
</ul>
</li>
<li>请问driver要怎么从trip table查询他有没有被assigned到某个trip? 是对driver_id做 index，让我们可以直接search吗？<ul>
<li>是的，对 driver_id 有 index 就行了。</li>
</ul>
</li>
<li>数据库定义 外键会不会影响性能呢？<ul>
<li>定义外键就必须给该列建立索引，这样可以加快查询时的速度，但是相应地在数据更新的时候会花费一些时间来维护索引。</li>
</ul>
</li>
</ul>
</blockquote>
<h1 id="LBS-難點"><a href="#LBS-難點" class="headerlink" title="LBS 難點"></a>LBS 難點</h1><ul>
<li>數據庫不好查圓，改求正方形</li>
</ul>
<blockquote>
<p>课中练习</p>
<p>[单选题]分别对 latitude 和 longitude 建index是否可行？</p>
<p>你的选择:B</p>
<p>A:可行</p>
<p><strong>B:不可行</strong></p>
</blockquote>
<p>那建複合索引ok嗎？就是二元組排序</p>
<p>[单选题]复合索引是否能解决 查询效率低下的问题呢？</p>
<p>A:可以</p>
<p><strong>B:不可以</strong> 仍是不行</p>
<p>要找兩個key都在某個範圍內的range query仍是無法做的，只能找到同lat下的log的範圍。</p>
<p><strong><em>所以，將二維映射到一維做</em></strong></p>
<h2 id="2D-Range-Query"><a href="#2D-Range-Query" class="headerlink" title="2D Range Query"></a>2D Range Query</h2><p>映射到一維的range query，相當於對二維作range query</p>
<ul>
<li>Google S2 –  Hilbert Curve, 一維上近的，二維上的也近；反之否。</li>
<li>Geohash – Peano Curve<ul>
<li>0-9, a-z 去掉 a, i, l, o 為 base32剛好2^5, 因為長相容易看錯，發明算法的人決定去掉這四個char的</li>
<li>find longest-common-prefix</li>
</ul>
</li>
</ul>
<blockquote>
<ul>
<li>所以说Hilbert mapping如果两个点二维空间接近， 一维上不一定接近对吧（比如说最中间的四个点）<ul>
<li>是的。但是反过来是对的，一维越接近，二维就越接近。</li>
</ul>
</li>
<li>Google S2怎么解决障碍物的问题？比如河流，单行线等。<ul>
<li>Google S2不能解决障碍物的问题，障碍物的问题是交给地图解决的。在或取到附近的司机之后，可以过一遍地图，查一下路径，如果不可达或者要绕远路的话可以排除掉。</li>
</ul>
</li>
<li>为什么不直接按地域分，然后在这个地域里直接用for loop算出每个坐标和用户的距离？这个是O(n) 是不是因为 SQL查询是O(logn)所以更快？<ul>
<li>这样就要对每个用户都算一遍距离，n个用户就要对所有坐标算n次，开销很大。而用Geohash就只需要做一个range query就行了，range query一般有索引支持，做起来很快。</li>
</ul>
</li>
<li>对两个column都是range query的情况，如果用复合索引的话，虽然对第二个column是无序的，但是因为第一个的range已经选出来，这时如果delta比较小（range范围小），对于第二个column也只用遍历第一个选出来的部分，相较于加索引的log（n）会差别很大么？<ul>
<li>你的这个假设 delta 比较小是不合理的，我们大部分的需求都是 delta 比较大的。如果你说数据小的话，那什么办法都可以，不加索引也可以。数据小是无敌的。</li>
</ul>
</li>
<li>GoogleS2算法会将那些2D近，1D远的点漏掉对吧？所以它是不是精准度差？<ul>
<li>Google S2会比Geohash精准一点，因为Geohash存在一些很大的突变点，比如两个相隔很近的点刚好分到两个不同的格子的话就会使它们的前缀完全不一样。但是Google S2用的是一种突变没有那么严重的Pieano Curve，因此精准度会高一点。</li>
</ul>
</li>
</ul>
</blockquote>
<h2 id="GeoHash"><a href="#GeoHash" class="headerlink" title="GeoHash"></a>GeoHash</h2><p>把地球表面分成一個個大格子，並用各個char代表，多次畫分成32份下去，無限逼近所在的位置。</p>
<p>公共長綴愈長，兩點愈來愈接近</p>
<img src="https://tva1.sinaimg.cn/large/00831rSTgy1gdl1zh1cgbj30sg0f2ta2.jpg" alt="image-20200407114112281" style="zoom: 33%;" />

<blockquote>
<ul>
<li>geohash算法中，如果两个点在分界两边，但其实离得很近，算法会分成两个不同的字母数字么？造成的误差怎么处理呢？<ul>
<li>会很大。一般不处理。因为人会走动，走两步，这个误差就没有了。系统设计不需要保证 100% 正确性。后面的讲解中也会提到。</li>
</ul>
</li>
<li>如何处理处在分界线两边很靠近的两点的情况？比如美国的两点很接近，但分属9和d?<ul>
<li>这个是GeoHash的一个缺陷，即使两个点相隔很近，其字符串的前缀也有可能完全不一样。不过在实际应用中可以有一些方法来弥补，比如在数据库中找距离x点在一定范围内的所有点的时候，除了搜索跟ｘ在一个小格子内的点之外，还可以搜索出于ｘ所在的格子相零的八个格子内的点，然后再汇总结果，这样就不会漏掉答案了。</li>
</ul>
</li>
</ul>
</blockquote>
<ul>
<li>為何是4x8? 而不是5x10、3x6這類的1:2?<ul>
<li>因為GeoHash是一個二分法，實數可以無限往下二分除，得到很長的０１串</li>
<li>base32 去遞歸地劃地圖 <img src="https://tva1.sinaimg.cn/large/00831rSTgy1gdl29586ydj30c808wjt0.jpg" alt="image-20200407115146360" style="zoom: 33%;" /></li>
<li>靠得近有時候geohash還是差得大，但人剛好處於這個大分界上的機率很小，可能下一秒就不在這個分界線上了</li>
</ul>
</li>
</ul>
<blockquote>
<ul>
<li>Geohash为什么不直接比较二进制数，而是比较hash以后的string呢？<ul>
<li>为了最终得出来的表示是整数位，base必须选取2的次方，因此可以将geohash存成2进制、4进制、8进制….等等。这里之所以选32进制是因为这样比较compact，而且最终生成出来的字符串可以被放在url里面，比如<a href="http://api.com/get_nearby_taxi/9q9hu3hhsjxx" target="_blank" rel="noopener">http://api.com/get_nearby_taxi/9q9hu3hhsjxx</a></li>
</ul>
</li>
<li>Geohash为什么不直接比较二进制数，而是比较hash以后的string呢？<ul>
<li>因为 GeoHash 如果存成二进制的话，肉眼不可读，不利于放在 url 里传播，也不利于别人复制粘贴。有方便“人”使用的考虑，如果只是给计算机看，二进制当然是可以的。</li>
</ul>
</li>
<li>geo hash 为什么要比较string？ 不直接比较二进制数？<ul>
<li>GeoHash 用字符串有如下一些好处：<ol>
<li>可读性高，可以直接让人阅读和复制，类似登陆验证码你不能给人一个二进制让人输入吧</li>
<li>可以放在 url 里，方便 url 的传播。</li>
</ol>
</li>
</ul>
</li>
</ul>
</blockquote>
<h3 id="Range-Query-in-GeoHash-in-DB"><a href="#Range-Query-in-GeoHash-in-DB" class="headerlink" title="Range Query in GeoHash in DB"></a>Range Query in GeoHash in DB</h3><p>視需求要在多少距離內去map找 longest-common-prefix</p>
<p>e.g. 找附近20km的車</p>
<blockquote>
<ul>
<li><p>这里cassandra的row key是什么呢？</p>
<ul>
<li>在 GeoHash 的例子中，row_key 可以是前 4 位的 GeoHash，后面的内容里有提到如何 sharding 的问题。</li>
</ul>
</li>
<li><p>这种找共同prefix的问题是不是通过Trie来实现更高效啊。Redis那种方法其实就是通过hashtable的方式实现trie. 那SQL和Cassandra为什么不通过trie来实现呢，节省空间吗？</p>
<ul>
<li><p>Trie 和 Hash 的效率是一样的，查找一次时间复杂度都是 O(L)，L 是字符串长度（你需要去九章算法强化班补习一下这部分的内容哦）Trie 唯一优势是空间稍微省一些。像 SQL 和 Cassandra 这种数据库的结构是不支持 Trie 的。Trie 是算法和数据结构领域的东西，而不是数据库领域的东西。没有任何数据结构原生的支持 Trie，但是所有 key-value db 都可以认为是一个 hash table on disk。</p>
<p>TODO: <em>多比較此概念, <a href="https://leetcode.com/problems/longest-common-prefix/solution/" target="_blank" rel="noopener">https://leetcode.com/problems/longest-common-prefix/solution/</a></em></p>
</li>
</ul>
</li>
<li><p><strong><em>Redis的情况是要建立32^6+32^5+32^4个key吗？按讲义，9qhhvt,9q9hv,9q9h都是key</em></strong></p>
<ul>
<li>是的，理论上最多会有那么多个key，不过考虑到有很多无人区（海洋，荒山，沙漠啥的），而且公司业务一般不会完全覆盖整个地球，所以实际的数量其实不会达到那么多。如果真的一台机器放不下的话还可以sharding。</li>
</ul>
</li>
<li><p>cassandra的value没有null明白了，那么可不可以有“”(空字符串)呢?另外，cassandra是不是可以不设置columnkey从而只有rowkey和value呢？谢谢。</p>
<ul>
<li>不可以不设置 column key ，否则无法排序<code>&lt;row key, column key&gt;</code> 这个二元组。也无法对 column key 进行 range query。你的需求适合直接放在 RocksDb 这种只有 key-value 的结构里，不适合放在 row key column key value 的这种结构。</li>
</ul>
</li>
<li><p>相当于一个driver的位置要放到三个key的set里面？然后会根据driver位置的变化，会动态地增删这三个set？</p>
<ul>
<li>是的，如果位置分三级的话就是要动态增删三个色它</li>
</ul>
</li>
<li><p>cassandra 的 rowkey 和 column key 的差别是什么啊？ 可以简单说一下吗？</p>
<ul>
<li>Cassandra 中的 row key 就是 hash key 也叫做 partition key，是每次查询必须带上的（第二第三节课里有讲哦~），主要作用是当确定这个数据存在什么地方，你可以认为有一个函数叫做 <code>find_db_instance_by_row_key(row_key)</code> 能够根据 row_key 确定使用哪个 db instance，从而实现分布式存储。<br>很多 NoSQL 数据库没有 column key，比如 Redis。 Cassandra 有 Column key 的作用是，在一台数据库的机器上，所有数据是按照 row_key+column key 排好序的。所以当你确定了 row_key 是啥以后，就可以对 column key 进行范围查询，比如你可以查询 user_id（rowkey） 发的所有帖子里，在 昨天到今天这个范围内发的帖子（帖子的发表时间作为 column key），而 Redis 因为没有 column key 是做不到的。另外在后面的 Big Table 中，会详细介绍这类数据库的实现原理（BigTable 也是一个有 column key 的 db）</li>
</ul>
</li>
<li><p>cassandra把geohash放在column key，那row key该存什么，可以全都存在同一个row key下吗？例如null？</p>
<ul>
<li>Row key 存 geohash 的前 4 位。</li>
</ul>
</li>
<li><p>cassandra的row key是什么</p>
<ul>
<li>前 4 位 GeoHash</li>
</ul>
</li>
</ul>
</blockquote>
<h3 id="雙方角度思考業務跟儲存需求"><a href="#雙方角度思考業務跟儲存需求" class="headerlink" title="雙方角度思考業務跟儲存需求"></a>雙方角度思考業務跟儲存需求</h3><blockquote>
<ul>
<li>为什么不需要对driver按离rider距离远近排序？<ul>
<li>要排也行，可以在match的时候将最近的区域内的司机按距离排个序，然后选最近的。</li>
</ul>
</li>
</ul>
</blockquote>
<h3 id="Scale"><a href="#Scale" class="headerlink" title="Scale"></a>Scale</h3><p>用戶無遷移成本，所以用戶黏性太差，分分鐘用戶就換別的用。</p>
<blockquote>
<h5 id="单选题-司机的-Location-信息应该按照什么进行-Sharding？"><a href="#单选题-司机的-Location-信息应该按照什么进行-Sharding？" class="headerlink" title="[单选题]司机的 Location 信息应该按照什么进行 Sharding？"></a>[单选题]司机的 Location 信息应该按照什么进行 Sharding？</h5><p>A.按照 User Id6.23% 选择</p>
<p>B.整个 GeoHash10.18% 选择</p>
<p>C.GeoHash的前4位72.04% 选择</p>
<p>D.GeoHash的前6位11.56% 选择</p>
<p><img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBzdGFuZGFsb25lPSJubyI/PjwhRE9DVFlQRSBzdmcgUFVCTElDICItLy9XM0MvL0RURCBTVkcgMS4xLy9FTiIgImh0dHA6Ly93d3cudzMub3JnL0dyYXBoaWNzL1NWRy8xLjEvRFREL3N2ZzExLmR0ZCI+PHN2ZyB0PSIxNTM0MTgxMjgxODM5IiBjbGFzcz0iaWNvbiIgc3R5bGU9IiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgdmVyc2lvbj0iMS4xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHAtaWQ9IjM3NjIiIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB3aWR0aD0iMzIiIGhlaWdodD0iMzIiPjxkZWZzPjxzdHlsZSB0eXBlPSJ0ZXh0L2NzcyI+PC9zdHlsZT48L2RlZnM+PHBhdGggZD0iTTUxOC4xMiA1MTYuMTZtLTQ5MCAwYTQ5MCA0OTAgMCAxIDAgOTgwIDAgNDkwIDQ5MCAwIDEgMC05ODAgMFoiIGZpbGw9IiM1NkI0MzIiIHAtaWQ9IjM3NjMiPjwvcGF0aD48cGF0aCBkPSJNMzkzLjIxMzYxOSA2NjQuMzM1NDk1bTI4LjI4NDI3MS0yOC4yODQyNzFsMjk2Ljk4NDg0OS0yOTYuOTg0ODQ4cTI4LjI4NDI3MS0yOC4yODQyNzEgNTYuNTY4NTQyIDBsMCAwcTI4LjI4NDI3MSAyOC4yODQyNzEgMCA1Ni41Njg1NDJsLTI5Ni45ODQ4NDggMjk2Ljk4NDg0OHEtMjguMjg0MjcxIDI4LjI4NDI3MS01Ni41Njg1NDMgMGwwIDBxLTI4LjI4NDI3MS0yOC4yODQyNzEgMC01Ni41Njg1NDJaIiBmaWxsPSIjRkZGRkZGIiBwLWlkPSIzNzY0Ij48L3BhdGg+PHBhdGggZD0iTTI4OS40Njk4NCA0NTIuODQ3ODgzbTI4LjI4NDI3MSAyOC4yODQyNzFsMTU1LjU2MzQ5MiAxNTUuNTYzNDkycTI4LjI4NDI3MSAyOC4yODQyNzEgMCA1Ni41Njg1NDNsMCAwcS0yOC4yODQyNzEgMjguMjg0MjcxLTU2LjU2ODU0MyAwbC0xNTUuNTYzNDkxLTE1NS41NjM0OTJxLTI4LjI4NDI3MS0yOC4yODQyNzEgMC01Ni41Njg1NDNsMCAwcTI4LjI4NDI3MS0yOC4yODQyNzEgNTYuNTY4NTQyIDBaIiBmaWxsPSIjRkZGRkZGIiBwLWlkPSIzNzY1Ij48L3BhdGg+PC9zdmc+" alt="img">答对了，您选择的答案是C</p>
<p><strong>正确答案:</strong>C</p>
<p><strong>解析:</strong></p>
<p>按照 User Id 是显然不对的，因为乘客的 UserId 和他附近的司机的 UserId 可能会被 sharding 到不同的地方。<br>按照 GeoHash 进行 Sharding 的话，只需要按照前 4 位进行 sharding 即可。因为乘客的查询可能是按照前4，5，6位 GeoHash 进行查询，如果是按照前 6 位进行 sharding 的话，那么 BBBB22 和 BBBB33 就会被拆分开，而我们查询的时候其实希望如果用户在 BBBB22 的话，他能够查到位置在 BBBB33 的司机。</p>
</blockquote>
<p>城市不多，每個城市也是幾10個點圍出來的，可以在code裡直接寫死。</p>
<blockquote>
<ul>
<li>redis内部有自己的sharding机制么？需要自己手动写sharding算法还是只需要给sharding的column就可以？<ul>
<li>早期的版本没有。最近新出的版本里有 auto-sharding 的机制了，但是不是 consistent hashing 的算法，用的是另外一个，有兴趣的话，可以去网上搜一下相关的内容。</li>
</ul>
</li>
<li>但是有的城市uber的用户比较多，比较频发，有的城市用户比较少，怎么样能sharding的均匀呢？<ul>
<li>Uber 的做法是为用户多的城市多配置机器。用户少的城市少配置机器。</li>
</ul>
</li>
<li>按照city sharding，如果这个城市里有很多driver，该如何判断哪一个driver离这个乘客比较近？<ul>
<li>按照 city sharding 以后还是需要根据 geohash 去 filter 的。sharding 只是宏观上数据怎么拆分，geohash 是微观上具体每一条数据存储时的信息。我们根据 <strong>geohash</strong> 可以做范围查询来 filter 离乘客比较近的 driver。</li>
</ul>
</li>
<li>找到乘客周围的2-3 个城市怎么就能避免乘客算a city driver 算b city 但是其实两个人离得很近的问题？<ul>
<li>他俩隔得很近，那么说明 a city 和 b city 隔得很近。因此找到乘客周围 2-3 个城市的意思就是，既让乘客属于 a city ，也让他属于 b city，总共查2-3次。</li>
</ul>
</li>
</ul>
</blockquote>
<h3 id="Riak"><a href="#Riak" class="headerlink" title="Riak"></a>Riak</h3><p>Redis 有 Master slave的機制，M掛了S可以頂上去。</p>
<p>但其實可以用穩定性更強的DB, 更好處理掛掉後恢復的問題。</p>
<p>Uber也是從Redis換成了Riak。</p>
<blockquote>
<ul>
<li>master挂了的话，slave可以进行写操作吗<ul>
<li>不行，必须起一个新的master。</li>
</ul>
</li>
<li>之前课程不是说涉及transaction要用SQL吗？ 为何这边都是用NoSQL？<ul>
<li>这里并不需要用到 transaction，所以用 NoSQL 没有问题。且有一些 NoSQL 也支持 Transaction 了。</li>
</ul>
</li>
</ul>
</blockquote>
<h2 id="Q-amp-A"><a href="#Q-amp-A" class="headerlink" title="Q&amp;A"></a>Q&amp;A</h2><img src="https://tva1.sinaimg.cn/large/00831rSTgy1gdj8kcgjkzj30kc0m8gn8.jpg" alt="image-20200405215453781" style="zoom: 25%;" />



<img src="https://tva1.sinaimg.cn/large/00831rSTgy1gdj8kg0owrj30kc0ws779.jpg" alt="image-20200405215851312" style="zoom:67%;" />

<img src="/Users/joe/Library/Application Support/typora-user-images/image-20200407165538615.png" alt="image-20200407165538615" style="zoom:67%;" />

<img src="https://tva1.sinaimg.cn/large/00831rSTgy1gdlb1n83q9j30oc0j8tby.jpg" alt="image-20200407165557659" style="zoom:67%;" />

<img src="https://tva1.sinaimg.cn/large/00831rSTgy1gdlb2i72zyj30ow0msn15.jpg" alt="image-20200407165647857" style="zoom:67%;" />

<img src="https://tva1.sinaimg.cn/large/00831rSTgy1gdlb36wqt9j30pa0t00yp.jpg" alt="image-20200407165727152" style="zoom:67%;" />



<h1 id="Appendix"><a href="#Appendix" class="headerlink" title="Appendix"></a>Appendix</h1><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1giblli29hij31gm0u07q8.jpg" alt="image-20200902000656510" style="zoom:67%;" />

</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2019/04/01/System-Design/9p/2019-04-01-Web%20System%20API%20Design%20&amp;%20TinyURL/">System-Design/9p/2019-04-01-Web System API Design &amp; TinyURL</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2019-04-01</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/SystemDesign/">SystemDesign</a></span><div class="content"><h1 id="General"><a href="#General" class="headerlink" title="General"></a>General</h1><h2 id="Web-Framework"><a href="#Web-Framework" class="headerlink" title="Web Framework"></a>Web Framework</h2><ul>
<li><p>登錄, session, cookies</p>
</li>
<li><p>CSRF攻擊 - Cross-site Request Forgery 如果拿的link是建數據的post請求，現在也是server會給browser一個CSRF token，去防無效token。</p>
<ul>
<li>python - django，flask輕巧要裝一堆插件，把密碼md5哈希，現在是SHA256</li>
<li>java - spring</li>
<li>ruby - ruby on rail</li>
</ul>
</li>
<li><p>ORM </p>
</li>
<li><p>登入登出</p>
</li>
<li><p><strong>http server</strong> is between user and web framwork, 管理多進程。</p>
<ul>
<li>Uwsgi 多進程啟多個Django的進程，服務如100個用戶就自己刪了重啟之類</li>
<li>Apache</li>
<li>Unicorn</li>
<li>Gunicorn</li>
<li>Nginx 不同網站去不同站口避免打架</li>
</ul>
</li>
</ul>
<h1 id="APIs"><a href="#APIs" class="headerlink" title="APIs"></a>APIs</h1><blockquote>
<h5 id="单选题-www-net-cn-的根域名（不含后缀）是什么？"><a href="#单选题-www-net-cn-的根域名（不含后缀）是什么？" class="headerlink" title="[单选题]www.net.cn 的根域名（不含后缀）是什么？"></a>[单选题]<a href="http://www.net.cn" target="_blank" rel="noopener">www.net.cn</a> 的根域名（不含后缀）是什么？</h5><p>A.net72.88% 选择</p>
<p>B.www27.12% 选择</p>
<p><img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBzdGFuZGFsb25lPSJubyI/PjwhRE9DVFlQRSBzdmcgUFVCTElDICItLy9XM0MvL0RURCBTVkcgMS4xLy9FTiIgImh0dHA6Ly93d3cudzMub3JnL0dyYXBoaWNzL1NWRy8xLjEvRFREL3N2ZzExLmR0ZCI+PHN2ZyB0PSIxNTQxNzAwNjYyNTQzIiBjbGFzcz0iaWNvbiIgc3R5bGU9IiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgdmVyc2lvbj0iMS4xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHAtaWQ9IjEwODgiIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB3aWR0aD0iNjQiIGhlaWdodD0iNjQiPjxkZWZzPjxzdHlsZSB0eXBlPSJ0ZXh0L2NzcyI+PC9zdHlsZT48L2RlZnM+PHBhdGggZD0iTTUxMiAwYTUxMiA1MTIgMCAxIDAgMCAxMDI0QTUxMiA1MTIgMCAwIDAgNTEyIDB6IG0xNjUuOTUyIDYzNy43NmwxNS4wNCAxNC45NzZhMjguNDE2IDI4LjQxNiAwIDEgMS00MC4yNTYgNDAuMjU2bC0xNC45NzYtMTUuMDRMNTA5LjUwNCA1NDkuNzYgMzcxLjIgNjg4YTI4LjQxNiAyOC40MTYgMCAxIDEtNDAuMjU2LTQwLjI1NmwxMzguMzA0LTEzOC4yNC0xMjMuMi0xMjMuMi0xNS4xMDQtMTUuMTA0YTI4LjU0NCAyOC41NDQgMCAwIDEgMC00MC4yNTYgMjguNTQ0IDI4LjU0NCAwIDAgMSA0MC4yNTYgMGwxNS4wNCAxNS4xMDRMNTA5LjQ0IDQ2OS4yNDhsMTQzLjIzMi0xNDMuMjk2YTI4LjQxNiAyOC40MTYgMCAxIDEgNDAuMjU2IDQwLjI1Nkw1NDkuNzYgNTA5LjUwNGwxMjguMTkyIDEyOC4yNTZ6IiBmaWxsPSIjRjY1RTVFIiBwLWlkPSIxMDg5Ij48L3BhdGg+PC9zdmc+" alt="img">答错了，您选择的答案是A</p>
<p><strong>正确答案:</strong>B</p>
<p><strong>解析:</strong></p>
<p><a href="http://www.net.cn" target="_blank" rel="noopener">www.net.cn</a> 是一个 .net.cn 为后缀的域名，而不是一个 .cn 为后缀的域名。意不意外，惊不惊喜！</p>
</blockquote>
<h2 id="Basics-amp-Flows"><a href="#Basics-amp-Flows" class="headerlink" title="Basics &amp; Flows"></a>Basics &amp; Flows</h2><p>網站開發：</p>
<p>跑通流程</p>
<p>申域名、綁ip地址、在AWS買server、在上面跑http server (Apache; Unicorn, Gunicorn; Uwsgi 都ok) 、用任一個框架 flask, django 搭起網站，搭個todo list就OK、message queue搭起來。</p>
<blockquote>
<ul>
<li><p>可以认为web server 是由http server和web application组成吗？感觉当我们访问了google.com的时候，是这样的流程：浏览器URL-&gt;DNS服务器(http request)-&gt;Http Server(可以认为是SpringMVC里的DispatcherServlet吗) -&gt; Web App(可以认为是SpringMVC里的Controller吗？就是找到对应哪个action进行处理这个请求)。不好意思对于这些概念和spring mvc都不是很理解，希望助教能指正</p>
<ul>
<li>HTTP Server 不是 Spring 里的任何东西。Web App 才是 Spring。HTTP Server 一般是在 Web APP 的前面会配置起来用作控制 Web App 多进程并发的一个软件，一般典型代表是 UWSGI, Unicorn 这种。你所知道的 Spring 的任何概念，都属于一个 Web App 里的一部分。</li>
</ul>
</li>
<li><p>我除了GET以外的操作（例如PUT和DELETE的操作）都使用POST Method是不是就可以了呢（操作类别通过url或parameter区分）？</p>
<ul>
<li>一般的Rest API设计规范是要求POST, DELETE, GET, PUT，分别对应增删查改，符合规范会让别人更容易理解你的接口。你说的方法虽然也可以，但是不符合Rest的规范。</li>
</ul>
</li>
<li><p>web application在哪里运行的呢？听说用docker来deploy web application，这个是执行application的地方吗？</p>
<ul>
<li>web application 可以在 docker 里执行。 docker 的概念可以理解为在 Operating System 上包装出来的一个独立的小 operating system。其实 web application 就是跑在操作系统上的，可以是 linux，可以是 windows。因为 web application 就是一个程序，一个进程。代码该在什么地方执行就在什么地方执行。</li>
</ul>
</li>
<li><p>请问，Async Server和Web Server在功能上的区别是什么？ 是否Web server一般用来接收用户的request和跑web application，而Async Server就是用来存储message queue的呢？</p>
<ul>
<li><p>在News Feed Push model的senario中，fanout本质上是一个写扩散的过程。<br>（1）Web Server主要是接受用户请求并dispatch到不同的wap app经controller直至具体某个处理特定businesslogic的service上。<br>（2）Async server的作用就是从这个人（明星）中frenship service中找到其相应的followers(粉丝)然后，对每一个follower用户对应的news_feed_table[id, owner_id, tweet_id, create]写入相关的记录，这样用户登录使用时就能看到news feeds。<br>如果存储的表(tweet_table, news_feed_table)都在都在同一个数据，那么这个写扩散的过程，其实就是在同一个数据库中创建相应的触发器(trigger)、存储过程(procedure)和定时执行作业，就能实现。<br>但是如果在不同的地理分布位置，而且follower数据量庞大，那么就要借助中间件(message queue)来完成, 利用中间件message queue是采用生产者与消费者的模式实现的publish/subscribe的技术，保证把每一个发布的（tweet）信息，准确返送到每一个subsrriptio端的consumer来完成消息的写扩散（fan out）过程。具体的messge queue的理解请阅读维基百科相关内容<a href="https://bit.ly/2kwnxNl" target="_blank" rel="noopener">https://bit.ly/2kwnxNl</a>, message queue具体实现场景，请阅《蚂蚁金服：消息队列事务型消息原理浅析》<a href="https://bit.ly/2lAJOKe" target="_blank" rel="noopener">https://bit.ly/2lAJOKe</a></p>
<p>显示我</p>
</li>
</ul>
</li>
</ul>
</blockquote>
<h2 id="API-Design"><a href="#API-Design" class="headerlink" title="API Design"></a>API Design</h2><blockquote>
<h5 id="单选题-以下API设计哪个是对的？"><a href="#单选题-以下API设计哪个是对的？" class="headerlink" title="[单选题]以下API设计哪个是对的？"></a>[单选题]以下API设计哪个是对的？</h5><p>API用于获取当前登录用户在题号1000这个题上的所有提交记录</p>
<p>A./api/users/<current_user_id>/submissions/?problem_id=100017.61% 选择</p>
<p>B./api/users/me/submissions/?problem_id=10006.82% 选择</p>
<p>C./api/submissions/?problem_id=1000&amp;user_id=<current_user_id>33.28% 选择</p>
<p>D./api/submissions/?problem_id=100032.01% 选择</p>
<p>E./api/problems/1000/submissions/10.28% 选择</p>
<p><img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBzdGFuZGFsb25lPSJubyI/PjwhRE9DVFlQRSBzdmcgUFVCTElDICItLy9XM0MvL0RURCBTVkcgMS4xLy9FTiIgImh0dHA6Ly93d3cudzMub3JnL0dyYXBoaWNzL1NWRy8xLjEvRFREL3N2ZzExLmR0ZCI+PHN2ZyB0PSIxNTM0MTgxMjgxODM5IiBjbGFzcz0iaWNvbiIgc3R5bGU9IiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgdmVyc2lvbj0iMS4xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHAtaWQ9IjM3NjIiIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB3aWR0aD0iMzIiIGhlaWdodD0iMzIiPjxkZWZzPjxzdHlsZSB0eXBlPSJ0ZXh0L2NzcyI+PC9zdHlsZT48L2RlZnM+PHBhdGggZD0iTTUxOC4xMiA1MTYuMTZtLTQ5MCAwYTQ5MCA0OTAgMCAxIDAgOTgwIDAgNDkwIDQ5MCAwIDEgMC05ODAgMFoiIGZpbGw9IiM1NkI0MzIiIHAtaWQ9IjM3NjMiPjwvcGF0aD48cGF0aCBkPSJNMzkzLjIxMzYxOSA2NjQuMzM1NDk1bTI4LjI4NDI3MS0yOC4yODQyNzFsMjk2Ljk4NDg0OS0yOTYuOTg0ODQ4cTI4LjI4NDI3MS0yOC4yODQyNzEgNTYuNTY4NTQyIDBsMCAwcTI4LjI4NDI3MSAyOC4yODQyNzEgMCA1Ni41Njg1NDJsLTI5Ni45ODQ4NDggMjk2Ljk4NDg0OHEtMjguMjg0MjcxIDI4LjI4NDI3MS01Ni41Njg1NDMgMGwwIDBxLTI4LjI4NDI3MS0yOC4yODQyNzEgMC01Ni41Njg1NDJaIiBmaWxsPSIjRkZGRkZGIiBwLWlkPSIzNzY0Ij48L3BhdGg+PHBhdGggZD0iTTI4OS40Njk4NCA0NTIuODQ3ODgzbTI4LjI4NDI3MSAyOC4yODQyNzFsMTU1LjU2MzQ5MiAxNTUuNTYzNDkycTI4LjI4NDI3MSAyOC4yODQyNzEgMCA1Ni41Njg1NDNsMCAwcS0yOC4yODQyNzEgMjguMjg0MjcxLTU2LjU2ODU0MyAwbC0xNTUuNTYzNDkxLTE1NS41NjM0OTJxLTI4LjI4NDI3MS0yOC4yODQyNzEgMC01Ni41Njg1NDNsMCAwcTI4LjI4NDI3MS0yOC4yODQyNzEgNTYuNTY4NTQyIDBaIiBmaWxsPSIjRkZGRkZGIiBwLWlkPSIzNzY1Ij48L3BhdGg+PC9zdmc+" alt="img">答对了，您选择的答案是D</p>
<p><strong>正确答案:</strong>D</p>
</blockquote>
<p>A、B、C不科學，別人可以查自己哦？</p>
<p>E不對, D才符合REST API的約束、規範，一級目錄要是自己要獲取的東西</p>
<p><img src="https://tva1.sinaimg.cn/large/00831rSTgy1gdh1w428fgj30p419sq94.jpg" alt="image-20200404003659176"></p>
<h2 id="REST-API"><a href="#REST-API" class="headerlink" title="REST API"></a>REST API</h2><blockquote>
<ul>
<li>post request 推荐 return 什么信息最好<ul>
<li>it depends。创建一个 instance 一般就 return 这个 instance 的json。</li>
</ul>
</li>
<li>get all accounts 呢？<ul>
<li>get /api/accounts/?filter=xxx&amp;sort_by=xxx</li>
</ul>
</li>
<li>请问加header 和 加parameter 的区别是什么<ul>
<li>一般验证信息，身份信息会放在 header 里。其他的普通参数放在 parameter 里。</li>
</ul>
</li>
<li>是否header里面的参数是加密的 而url parameter没有加密？<ul>
<li>是可以的，比如在Post/Put/Del的Rest Method中就是在message header中存放加密的Authentication信息（即token内容），在url的参数则是具体操作对象的id值等path variable。</li>
</ul>
</li>
</ul>
</blockquote>
<h2 id="News-Feed-API"><a href="#News-Feed-API" class="headerlink" title="News Feed API"></a>News Feed API</h2><h3 id="Req-amp-Res"><a href="#Req-amp-Res" class="headerlink" title="Req &amp; Res"></a>Req &amp; Res</h3><blockquote>
<ul>
<li>JSON 和XML 是两种格式。HTTP URL 里的路径不对应文件夹。URL和文件 path 是不同的概念。文件path的是对应有 folder 才行，url 可以随意指定，不一定要有真实的 folder 或者文件与之对应。同一份数据是不需要存两份的，一般都是存在数据库的表单里，如果你需要 JSON 的格式，就组织成 JSON 的格式返回，如果需要 XML 就组织成 XML 的格式返回。</li>
</ul>
</blockquote>
<h3 id="Pagination"><a href="#Pagination" class="headerlink" title="Pagination"></a>Pagination</h3><blockquote>
<ul>
<li><h5 id="单选题-哪种分页方法更加适合-News-Feed？"><a href="#单选题-哪种分页方法更加适合-News-Feed？" class="headerlink" title="[单选题]哪种分页方法更加适合 News Feed？"></a>[单选题]哪种分页方法更加适合 News Feed？</h5><p>A.页码翻页（Page Number）14.95% 选择</p>
<p>B.光标翻页（Cursor）85.05% 选择</p>
<p><img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBzdGFuZGFsb25lPSJubyI/PjwhRE9DVFlQRSBzdmcgUFVCTElDICItLy9XM0MvL0RURCBTVkcgMS4xLy9FTiIgImh0dHA6Ly93d3cudzMub3JnL0dyYXBoaWNzL1NWRy8xLjEvRFREL3N2ZzExLmR0ZCI+PHN2ZyB0PSIxNTM0MTgxMjgxODM5IiBjbGFzcz0iaWNvbiIgc3R5bGU9IiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgdmVyc2lvbj0iMS4xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHAtaWQ9IjM3NjIiIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB3aWR0aD0iMzIiIGhlaWdodD0iMzIiPjxkZWZzPjxzdHlsZSB0eXBlPSJ0ZXh0L2NzcyI+PC9zdHlsZT48L2RlZnM+PHBhdGggZD0iTTUxOC4xMiA1MTYuMTZtLTQ5MCAwYTQ5MCA0OTAgMCAxIDAgOTgwIDAgNDkwIDQ5MCAwIDEgMC05ODAgMFoiIGZpbGw9IiM1NkI0MzIiIHAtaWQ9IjM3NjMiPjwvcGF0aD48cGF0aCBkPSJNMzkzLjIxMzYxOSA2NjQuMzM1NDk1bTI4LjI4NDI3MS0yOC4yODQyNzFsMjk2Ljk4NDg0OS0yOTYuOTg0ODQ4cTI4LjI4NDI3MS0yOC4yODQyNzEgNTYuNTY4NTQyIDBsMCAwcTI4LjI4NDI3MSAyOC4yODQyNzEgMCA1Ni41Njg1NDJsLTI5Ni45ODQ4NDggMjk2Ljk4NDg0OHEtMjguMjg0MjcxIDI4LjI4NDI3MS01Ni41Njg1NDMgMGwwIDBxLTI4LjI4NDI3MS0yOC4yODQyNzEgMC01Ni41Njg1NDJaIiBmaWxsPSIjRkZGRkZGIiBwLWlkPSIzNzY0Ij48L3BhdGg+PHBhdGggZD0iTTI4OS40Njk4NCA0NTIuODQ3ODgzbTI4LjI4NDI3MSAyOC4yODQyNzFsMTU1LjU2MzQ5MiAxNTUuNTYzNDkycTI4LjI4NDI3MSAyOC4yODQyNzEgMCA1Ni41Njg1NDNsMCAwcS0yOC4yODQyNzEgMjguMjg0MjcxLTU2LjU2ODU0MyAwbC0xNTUuNTYzNDkxLTE1NS41NjM0OTJxLTI4LjI4NDI3MS0yOC4yODQyNzEgMC01Ni41Njg1NDNsMCAwcTI4LjI4NDI3MS0yOC4yODQyNzEgNTYuNTY4NTQyIDBaIiBmaWxsPSIjRkZGRkZGIiBwLWlkPSIzNzY1Ij48L3BhdGg+PC9zdmc+" alt="img">答对了，您选择的答案是B</p>
<p><strong>正确答案:</strong>B</p>
</li>
</ul>
</blockquote>
<p>要注意怎麼去避免空白頁的request</p>
<p>秀出100個的話就拿101個！</p>
<blockquote>
<ul>
<li><p>使用max_id的话，如果用户删除了之前的某一个item，这样不还是会出现第二页出现之前第一页的item吗</p>
<ul>
<li>不会有影响的。比如第一页的帖子是 <code>[10, 9, 8]</code> 第二页是 <code>[7, 6, 5]</code>，用户拿到第一页以后，同时得到的 next page max_id 是 7。即便此时用户删除了 10 这个帖子，依然不影响 通过 max_id = 7 拿到的是 7 6 5。如果用户删除了 7 这个帖子，那拿到的就是 <code>[6, 5, 4]</code> 也是没有问题的。</li>
</ul>
</li>
<li><p>能不能更具体地讲讲光标翻页的实现。举个例子，一共3页，客户端需要传什么数据给后台，首页，中间和末页。</p>
<ul>
<li><p>问：<strong>是不是不管push还是pull模型，如果翻页的话都得pull?</strong><br>翻页是用户主动操作的过程，所以肯定是由client 发给 server，肯定是一个pull的过程。</p>
<p>问：<strong>假设前100条中最早的timestamp是T，就分别请求follow的人在T之前的100条feed，然后再进行合并？</strong><br>答：对</p>
<p>问：<strong>如果恰好有几条feed的timestamp一样该如何处理？</strong><br>答：首先不会有帖子的timestamp一样，timestamp的精度很高的（微秒级别）</p>
<p>通常来说，翻页这个完全可以作为一道单独的系统设计面试题来问你。翻页并不是简单的1-100，101-200这样去翻页。因为当你在翻页的时候，你的news feed可能已经添加了新的 内容，这个时候你再去索引最新的101-200可能和你的1-100就有重叠了。</p>
<p>通常的做法是，拿第101个帖子的timestamp作为下一页的起始位置，也就是说，当用户在看到第一页的前100个帖子的时候，他还有第101个帖子的timestamp信息（隐藏在你看不到的地方），然后你请求下一页的时候，会带上这个timestamp的信息，server端会去数据库里请求 &gt;= timestamp 的前101个帖子，然后也同样把第101个帖子作为下一页的timestamp。这个方法比直接用第100个帖子的timestamp好的地方是，你如果读不到第101个帖子，说明没有下一页了，如果你刚才只有100个帖子的话，用第100个帖子的timestamp的坏处是，你会有一次<code>空翻</code>。</p>
<p>留给你一个思考题：怎么实现往上翻页（刷朋友圈，查看最新的帖子）</p>
<ul>
<li>可以利用和向下翻页类似的方法，用当前第一条feed的时间T去数据库取T之后的feeds。<br>如果是pull模型的话，就去所有follow的人的feed list去取然后merge<br>push的话，去直接去queue里面取时间大于T的就好了</li>
</ul>
</li>
</ul>
</li>
</ul>
</blockquote>
<blockquote>
<ul>
<li><h5 id="单选题-如果-Post-存储在-NoSQL-中，没有-Sequential-ID，还可以使用光标翻页法么？"><a href="#单选题-如果-Post-存储在-NoSQL-中，没有-Sequential-ID，还可以使用光标翻页法么？" class="headerlink" title="[单选题]如果 Post 存储在 NoSQL 中，没有 Sequential ID，还可以使用光标翻页法么？"></a>[单选题]如果 Post 存储在 NoSQL 中，没有 Sequential ID，还可以使用光标翻页法么？</h5><p>Sequential ID 是递增的，可以通过 max_id 和 min_id 来筛选。但是如果在 NoSQL 中，ID 是 UUID ，这个是完全无序的字符串，并不是后发的帖子 UUID 就会比先发的帖子 UUID 大。</p>
<p>A.用不了5.06% 选择</p>
<p>B.可以用，用 timestamp 之类的有序信息翻页即可94.94% 选择</p>
<p><img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBzdGFuZGFsb25lPSJubyI/PjwhRE9DVFlQRSBzdmcgUFVCTElDICItLy9XM0MvL0RURCBTVkcgMS4xLy9FTiIgImh0dHA6Ly93d3cudzMub3JnL0dyYXBoaWNzL1NWRy8xLjEvRFREL3N2ZzExLmR0ZCI+PHN2ZyB0PSIxNTM0MTgxMjgxODM5IiBjbGFzcz0iaWNvbiIgc3R5bGU9IiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgdmVyc2lvbj0iMS4xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHAtaWQ9IjM3NjIiIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB3aWR0aD0iMzIiIGhlaWdodD0iMzIiPjxkZWZzPjxzdHlsZSB0eXBlPSJ0ZXh0L2NzcyI+PC9zdHlsZT48L2RlZnM+PHBhdGggZD0iTTUxOC4xMiA1MTYuMTZtLTQ5MCAwYTQ5MCA0OTAgMCAxIDAgOTgwIDAgNDkwIDQ5MCAwIDEgMC05ODAgMFoiIGZpbGw9IiM1NkI0MzIiIHAtaWQ9IjM3NjMiPjwvcGF0aD48cGF0aCBkPSJNMzkzLjIxMzYxOSA2NjQuMzM1NDk1bTI4LjI4NDI3MS0yOC4yODQyNzFsMjk2Ljk4NDg0OS0yOTYuOTg0ODQ4cTI4LjI4NDI3MS0yOC4yODQyNzEgNTYuNTY4NTQyIDBsMCAwcTI4LjI4NDI3MSAyOC4yODQyNzEgMCA1Ni41Njg1NDJsLTI5Ni45ODQ4NDggMjk2Ljk4NDg0OHEtMjguMjg0MjcxIDI4LjI4NDI3MS01Ni41Njg1NDMgMGwwIDBxLTI4LjI4NDI3MS0yOC4yODQyNzEgMC01Ni41Njg1NDJaIiBmaWxsPSIjRkZGRkZGIiBwLWlkPSIzNzY0Ij48L3BhdGg+PHBhdGggZD0iTTI4OS40Njk4NCA0NTIuODQ3ODgzbTI4LjI4NDI3MSAyOC4yODQyNzFsMTU1LjU2MzQ5MiAxNTUuNTYzNDkycTI4LjI4NDI3MSAyOC4yODQyNzEgMCA1Ni41Njg1NDNsMCAwcS0yOC4yODQyNzEgMjguMjg0MjcxLTU2LjU2ODU0MyAwbC0xNTUuNTYzNDkxLTE1NS41NjM0OTJxLTI4LjI4NDI3MS0yOC4yODQyNzEgMC01Ni41Njg1NDNsMCAwcTI4LjI4NDI3MS0yOC4yODQyNzEgNTYuNTY4NTQyIDBaIiBmaWxsPSIjRkZGRkZGIiBwLWlkPSIzNzY1Ij48L3BhdGg+PC9zdmc+" alt="img">答对了，您选择的答案是B</p>
<p><strong>正确答案:</strong>B</p>
<p><strong>解析:</strong></p>
<p>timestamp 的精度是微妙级别的，是足够的，一个人的朋友圈里有两个人在同一个 timestamp 发了帖子的概率几乎为0。如果你还是担心 timestamp 的精度不够的话，一个简单的办法是 + 一个随机后缀，如 timestamp 取出来到微妙是 <code>1554553786168125</code> 的话，后面填 5 位随机整数如<code>13234</code>，凑成 <code>155455378616812513234</code>。当然存储的时候类型上得是 bigint 了，因为很大。不可以用 float / double 存储，精度不够。</p>
</li>
</ul>
</blockquote>
<h3 id="Mentions"><a href="#Mentions" class="headerlink" title="Mentions"></a>Mentions</h3><p>讓前端拿到時候可以顯示成可以llink的樣式</p>
<blockquote>
<ul>
<li><p>不是说返回的是Json么？这里为什么是HTML？</p>
<ul>
<li><p>总体的数据是 JSON 的，这里的 html 是其中的某个数据的值。比如：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">   <span class="attr">"title"</span>: <span class="string">"hello"</span>,</span><br><span class="line">	 <span class="attr">"content"</span>: <span class="string">"&lt;html&gt;hello world&lt;/html&gt;"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>mobile的格式是什么样子的？</p>
<ul>
<li><p>API 返回给 mobile 的格式通常就是 JSON 格式，直接只有具体的数据内容。如</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">   <span class="attr">"content"</span>: <span class="string">"Thanks to &lt;user username='someone'&gt;hello world&lt;/user&gt;"</span>,</span><br><span class="line">	 ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
</blockquote>
<h1 id="TinyURL"><a href="#TinyURL" class="headerlink" title="TinyURL"></a>TinyURL</h1><p>eg. bitly.com/, goo.gl/</p>
<h2 id="Scenario"><a href="#Scenario" class="headerlink" title="Scenario"></a>Scenario</h2><p>就是創一個post請求，建一個短網址</p>
<p>給了一個301跳轉，讓browser去完成跳轉的動作。</p>
<ul>
<li>長跟短的URL要是一一對應嗎？</li>
</ul>
<blockquote>
<h5 id="单选投票题-Long-Url-和-Short-Url-是否需要一一对应？"><a href="#单选投票题-Long-Url-和-Short-Url-是否需要一一对应？" class="headerlink" title="[单选投票题]Long Url 和 Short Url 是否需要一一对应？"></a>[单选投票题]Long Url 和 Short Url 是否需要一一对应？</h5><p>您选择的答案是B</p>
<p>感谢您参与投票！</p>
<p>A.需要41.63% 选择</p>
<p>B.不需要58.37% 选择</p>
</blockquote>
<blockquote>
<h5 id="单选投票题-Short-Url-长时间不用是否需要释放？"><a href="#单选投票题-Short-Url-长时间不用是否需要释放？" class="headerlink" title="[单选投票题]Short Url 长时间不用是否需要释放？"></a>[单选投票题]Short Url 长时间不用是否需要释放？</h5><p>您选择的答案是B</p>
<p>感谢您参与投票！</p>
<p>A.需要58.08% 选择</p>
<p>B.不需要41.92% 选择</p>
</blockquote>
<p>這兩個是開放的問題</p>
<p>不同的設計有不同的體驗。各有好壞處。</p>
<p>沒釋放出去就存disk，又不占什麼空間，又便宜。</p>
<h2 id="QPS"><a href="#QPS" class="headerlink" title="QPS"></a>QPS</h2><p>是否是真需要很多的機器？</p>
<p>ave QPS = 日活跃*每个用户平均请求次数/一天多少秒</p>
<p>系統一般不是特別頻繁</p>
<p>QPS這問題跟Storage都還好。</p>
<h2 id="Service"><a href="#Service" class="headerlink" title="Service"></a>Service</h2><p>就陽春一個而已</p>
<h2 id="Storage"><a href="#Storage" class="headerlink" title="Storage"></a>Storage</h2><blockquote>
<h5 id="单选题-TinyUrl-用什么类型的数据库比较合适？"><a href="#单选题-TinyUrl-用什么类型的数据库比较合适？" class="headerlink" title="[单选题]TinyUrl 用什么类型的数据库比较合适？"></a>[单选题]TinyUrl 用什么类型的数据库比较合适？</h5><p>A.SQL / 关系型数据库10.37% 选择</p>
<p>B.NoSQL / 非关系型数据库17.76% 选择</p>
<p>C<strong>.都可以，取决于算法是什么71.88% 选择</strong></p>
<p><img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBzdGFuZGFsb25lPSJubyI/PjwhRE9DVFlQRSBzdmcgUFVCTElDICItLy9XM0MvL0RURCBTVkcgMS4xLy9FTiIgImh0dHA6Ly93d3cudzMub3JnL0dyYXBoaWNzL1NWRy8xLjEvRFREL3N2ZzExLmR0ZCI+PHN2ZyB0PSIxNTQxNzAwNjYyNTQzIiBjbGFzcz0iaWNvbiIgc3R5bGU9IiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgdmVyc2lvbj0iMS4xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHAtaWQ9IjEwODgiIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB3aWR0aD0iNjQiIGhlaWdodD0iNjQiPjxkZWZzPjxzdHlsZSB0eXBlPSJ0ZXh0L2NzcyI+PC9zdHlsZT48L2RlZnM+PHBhdGggZD0iTTUxMiAwYTUxMiA1MTIgMCAxIDAgMCAxMDI0QTUxMiA1MTIgMCAwIDAgNTEyIDB6IG0xNjUuOTUyIDYzNy43NmwxNS4wNCAxNC45NzZhMjguNDE2IDI4LjQxNiAwIDEgMS00MC4yNTYgNDAuMjU2bC0xNC45NzYtMTUuMDRMNTA5LjUwNCA1NDkuNzYgMzcxLjIgNjg4YTI4LjQxNiAyOC40MTYgMCAxIDEtNDAuMjU2LTQwLjI1NmwxMzguMzA0LTEzOC4yNC0xMjMuMi0xMjMuMi0xNS4xMDQtMTUuMTA0YTI4LjU0NCAyOC41NDQgMCAwIDEgMC00MC4yNTYgMjguNTQ0IDI4LjU0NCAwIDAgMSA0MC4yNTYgMGwxNS4wNCAxNS4xMDRMNTA5LjQ0IDQ2OS4yNDhsMTQzLjIzMi0xNDMuMjk2YTI4LjQxNiAyOC40MTYgMCAxIDEgNDAuMjU2IDQwLjI1Nkw1NDkuNzYgNTA5LjUwNGwxMjguMTkyIDEyOC4yNTZ6IiBmaWxsPSIjRjY1RTVFIiBwLWlkPSIxMDg5Ij48L3BhdGg+PC9zdmc+" alt="img">答错了，您选择的答案是B</p>
<p><strong>正确答案:</strong>C</p>
<p><strong>解析:</strong></p>
<p>如果你需要用 Auto-increment ID，就用关系型数据库，否则可以用非关系型数据库，操作更简单一些。</p>
</blockquote>
<blockquote>
<ul>
<li>为什么sql比nosql要写的代码少呢？<ul>
<li>因为很多的 web framework，调用 SQL 部分的接口什么的代码都帮你写得很丰富，很多事儿你也都不用管。很多 NoSQL 的调用，包括 Serialization 之类的事情程序员都需要额外的代码去做。所以会长一些。</li>
</ul>
</li>
<li>除了seq id，还有什么方法确保两个不同的longUrl 得到不同的shorturl呢<ul>
<li>还可以随机生成一个 shortUrl 然后用数据库来判断用过没有，用过就再生成一个。</li>
</ul>
</li>
</ul>
</blockquote>
<h2 id="Alg"><a href="#Alg" class="headerlink" title="Alg."></a>Alg.</h2><ul>
<li>HASH –&gt; 再好的也會有conflict; md5本身就有，更不用說基於它再取６位</li>
<li>隨機生成再去DB去重</li>
</ul>
<blockquote>
<h5 id="多选题-下面哪些“码”可能是随机生成-数据库去重的？"><a href="#多选题-下面哪些“码”可能是随机生成-数据库去重的？" class="headerlink" title="[多选题]下面哪些“码”可能是随机生成+数据库去重的？"></a>[多选题]下面哪些“码”可能是随机生成+数据库去重的？</h5><p>A.短信验证码20.86% 选择</p>
<p>B.邮箱激活码21.60% 选择</p>
<p>C.酒店订单确认码28.84% 选择</p>
<p>D.机票订单确认码28.70% 选择</p>
<p><img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBzdGFuZGFsb25lPSJubyI/PjwhRE9DVFlQRSBzdmcgUFVCTElDICItLy9XM0MvL0RURCBTVkcgMS4xLy9FTiIgImh0dHA6Ly93d3cudzMub3JnL0dyYXBoaWNzL1NWRy8xLjEvRFREL3N2ZzExLmR0ZCI+PHN2ZyB0PSIxNTQxNzAwNjYyNTQzIiBjbGFzcz0iaWNvbiIgc3R5bGU9IiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgdmVyc2lvbj0iMS4xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHAtaWQ9IjEwODgiIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB3aWR0aD0iNjQiIGhlaWdodD0iNjQiPjxkZWZzPjxzdHlsZSB0eXBlPSJ0ZXh0L2NzcyI+PC9zdHlsZT48L2RlZnM+PHBhdGggZD0iTTUxMiAwYTUxMiA1MTIgMCAxIDAgMCAxMDI0QTUxMiA1MTIgMCAwIDAgNTEyIDB6IG0xNjUuOTUyIDYzNy43NmwxNS4wNCAxNC45NzZhMjguNDE2IDI4LjQxNiAwIDEgMS00MC4yNTYgNDAuMjU2bC0xNC45NzYtMTUuMDRMNTA5LjUwNCA1NDkuNzYgMzcxLjIgNjg4YTI4LjQxNiAyOC40MTYgMCAxIDEtNDAuMjU2LTQwLjI1NmwxMzguMzA0LTEzOC4yNC0xMjMuMi0xMjMuMi0xNS4xMDQtMTUuMTA0YTI4LjU0NCAyOC41NDQgMCAwIDEgMC00MC4yNTYgMjguNTQ0IDI4LjU0NCAwIDAgMSA0MC4yNTYgMGwxNS4wNCAxNS4xMDRMNTA5LjQ0IDQ2OS4yNDhsMTQzLjIzMi0xNDMuMjk2YTI4LjQxNiAyOC40MTYgMCAxIDEgNDAuMjU2IDQwLjI1Nkw1NDkuNzYgNTA5LjUwNGwxMjguMTkyIDEyOC4yNTZ6IiBmaWxsPSIjRjY1RTVFIiBwLWlkPSIxMDg5Ij48L3BhdGg+PC9zdmc+" alt="img">答错了，您选择的答案是ABCD</p>
<p><strong>正确答案:</strong>CD</p>
<p><strong>解析:</strong></p>
<p>验证码和激活码没有去重的需求。订单确认码才有去重的需求。</p>
</blockquote>
<p>驗證碼一下就過期了。訂單本身碼很長，所以有確認碼跟客服比較好溝通。</p>
<blockquote>
<ul>
<li><p>sequential id vs. non-sequential id 是怎么用的？ 为什么很重要？</p>
<ul>
<li>sequential id就是关系型数据库中每增加一行系统会自动给这一行数据分配一个自增id，这样可以保证每一行的id递增且不重复。如果id是随机生成的而不是有顺序的那就叫non sequenctial id，一般需要手动生成。</li>
</ul>
</li>
<li><p>随机生成函数是什么？可以具体讲讲么</p>
<ul>
<li><p>比如这样：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#39;&#39;.join([for i in range(6) random.choice(&quot;ABCDEF&quot;)])</span><br></pre></td></tr></table></figure>

<p>这段python 代码就是一个 for 循环，循环6次，每次从一个字符串里随机挑一个字符出来。这样就随机生成了一个 6位的code。</p>
</li>
</ul>
</li>
<li><p>不是说Hash的冲突概率很小吗?</p>
<ul>
<li>Hash冲突小的前提是，获得的 hashcode 的长度要足够长，一般生产的类似 UUID 这样的 hash 值，好几十位字符串，这样才不会冲突。只有6位字符很容易冲突。</li>
</ul>
</li>
<li><p>算法二除了速度慢外，如要处理并发问题吗，如果需要，如何处理？加锁吗？谢谢</p>
<ul>
<li>不需要做任何代码的修改。不需要加锁。并发没有问题。首先就算并发，两个 process 调用了 Random 函数之后得到的也是不同的随机串，冲突的概率很小。第二，就算有冲突，数据库也会进行加锁保证不会出现2个重复的被插入。第三如果因为 Race Condition 的原因，刚好会向数据库里插入两次一样的 short_key 的话，那么可以设置 short_key 是 unique 的，然后其中一次 fail 掉，报错给用户，用户重试一次即可解决问题。</li>
</ul>
</li>
<li><p>感觉可以随机生成10个candidate 然后batch query。这样就可以最大限度避免DDB read。</p>
<ul>
<li>这样是不对的。相当于你为了解决一个1%的case，降低了 99% 的case的运行效率。</li>
</ul>
</li>
<li><p>database.filter(shortURL)不会很慢么？</p>
<ul>
<li>不会，shortUrl有index。</li>
</ul>
</li>
<li><p>进制转换的方法是如何把longUrl 转换成 shortUrl的呢？</p>
<ul>
<li>将 long url 插入 database, 拿到 auto-increment id (sequential id)</li>
<li>将 id 进制转换得到 shortUrl</li>
</ul>
</li>
<li><p>sequential ID数据类型是整型啊？</p>
<ul>
<li>是的，整数。要不然做不到 sequential。sequential id 又叫做 auto-increment id</li>
</ul>
</li>
<li><p>那如果有人用同样的longUrl要求做shortUrl, 是会每次返回不一样的shortUrl么？</p>
<ul>
<li>相同的 longUrl 可以先查一下是否有和这个 longUrl对应的 shortUrl。查询的办法一方面可以通过数据库对 longUrl 建立 Index 来加速查询。另外也可以再加上 cache，把 longUrl to ShortUrl 的映射 cache 起来。先查 cache，查不到再去 db 查，这样就更快了。</li>
</ul>
</li>
</ul>
</blockquote>
<blockquote>
<p>[单选投票题]随机生成和进制转换两种算法你认为哪种更好？</p>
<p>你的选择:A</p>
<p>感谢您参与投票！</p>
<p>A:随机生成(36.58% 选择)</p>
<p>B:进制转换(63.42% 选择)</p>
</blockquote>
<h2 id="表單結構＆可行解"><a href="#表單結構＆可行解" class="headerlink" title="表單結構＆可行解"></a>表單結構＆可行解</h2><h3 id="隨機生成法"><a href="#隨機生成法" class="headerlink" title="隨機生成法"></a>隨機生成法</h3><p>​    不好</p>
<blockquote>
<ul>
<li>short long，这2个存在sql，哪一个做pk呢？这个是一一对应的么？是说，建了index，就可以用其他column去查pk也是可以的么？<ul>
<li>Primary Key 可以用 short，因为一个short 不能用两次，一个long 可以对应多个 short 所以可以存多次。用任意 column 做pk是可以的只要这个column 是 unique 的，不允许重复的。一一对应在课程中有讲到，short 到 long 是 1 short 对应 1 个 long。反过来一个 long 可以对应多个 short。</li>
</ul>
</li>
<li>为了快速查找而对short-&gt;long, long-&gt;short都建立index，那么index也就要求long url之间不能重复，对吗？如果允许long url重复，也就不能建立log的index<ul>
<li><strong><em>好问题！您对 index 的理解有误。 index 是可以有重复的，没有重复的 index 叫做 unique index。SQL 语句里如果你执行 <code>create index on long_url</code> 是可以重复的。如果你希望不重复，就<code>create unique index on long_url</code>。在 long url 建立 index 的情况下，您可以使用 index filter 出相同的 long_url 记录的第一条记录就可以了。</em></strong></li>
</ul>
</li>
</ul>
</blockquote>
<h2 id="Scale-優化response-time"><a href="#Scale-優化response-time" class="headerlink" title="Scale 優化response time"></a>Scale 優化response time</h2><ul>
<li><p>提速，讀多的用Cache 優化，可用Cache Aside，存兩個表long2short, and short2long。</p>
</li>
<li><p>提速：地理上server靠近訪問地點。或中心化的，靠兩邊都還ok中間的。</p>
<ul>
<li>DNS根據用戶地區給不同的IP去美國的web server找memcached裡的，找不到再去Shared DB。</li>
<li>用戶一次的request等於Web Server對DB一次的請求。</li>
<li>如果Web對DB請求是多次的，那最好吧DB放到跟Server一樣的地方，異地的SErver頂多再來訪問本地的Server，也就一次，這樣Server 對DB的延遲不會被放大。</li>
</ul>
</li>
</ul>
<blockquote>
<ul>
<li><h5 id="单选题-TinyUrl-是读多写少还是读少写多？"><a href="#单选题-TinyUrl-是读多写少还是读少写多？" class="headerlink" title="[单选题]TinyUrl 是读多写少还是读少写多？"></a>[单选题]TinyUrl 是读多写少还是读少写多？</h5><p>A.读多写少94.90% 选择</p>
<p>B.读少写多5.10% 选择</p>
<p><img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBzdGFuZGFsb25lPSJubyI/PjwhRE9DVFlQRSBzdmcgUFVCTElDICItLy9XM0MvL0RURCBTVkcgMS4xLy9FTiIgImh0dHA6Ly93d3cudzMub3JnL0dyYXBoaWNzL1NWRy8xLjEvRFREL3N2ZzExLmR0ZCI+PHN2ZyB0PSIxNTM0MTgxMjgxODM5IiBjbGFzcz0iaWNvbiIgc3R5bGU9IiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgdmVyc2lvbj0iMS4xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHAtaWQ9IjM3NjIiIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB3aWR0aD0iMzIiIGhlaWdodD0iMzIiPjxkZWZzPjxzdHlsZSB0eXBlPSJ0ZXh0L2NzcyI+PC9zdHlsZT48L2RlZnM+PHBhdGggZD0iTTUxOC4xMiA1MTYuMTZtLTQ5MCAwYTQ5MCA0OTAgMCAxIDAgOTgwIDAgNDkwIDQ5MCAwIDEgMC05ODAgMFoiIGZpbGw9IiM1NkI0MzIiIHAtaWQ9IjM3NjMiPjwvcGF0aD48cGF0aCBkPSJNMzkzLjIxMzYxOSA2NjQuMzM1NDk1bTI4LjI4NDI3MS0yOC4yODQyNzFsMjk2Ljk4NDg0OS0yOTYuOTg0ODQ4cTI4LjI4NDI3MS0yOC4yODQyNzEgNTYuNTY4NTQyIDBsMCAwcTI4LjI4NDI3MSAyOC4yODQyNzEgMCA1Ni41Njg1NDJsLTI5Ni45ODQ4NDggMjk2Ljk4NDg0OHEtMjguMjg0MjcxIDI4LjI4NDI3MS01Ni41Njg1NDMgMGwwIDBxLTI4LjI4NDI3MS0yOC4yODQyNzEgMC01Ni41Njg1NDJaIiBmaWxsPSIjRkZGRkZGIiBwLWlkPSIzNzY0Ij48L3BhdGg+PHBhdGggZD0iTTI4OS40Njk4NCA0NTIuODQ3ODgzbTI4LjI4NDI3MSAyOC4yODQyNzFsMTU1LjU2MzQ5MiAxNTUuNTYzNDkycTI4LjI4NDI3MSAyOC4yODQyNzEgMCA1Ni41Njg1NDNsMCAwcS0yOC4yODQyNzEgMjguMjg0MjcxLTU2LjU2ODU0MyAwbC0xNTUuNTYzNDkxLTE1NS41NjM0OTJxLTI4LjI4NDI3MS0yOC4yODQyNzEgMC01Ni41Njg1NDNsMCAwcTI4LjI4NDI3MS0yOC4yODQyNzEgNTYuNTY4NTQyIDBaIiBmaWxsPSIjRkZGRkZGIiBwLWlkPSIzNzY1Ij48L3BhdGg+PC9zdmc+" alt="img">答对了，您选择的答案是A</p>
<p><strong>正确答案:</strong>A</p>
</li>
</ul>
</blockquote>
<blockquote>
<ul>
<li>两个cache和DB之间的sync怎么解决<ul>
<li>写入一般都是先写db再写cache的，允许cache写入失败，但是db要写入成功。两者之间可以允许不一致</li>
</ul>
</li>
<li><strong>memcached 如何跟shared db sync</strong><ul>
<li><strong>这个就是典型的cache aside。从shared db读取结果到之后将结果放在memchached，这样再次查询同样的数据就可以直接从cache取。当有数据发生变动的时候，先写数据库，然后delete缓存里面受影响的数据。</strong></li>
</ul>
</li>
<li>为啥create short url 也需要 memcache？如果使用呢？<ul>
<li>因为create short url要先查询一下当前的long url是否已经有对应的short url了，这个可以查缓存里的long2short信息，如果缓存里有的话就不用创建了，如果缓存里没有再查db里有没有，如果有就直接返回现有的shorturl，如果没有就创建一个新的。</li>
</ul>
</li>
</ul>
</blockquote>
<h3 id="How-to-Scale"><a href="#How-to-Scale" class="headerlink" title="How to Scale"></a>How to Scale</h3><p>要是量翻了10倍，怎麼用多台數據庫怎麼去解決TinyURL的架構問題？</p>
<ul>
<li>什麼時候要多台DB Server<ul>
<li>Cache hit rate小</li>
<li>寫操作比較多 =&gt; 無法透過 Cache優化</li>
</ul>
</li>
</ul>
<blockquote>
<h5 id="单选题-TinyUrl-最主要要解决的是存不下还是忙不过来？"><a href="#单选题-TinyUrl-最主要要解决的是存不下还是忙不过来？" class="headerlink" title="[单选题]TinyUrl 最主要要解决的是存不下还是忙不过来？"></a>[单选题]TinyUrl 最主要要解决的是存不下还是忙不过来？</h5><p>A.存不下22.14% 选择    Storage</p>
<p>B.忙不过来77.86% 选择　QPS issue</p>
<p><img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBzdGFuZGFsb25lPSJubyI/PjwhRE9DVFlQRSBzdmcgUFVCTElDICItLy9XM0MvL0RURCBTVkcgMS4xLy9FTiIgImh0dHA6Ly93d3cudzMub3JnL0dyYXBoaWNzL1NWRy8xLjEvRFREL3N2ZzExLmR0ZCI+PHN2ZyB0PSIxNTM0MTgxMjgxODM5IiBjbGFzcz0iaWNvbiIgc3R5bGU9IiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgdmVyc2lvbj0iMS4xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHAtaWQ9IjM3NjIiIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB3aWR0aD0iMzIiIGhlaWdodD0iMzIiPjxkZWZzPjxzdHlsZSB0eXBlPSJ0ZXh0L2NzcyI+PC9zdHlsZT48L2RlZnM+PHBhdGggZD0iTTUxOC4xMiA1MTYuMTZtLTQ5MCAwYTQ5MCA0OTAgMCAxIDAgOTgwIDAgNDkwIDQ5MCAwIDEgMC05ODAgMFoiIGZpbGw9IiM1NkI0MzIiIHAtaWQ9IjM3NjMiPjwvcGF0aD48cGF0aCBkPSJNMzkzLjIxMzYxOSA2NjQuMzM1NDk1bTI4LjI4NDI3MS0yOC4yODQyNzFsMjk2Ljk4NDg0OS0yOTYuOTg0ODQ4cTI4LjI4NDI3MS0yOC4yODQyNzEgNTYuNTY4NTQyIDBsMCAwcTI4LjI4NDI3MSAyOC4yODQyNzEgMCA1Ni41Njg1NDJsLTI5Ni45ODQ4NDggMjk2Ljk4NDg0OHEtMjguMjg0MjcxIDI4LjI4NDI3MS01Ni41Njg1NDMgMGwwIDBxLTI4LjI4NDI3MS0yOC4yODQyNzEgMC01Ni41Njg1NDJaIiBmaWxsPSIjRkZGRkZGIiBwLWlkPSIzNzY0Ij48L3BhdGg+PHBhdGggZD0iTTI4OS40Njk4NCA0NTIuODQ3ODgzbTI4LjI4NDI3MSAyOC4yODQyNzFsMTU1LjU2MzQ5MiAxNTUuNTYzNDkycTI4LjI4NDI3MSAyOC4yODQyNzEgMCA1Ni41Njg1NDNsMCAwcS0yOC4yODQyNzEgMjguMjg0MjcxLTU2LjU2ODU0MyAwbC0xNTUuNTYzNDkxLTE1NS41NjM0OTJxLTI4LjI4NDI3MS0yOC4yODQyNzEgMC01Ni41Njg1NDNsMCAwcTI4LjI4NDI3MS0yOC4yODQyNzEgNTYuNTY4NTQyIDBaIiBmaWxsPSIjRkZGRkZGIiBwLWlkPSIzNzY1Ij48L3BhdGg+PC9zdmc+" alt="img">答对了，您选择的答案是B</p>
<p><strong>正确答案:</strong>B</p>
</blockquote>
<blockquote>
<h5 id="单选投票题-Tiny-Url-你会选择用什么做-Sharding-Key"><a href="#单选投票题-Tiny-Url-你会选择用什么做-Sharding-Key" class="headerlink" title="[单选投票题]Tiny Url 你会选择用什么做 Sharding Key?"></a>[单选投票题]Tiny Url 你会选择用什么做 Sharding Key?</h5><p>您选择的答案是A</p>
<p>感谢您参与投票！</p>
<p>A.Long Url17.21% 选择</p>
<p>B.Short Url82.79% 选择</p>
</blockquote>
<blockquote>
<ul>
<li>多机随机生成URL算法，如何处理并发问题呢？<ul>
<li>并发没有问题。首先就算并发，两个 process 调用了 Random 函数之后得到的也是不同的随机串，冲突的概率很小。第二，就算有冲突，数据库也会进行加锁保证不会出现2个重复的被插入。第三如果因为 Race Condition 的原因，刚好会向数据库里插入两次一样的 short_key 的话，那么可以设置 short_key 是 unique 的，然后其中一次 fail 掉，报错给用户，用户重试一次即可解决问题。</li>
</ul>
</li>
<li>专门一台db做seq id服务，请问下，db table的schema长什么样子？<ul>
<li>schema 里就一个 column 一个数据，就是 last_seq_id，大整数。</li>
</ul>
</li>
<li>有一点想确定一下 最后介绍的base62 sharding key方法是用来解决原本查询需要broadcast的情况 对吧？全局自增ID问题依旧需要有专项服务器处理吧<ul>
<li>是的，你的理解是对的。</li>
</ul>
</li>
<li>用base 62的方法做sharding key, 我们还需要存两份映射吗？<ul>
<li>如果你用 SQL 数据库的话，都 long 和short 都建了 index 就不需要了。通过sharding key找到机器，通过这台机器上的 index 找到具体数据。</li>
</ul>
</li>
<li>hash（long_url）就是得到的short url么？<ul>
<li><code>hash(long_url) % 62</code>得到的是 short url 的第一位字符</li>
</ul>
</li>
<li>这个并不解决全局自增ID的问题啊？？<ul>
<li>这并没有解决自增id的问题，只是在查询的时候不用broadcast了。要做全局自增id还是需要使用前述方法。</li>
</ul>
</li>
<li>能否在储存shorturl的表单里加入sharding_key，这样就没有62台机器的数量限制了<ul>
<li>在存储shorturl的表单里加入sharding_key的话仍然没有解决查询short2long时需要广播的问题。这里说的方案是把sharding key给embed到shorturl中，因此需要占用一定的shorturl位数。当sharding key占shorturl中的一位的时候就是限定62台机器，占两位的时候就是62 * 62台，只能是在这个占的位数上做trade off。</li>
</ul>
</li>
</ul>
</blockquote>
<h3 id="Multi-Region-Optimization"><a href="#Multi-Region-Optimization" class="headerlink" title="Multi Region Optimization"></a>Multi Region Optimization</h3><ul>
<li>數據庫在美、台各地各放一份？<ul>
<li>一致性問題難解決</li>
</ul>
</li>
<li>可根據網站的地域信息作Sharding ，避免存多份的不一致<ul>
<li>域名- 可根據長尾理論作白名單</li>
<li>Short url的前置位</li>
<li>大不了跨境需求讓它慢一點</li>
</ul>
</li>
</ul>
<blockquote>
<ul>
<li>db usa 和db cn 如果保持数据一致性？<ul>
<li>不需要保持一致，两边存储的是不一样的数据。DB USA只存属于美国的long2short和short2long，而DB CN是只存中国的long2short和short2long。如果担心分配的shorturl有冲突的话可以给不同的区域分别分配不同的可用shorturl范围。</li>
</ul>
</li>
<li>分布式DB的机器距离变远之后（一个在中国，一个在美国），进行操作所需要的时间会变慢吗？影响大不大？<ul>
<li>会，但是你可以将美国那边近期的热点ur（中国用户最近访问得比较多得美国url)做一个中国本地的cache，这样可以很大程度上减轻这种影响。</li>
</ul>
</li>
</ul>
</blockquote>
<h2 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h2><p>一般是各方法有自己的優缺、優劣</p>
<ul>
<li>TinyURL related <ul>
<li>知乎 <a href="http://bit.ly/22FHP5o" target="_blank" rel="noopener">http://bit.ly/22FHP5o</a></li>
<li>The System Design Process <a href="http://bit.ly/1B6HOEc" target="_blank" rel="noopener">http://bit.ly/1B6HOEc</a></li>
</ul>
</li>
<li>用Django搭建一个网站 <a href="http://bit.ly/21LApIb" target="_blank" rel="noopener">http://bit.ly/21LApIb</a><ul>
<li>搭建一个tiny url的网站</li>
</ul>
</li>
<li>Emoji URL<ul>
<li><a href="http://www.xn--vi8hiv.ws" target="_blank" rel="noopener">http://www.xn--vi8hiv.ws</a></li>
</ul>
</li>
</ul>
<h2 id="Extension"><a href="#Extension" class="headerlink" title="Extension"></a>Extension</h2><h1 id="Q-amp-A"><a href="#Q-amp-A" class="headerlink" title="Q&amp;A"></a>Q&amp;A</h1><blockquote>
<p><img src="https://tva1.sinaimg.cn/large/00831rSTgy1gdi4zq7rxxj30r80tw783.jpg" alt="image-20200404230945535"></p>
</blockquote>
<p><img src="https://tva1.sinaimg.cn/large/00831rSTgy1gdi53cccn3j30r80tugqk.jpg" alt="image-20200404231317707"></p>
<p><img src="https://tva1.sinaimg.cn/large/00831rSTgy1gdi548ss55j30qe0o8dil.jpg" alt="image-20200404231410186"></p>
<p><img src="https://tva1.sinaimg.cn/large/00831rSTgy1gdi54ljrx1j30qe0siwis.jpg" alt="image-20200404231430477"></p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2019/03/28/System-Design/9p/2019-03-28-Design%20Data%20Augmentation%20&amp;%20Consistent%20Hash%20&amp;%20Rate%20Limiter/">System-Design/9p/2019-03-28-Design Data Augmentation &amp; Consistent Hash &amp; Rate Limiter</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2019-03-28</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/SystemDesign/">SystemDesign</a></span><div class="content"><h1 id="Design-Data-Aug-amp-Consistent-Hash"><a href="#Design-Data-Aug-amp-Consistent-Hash" class="headerlink" title="Design Data Aug. &amp; Consistent Hash"></a>Design Data Aug. &amp; Consistent Hash</h1><h2 id="Outline"><a href="#Outline" class="headerlink" title="Outline"></a>Outline</h2><ul>
<li>Hash</li>
<li>Consistent Hash</li>
<li>Load Balancer</li>
<li>Rate Limiter</li>
<li>Web Logger</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    @param key: A string you should hash</span></span><br><span class="line"><span class="string">    @param HASH_SIZE: An integer</span></span><br><span class="line"><span class="string">    @return: An integer</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">hashCode</span><span class="params">(self, key, HASH_SIZE)</span>:</span></span><br><span class="line">        <span class="comment"># write your code here</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">helper_LTE</span><span class="params">(key, HASH_SIZE)</span>:</span></span><br><span class="line">            res = <span class="number">0</span></span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> range(len(key)):</span><br><span class="line">                <span class="comment"># print(pow(33, len(key)-i))</span></span><br><span class="line">                res += ord(key[i]) * pow(<span class="number">33</span>,len(key)<span class="number">-1</span>-i)</span><br><span class="line">            <span class="comment"># print(res)</span></span><br><span class="line">            <span class="keyword">return</span> res%HASH_SIZE</span><br><span class="line">            </span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">helper</span><span class="params">(key, HASH_SIZE)</span>:</span></span><br><span class="line">            </span><br><span class="line">            res = <span class="number">0</span></span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> range(len(key)):</span><br><span class="line">                <span class="comment"># 同余定理：</span></span><br><span class="line">                <span class="comment"># (a * b ) % MOD = ((a % MOD) * (b % MOD)) % MOD</span></span><br><span class="line">                res = (res*<span class="number">33</span> + ord(key[i]))%HASH_SIZE</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># return res%HASH_SIZE  STILL LTE</span></span><br><span class="line">            <span class="keyword">return</span> res</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># return helper_LTE(key, HASH_SIZE)</span></span><br><span class="line">        <span class="keyword">return</span> helper(key, HASH_SIZE)</span><br></pre></td></tr></table></figure>



<p>sharding 也可叫 拆分、division</p>
<p>md5 16^32 用在登入密碼加密，有可能有衝突，現在已經已經不怎麼安全啦</p>
<p>SHA512</p>
<p>密碼加鹽</p>
<h2 id="How-to-Scale"><a href="#How-to-Scale" class="headerlink" title="How to Scale"></a>How to Scale</h2><p>就是要Scale Database 的問題，因為DB 要是被訪問多了，會掛。</p>
<p>假如user有1k, Server，DB都OK, 最大的問題是什麼？</p>
<p>它病死了！</p>
<blockquote>
<h5 id="单选题-除了-QPS-承受力的问题以外，还有什么问题是“最主要”需要考虑的？"><a href="#单选题-除了-QPS-承受力的问题以外，还有什么问题是“最主要”需要考虑的？" class="headerlink" title="[单选题]除了 QPS 承受力的问题以外，还有什么问题是“最主要”需要考虑的？"></a>[单选题]除了 QPS 承受力的问题以外，还有什么问题是“最主要”需要考虑的？</h5><p>如果只用一台数据库</p>
<p>A.硬盘大小7.42% 选择</p>
<p>B.CPU 的运算速度8.71% 选择</p>
<p>C.单点失效 Single Point Failure82.66% 选择</p>
<p>D.价格是否昂贵1.21% 选择</p>
<p><img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBzdGFuZGFsb25lPSJubyI/PjwhRE9DVFlQRSBzdmcgUFVCTElDICItLy9XM0MvL0RURCBTVkcgMS4xLy9FTiIgImh0dHA6Ly93d3cudzMub3JnL0dyYXBoaWNzL1NWRy8xLjEvRFREL3N2ZzExLmR0ZCI+PHN2ZyB0PSIxNTM0MTgxMjgxODM5IiBjbGFzcz0iaWNvbiIgc3R5bGU9IiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgdmVyc2lvbj0iMS4xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHAtaWQ9IjM3NjIiIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB3aWR0aD0iMzIiIGhlaWdodD0iMzIiPjxkZWZzPjxzdHlsZSB0eXBlPSJ0ZXh0L2NzcyI+PC9zdHlsZT48L2RlZnM+PHBhdGggZD0iTTUxOC4xMiA1MTYuMTZtLTQ5MCAwYTQ5MCA0OTAgMCAxIDAgOTgwIDAgNDkwIDQ5MCAwIDEgMC05ODAgMFoiIGZpbGw9IiM1NkI0MzIiIHAtaWQ9IjM3NjMiPjwvcGF0aD48cGF0aCBkPSJNMzkzLjIxMzYxOSA2NjQuMzM1NDk1bTI4LjI4NDI3MS0yOC4yODQyNzFsMjk2Ljk4NDg0OS0yOTYuOTg0ODQ4cTI4LjI4NDI3MS0yOC4yODQyNzEgNTYuNTY4NTQyIDBsMCAwcTI4LjI4NDI3MSAyOC4yODQyNzEgMCA1Ni41Njg1NDJsLTI5Ni45ODQ4NDggMjk2Ljk4NDg0OHEtMjguMjg0MjcxIDI4LjI4NDI3MS01Ni41Njg1NDMgMGwwIDBxLTI4LjI4NDI3MS0yOC4yODQyNzEgMC01Ni41Njg1NDJaIiBmaWxsPSIjRkZGRkZGIiBwLWlkPSIzNzY0Ij48L3BhdGg+PHBhdGggZD0iTTI4OS40Njk4NCA0NTIuODQ3ODgzbTI4LjI4NDI3MSAyOC4yODQyNzFsMTU1LjU2MzQ5MiAxNTUuNTYzNDkycTI4LjI4NDI3MSAyOC4yODQyNzEgMCA1Ni41Njg1NDNsMCAwcS0yOC4yODQyNzEgMjguMjg0MjcxLTU2LjU2ODU0MyAwbC0xNTUuNTYzNDkxLTE1NS41NjM0OTJxLTI4LjI4NDI3MS0yOC4yODQyNzEgMC01Ni41Njg1NDNsMCAwcTI4LjI4NDI3MS0yOC4yODQyNzEgNTYuNTY4NTQyIDBaIiBmaWxsPSIjRkZGRkZGIiBwLWlkPSIzNzY1Ij48L3BhdGg+PC9zdmc+" alt="img">答对了，您选择的答案是C</p>
<p><strong>正确答案:</strong>C</p>
<p><strong>解析:</strong></p>
<p>硬盘大小，CPU运算速度，价格当然也重要。但是问题最大的还是单点失效，即如果挂了没有其他机器可以马上替代的问题。</p>
</blockquote>
<p>網站不能用=&gt;數據全丟了=&gt;用戶不來啦</p>
<p>Server是無狀態的，是不存用戶的信息的。</p>
<p>如果想增加數據庫的話，我們該怎麼拆分數據？就是Sharding，or partition，此外還要做Replica數據複製。</p>
<p>希望能用機器去拆分掉進來的流量。</p>
<ul>
<li>Sharding<ul>
<li>分攤讀寫流量</li>
<li>不會一個掛就全掛</li>
</ul>
</li>
<li>Replica<ul>
<li>一式三份，兩台近，一台遠</li>
<li>分攤讀請求</li>
</ul>
</li>
</ul>
<blockquote>
<ul>
<li>一般导致数据库挂了的原因是什么？硬盘损坏么？<ul>
<li>也可能运算量太大卡主了</li>
</ul>
</li>
<li>那负责拆分的机器的qps是不是要很大<ul>
<li>因此通常是每台 WebServer 自己根据同样的算法来计算出该去哪一台数据库存取数据，而不是都跑到一个中心节点去。</li>
</ul>
</li>
<li>所以说数据拆分是因为 分担流量，不是因为太多数据一台电脑装不下是吗<ul>
<li>两个都是目的。大部分时候是为了分摊流量。也有因为装不下需要分摊的情况。</li>
</ul>
</li>
</ul>
</blockquote>
<h2 id="Sharding-in-SQL-vs-NoSQL"><a href="#Sharding-in-SQL-vs-NoSQL" class="headerlink" title="Sharding in SQL vs NoSQL"></a>Sharding in SQL vs NoSQL</h2><p>NoSQL多是自己就提供好了</p>
<h3 id="Vertical"><a href="#Vertical" class="headerlink" title="Vertical"></a>Vertical</h3><p>照table的不同類型，粗暴簡單</p>
<p>可以把user不常改的跟常改的分去到兩個不同的 Table，流量就分開了</p>
<h5 id="缺點：可能就是洗菜、切菜就是比較久，煮很快，所以不該都一個人"><a href="#缺點：可能就是洗菜、切菜就是比較久，煮很快，所以不該都一個人" class="headerlink" title="缺點：可能就是洗菜、切菜就是比較久，煮很快，所以不該都一個人"></a>缺點：可能就是洗菜、切菜就是比較久，煮很快，所以不該都一個人</h5><p>[单选题]Vertical Sharding 不能解决什么问题？</p>
<p>A.数据库 table 很多的情况6.64% 选择</p>
<p>B.一个 table 中有很多关联度不大的 columns8.77% 选择</p>
<p>C.一个 table 里存储的内容太大，且 columns 无法再做拆分84.58% 选择</p>
<p><img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBzdGFuZGFsb25lPSJubyI/PjwhRE9DVFlQRSBzdmcgUFVCTElDICItLy9XM0MvL0RURCBTVkcgMS4xLy9FTiIgImh0dHA6Ly93d3cudzMub3JnL0dyYXBoaWNzL1NWRy8xLjEvRFREL3N2ZzExLmR0ZCI+PHN2ZyB0PSIxNTM0MTgxMjgxODM5IiBjbGFzcz0iaWNvbiIgc3R5bGU9IiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgdmVyc2lvbj0iMS4xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHAtaWQ9IjM3NjIiIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB3aWR0aD0iMzIiIGhlaWdodD0iMzIiPjxkZWZzPjxzdHlsZSB0eXBlPSJ0ZXh0L2NzcyI+PC9zdHlsZT48L2RlZnM+PHBhdGggZD0iTTUxOC4xMiA1MTYuMTZtLTQ5MCAwYTQ5MCA0OTAgMCAxIDAgOTgwIDAgNDkwIDQ5MCAwIDEgMC05ODAgMFoiIGZpbGw9IiM1NkI0MzIiIHAtaWQ9IjM3NjMiPjwvcGF0aD48cGF0aCBkPSJNMzkzLjIxMzYxOSA2NjQuMzM1NDk1bTI4LjI4NDI3MS0yOC4yODQyNzFsMjk2Ljk4NDg0OS0yOTYuOTg0ODQ4cTI4LjI4NDI3MS0yOC4yODQyNzEgNTYuNTY4NTQyIDBsMCAwcTI4LjI4NDI3MSAyOC4yODQyNzEgMCA1Ni41Njg1NDJsLTI5Ni45ODQ4NDggMjk2Ljk4NDg0OHEtMjguMjg0MjcxIDI4LjI4NDI3MS01Ni41Njg1NDMgMGwwIDBxLTI4LjI4NDI3MS0yOC4yODQyNzEgMC01Ni41Njg1NDJaIiBmaWxsPSIjRkZGRkZGIiBwLWlkPSIzNzY0Ij48L3BhdGg+PHBhdGggZD0iTTI4OS40Njk4NCA0NTIuODQ3ODgzbTI4LjI4NDI3MSAyOC4yODQyNzFsMTU1LjU2MzQ5MiAxNTUuNTYzNDkycTI4LjI4NDI3MSAyOC4yODQyNzEgMCA1Ni41Njg1NDNsMCAwcS0yOC4yODQyNzEgMjguMjg0MjcxLTU2LjU2ODU0MyAwbC0xNTUuNTYzNDkxLTE1NS41NjM0OTJxLTI4LjI4NDI3MS0yOC4yODQyNzEgMC01Ni41Njg1NDNsMCAwcTI4LjI4NDI3MS0yOC4yODQyNzEgNTYuNTY4NTQyIDBaIiBmaWxsPSIjRkZGRkZGIiBwLWlkPSIzNzY1Ij48L3BhdGg+PC9zdmc+" alt="img">答对了，您选择的答案是C</p>
<p><strong>正确答案:</strong>C</p>
<p><strong>解析:</strong></p>
<p>Vertical Sharding 是按照 column / table 来进行的，如果一个表单（table）里存储的内容太多，且 column 数目又无法再拆分，就无法使用 Vertical Sharding 了</p>
<h3 id="Horizontal"><a href="#Horizontal" class="headerlink" title="Horizontal"></a>Horizontal</h3><ul>
<li>新的數據放新的好嗎？<ul>
<li>所有數據被訪問的機率是相等的這個假設是錯的！當然一般是新的被訪問得多。一年前寫的都比較少在過問了。</li>
</ul>
</li>
</ul>
<h5 id="单选题-新数据放新机器，老数据放老机器的问题是什么？"><a href="#单选题-新数据放新机器，老数据放老机器的问题是什么？" class="headerlink" title="[单选题]新数据放新机器，老数据放老机器的问题是什么？"></a>[单选题]新数据放新机器，老数据放老机器的问题是什么？</h5><p>A.数据访问不均匀45.88% 选择</p>
<p>B.数据存储不均匀12.10% 选择</p>
<p>C.取数据时无法确定数据存在哪儿42.02% 选择</p>
<p><img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBzdGFuZGFsb25lPSJubyI/PjwhRE9DVFlQRSBzdmcgUFVCTElDICItLy9XM0MvL0RURCBTVkcgMS4xLy9FTiIgImh0dHA6Ly93d3cudzMub3JnL0dyYXBoaWNzL1NWRy8xLjEvRFREL3N2ZzExLmR0ZCI+PHN2ZyB0PSIxNTQxNzAwNjYyNTQzIiBjbGFzcz0iaWNvbiIgc3R5bGU9IiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgdmVyc2lvbj0iMS4xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHAtaWQ9IjEwODgiIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB3aWR0aD0iNjQiIGhlaWdodD0iNjQiPjxkZWZzPjxzdHlsZSB0eXBlPSJ0ZXh0L2NzcyI+PC9zdHlsZT48L2RlZnM+PHBhdGggZD0iTTUxMiAwYTUxMiA1MTIgMCAxIDAgMCAxMDI0QTUxMiA1MTIgMCAwIDAgNTEyIDB6IG0xNjUuOTUyIDYzNy43NmwxNS4wNCAxNC45NzZhMjguNDE2IDI4LjQxNiAwIDEgMS00MC4yNTYgNDAuMjU2bC0xNC45NzYtMTUuMDRMNTA5LjUwNCA1NDkuNzYgMzcxLjIgNjg4YTI4LjQxNiAyOC40MTYgMCAxIDEtNDAuMjU2LTQwLjI1NmwxMzguMzA0LTEzOC4yNC0xMjMuMi0xMjMuMi0xNS4xMDQtMTUuMTA0YTI4LjU0NCAyOC41NDQgMCAwIDEgMC00MC4yNTYgMjguNTQ0IDI4LjU0NCAwIDAgMSA0MC4yNTYgMGwxNS4wNCAxNS4xMDRMNTA5LjQ0IDQ2OS4yNDhsMTQzLjIzMi0xNDMuMjk2YTI4LjQxNiAyOC40MTYgMCAxIDEgNDAuMjU2IDQwLjI1Nkw1NDkuNzYgNTA5LjUwNGwxMjguMTkyIDEyOC4yNTZ6IiBmaWxsPSIjRjY1RTVFIiBwLWlkPSIxMDg5Ij48L3BhdGg+PC9zdmc+" alt="img">答错了，您选择的答案是B</p>
<p><strong>正确答案:</strong>A</p>
<p><strong>解析:</strong></p>
<p>根据数据的新旧程度来拆分的话，新数据的访问次数比旧数据的访问次数是要明显多的，会导致数据访问不均匀的问题。<br>这种方法并不会导致存储不均匀，最多只有最新的一台机器的数据相对少一些，其他的机器都还是均匀的。也不会导致不知道数据去哪台机器取，比如根据 id 来拆分，0~99在1号机器，1-199 在2号机器的话，根据 id 可以算出对应的机器是哪个。</p>
<h4 id="模三好嗎？"><a href="#模三好嗎？" class="headerlink" title="模三好嗎？"></a>模三好嗎？</h4><p>買新機器／有機器掛時就要大遷移了、</p>
<ul>
<li>慢，容易􏰀成数据的不一致性</li>
<li>迁移期间，服务器压力增大，容易挂</li>
</ul>
<blockquote>
<h5 id="单选题-理想状况下，3台机器变4台机器，多少数据需要迁移？"><a href="#单选题-理想状况下，3台机器变4台机器，多少数据需要迁移？" class="headerlink" title="[单选题]理想状况下，3台机器变4台机器，多少数据需要迁移？"></a>[单选题]理想状况下，3台机器变4台机器，多少数据需要迁移？</h5><p>A.33.3%15.00% 选择</p>
<p>B.25%65.56% 选择</p>
<p>C.50%2.30% 选择</p>
<p>D.75%17.14% 选择</p>
<p><img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBzdGFuZGFsb25lPSJubyI/PjwhRE9DVFlQRSBzdmcgUFVCTElDICItLy9XM0MvL0RURCBTVkcgMS4xLy9FTiIgImh0dHA6Ly93d3cudzMub3JnL0dyYXBoaWNzL1NWRy8xLjEvRFREL3N2ZzExLmR0ZCI+PHN2ZyB0PSIxNTM0MTgxMjgxODM5IiBjbGFzcz0iaWNvbiIgc3R5bGU9IiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgdmVyc2lvbj0iMS4xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHAtaWQ9IjM3NjIiIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB3aWR0aD0iMzIiIGhlaWdodD0iMzIiPjxkZWZzPjxzdHlsZSB0eXBlPSJ0ZXh0L2NzcyI+PC9zdHlsZT48L2RlZnM+PHBhdGggZD0iTTUxOC4xMiA1MTYuMTZtLTQ5MCAwYTQ5MCA0OTAgMCAxIDAgOTgwIDAgNDkwIDQ5MCAwIDEgMC05ODAgMFoiIGZpbGw9IiM1NkI0MzIiIHAtaWQ9IjM3NjMiPjwvcGF0aD48cGF0aCBkPSJNMzkzLjIxMzYxOSA2NjQuMzM1NDk1bTI4LjI4NDI3MS0yOC4yODQyNzFsMjk2Ljk4NDg0OS0yOTYuOTg0ODQ4cTI4LjI4NDI3MS0yOC4yODQyNzEgNTYuNTY4NTQyIDBsMCAwcTI4LjI4NDI3MSAyOC4yODQyNzEgMCA1Ni41Njg1NDJsLTI5Ni45ODQ4NDggMjk2Ljk4NDg0OHEtMjguMjg0MjcxIDI4LjI4NDI3MS01Ni41Njg1NDMgMGwwIDBxLTI4LjI4NDI3MS0yOC4yODQyNzEgMC01Ni41Njg1NDJaIiBmaWxsPSIjRkZGRkZGIiBwLWlkPSIzNzY0Ij48L3BhdGg+PHBhdGggZD0iTTI4OS40Njk4NCA0NTIuODQ3ODgzbTI4LjI4NDI3MSAyOC4yODQyNzFsMTU1LjU2MzQ5MiAxNTUuNTYzNDkycTI4LjI4NDI3MSAyOC4yODQyNzEgMCA1Ni41Njg1NDNsMCAwcS0yOC4yODQyNzEgMjguMjg0MjcxLTU2LjU2ODU0MyAwbC0xNTUuNTYzNDkxLTE1NS41NjM0OTJxLTI4LjI4NDI3MS0yOC4yODQyNzEgMC01Ni41Njg1NDNsMCAwcTI4LjI4NDI3MS0yOC4yODQyNzEgNTYuNTY4NTQyIDBaIiBmaWxsPSIjRkZGRkZGIiBwLWlkPSIzNzY1Ij48L3BhdGg+PC9zdmc+" alt="img">答对了，您选择的答案是B</p>
<p><strong>正确答案:</strong>B</p>
<p><strong>解析:</strong></p>
<p>理想状况下，这台新机器存储 1/4 的数据，因此需要移动的数据也是 1/4。</p>
</blockquote>
<p>就是理想下只想移動25%，不要全都移動</p>
<blockquote>
<ul>
<li>对于登入数据，如果按新旧存放，是否还会遇到“C.取数据时无法确定数据存在哪儿”的问题？因为用户名不是sequential的，而用户登入时并不知道自己的id<ul>
<li>yes</li>
</ul>
</li>
</ul>
</blockquote>
<h4 id="Consistent-Hash"><a href="#Consistent-Hash" class="headerlink" title="Consistent Hash"></a>Consistent Hash</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">A general database method <span class="keyword">for</span> performing a horizontal shard is to take the id against the total number of database servers n and <span class="keyword">then</span> to find out <span class="built_in">which</span> machine it is on. The downside of this approach is that as the data continues to increase, we need to increase the database server. When n is changed to n+1, almost all of the data has to be moved, <span class="built_in">which</span> is not consistent. In order to reduce the defects caused by this naive<span class="string">'s hash method (%n), a new hash algorithm emerges: Consistent Hashing, Consistent Hashing. There are many ways to implement this algorithm. Here we implement a simple Consistent Hashing.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Take id to 360. If there are 3 machines at the beginning, then let 3 machines be responsible for the three parts of 0~119, 120~239, 240~359. Then, how much is the model, check which zone you are in, and which machine to go to.</span></span><br><span class="line"><span class="string">When the machine changes from n to n+1, we find the largest one from the n intervals, then divide it into two and give half to the n+1th machine.</span></span><br><span class="line"><span class="string">For example, when changing from 3 to 4, we find the third interval 0~119 is the current largest interval, then we divide 0~119 into 0~59 and 60~119. 0~59 is still given to the first machine, 60~119 to the fourth machine.</span></span><br><span class="line"><span class="string">Then change from 4 to 5, we find the largest interval is the third interval 120~239, after splitting into two, it becomes 120~179, 180~239.</span></span><br><span class="line"><span class="string">Suppose all the data is on one machine at the beginning. When adding to the nth machine, what is the distribution of the interval and the corresponding machine number?</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Example</span></span><br><span class="line"><span class="string">Example 1:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Input:</span></span><br><span class="line"><span class="string"> n = 1, </span></span><br><span class="line"><span class="string">Output:</span></span><br><span class="line"><span class="string">[</span></span><br><span class="line"><span class="string">  [0,359,1]</span></span><br><span class="line"><span class="string">]</span></span><br><span class="line"><span class="string">Explanation:</span></span><br><span class="line"><span class="string">represent 0~359 belongs to machine 1.</span></span><br><span class="line"><span class="string">Example 2:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Input:</span></span><br><span class="line"><span class="string"> n = 2,</span></span><br><span class="line"><span class="string">Output:</span></span><br><span class="line"><span class="string">[</span></span><br><span class="line"><span class="string">  [0,179,1],</span></span><br><span class="line"><span class="string">  [180,359,2]</span></span><br><span class="line"><span class="string">]</span></span><br><span class="line"><span class="string">Explanation:</span></span><br><span class="line"><span class="string">represent 0~179 belongs to machine 1.</span></span><br><span class="line"><span class="string">represent 180~359 belongs to machine 2.</span></span><br><span class="line"><span class="string">Example 3:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Input:</span></span><br><span class="line"><span class="string">n = 3,</span></span><br><span class="line"><span class="string">Output:</span></span><br><span class="line"><span class="string">[</span></span><br><span class="line"><span class="string">  [0,89,1]</span></span><br><span class="line"><span class="string">  [90,179,3],</span></span><br><span class="line"><span class="string">  [180,359,2]</span></span><br><span class="line"><span class="string">]</span></span><br><span class="line"><span class="string">Clarification</span></span><br><span class="line"><span class="string">If the maximal interval is [x, y], and it belongs to machine id z, when you add a new machine with id n, you should divide [x, y, z] into two intervals:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[x, (x + y) / 2, z] and [(x + y) / 2 + 1, y, n]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Notice</span></span><br><span class="line"><span class="string">You can assume n &lt;= 360. At the same time, we agree that when there are multiple occurrences in the maximum interval, we split the machine with the smaller number.</span></span><br><span class="line"><span class="string">For example, the size of 0~119, 120~239 is 120, but the number of the previous machine is 1, and the number of the next machine is 2, so we split the range of 0~119.</span></span><br></pre></td></tr></table></figure>





<p>指的是對於ｎ台或 n+1 台機器時會是一致的</p>
<p>一致性哈希表存在每個server上。</p>
<ul>
<li>如果在相鄰的兩個各自挪一些來<ul>
<li>缺陷：<ul>
<li>仍是會有一台特別load重</li>
<li>遷移時就只有兩個鄰居，他們兩個人特別負載重</li>
</ul>
</li>
</ul>
</li>
</ul>
<blockquote>
<ul>
<li>360这个数值是经验值么？这个数字对于任何数量的机器都合适么？<ul>
<li>3<em>60 只是为了让理解一个圆有 360°，比较形象。这个数字当然不是实际的工程中使用的数字。实际使用的数字一般是 *</em>2^64 ==&gt; 宇宙爆炸的機率***</li>
</ul>
</li>
<li>反正都要用一个表来记录key-&gt;db号码， 为什么还要hash 2^64呢？ 直接把key和机器号码存到表里不行吗？<ul>
<li>没有 Key-&gt;db号码的这张表。<strong><em>通过 key 得到 db 是靠 consistent hashing 这个算法计算出</em></strong>来的，而不是把每个 key 存在哪个 db 都存下来。</li>
</ul>
</li>
</ul>
</blockquote>
<p>讓不同的key的時候的機率是2^64幾乎是宇宙爆炸的機率。</p>
<blockquote>
<h5 id="单选题-机器-D-加入-Consistent-Hash-Ring-以后，应该问谁要数据？"><a href="#单选题-机器-D-加入-Consistent-Hash-Ring-以后，应该问谁要数据？" class="headerlink" title="[单选题]机器 D 加入 Consistent Hash Ring 以后，应该问谁要数据？"></a>[单选题]机器 D 加入 Consistent Hash Ring 以后，应该问谁要数据？</h5><p>A.机器 A78.58% 选择</p>
<p>B.机器 B6.53% 选择</p>
<p>C.机器 C14.89% 选择</p>
<p><img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBzdGFuZGFsb25lPSJubyI/PjwhRE9DVFlQRSBzdmcgUFVCTElDICItLy9XM0MvL0RURCBTVkcgMS4xLy9FTiIgImh0dHA6Ly93d3cudzMub3JnL0dyYXBoaWNzL1NWRy8xLjEvRFREL3N2ZzExLmR0ZCI+PHN2ZyB0PSIxNTQxNzAwNjYyNTQzIiBjbGFzcz0iaWNvbiIgc3R5bGU9IiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgdmVyc2lvbj0iMS4xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHAtaWQ9IjEwODgiIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB3aWR0aD0iNjQiIGhlaWdodD0iNjQiPjxkZWZzPjxzdHlsZSB0eXBlPSJ0ZXh0L2NzcyI+PC9zdHlsZT48L2RlZnM+PHBhdGggZD0iTTUxMiAwYTUxMiA1MTIgMCAxIDAgMCAxMDI0QTUxMiA1MTIgMCAwIDAgNTEyIDB6IG0xNjUuOTUyIDYzNy43NmwxNS4wNCAxNC45NzZhMjguNDE2IDI4LjQxNiAwIDEgMS00MC4yNTYgNDAuMjU2bC0xNC45NzYtMTUuMDRMNTA5LjUwNCA1NDkuNzYgMzcxLjIgNjg4YTI4LjQxNiAyOC40MTYgMCAxIDEtNDAuMjU2LTQwLjI1NmwxMzguMzA0LTEzOC4yNC0xMjMuMi0xMjMuMi0xNS4xMDQtMTUuMTA0YTI4LjU0NCAyOC41NDQgMCAwIDEgMC00MC4yNTYgMjguNTQ0IDI4LjU0NCAwIDAgMSA0MC4yNTYgMGwxNS4wNCAxNS4xMDRMNTA5LjQ0IDQ2OS4yNDhsMTQzLjIzMi0xNDMuMjk2YTI4LjQxNiAyOC40MTYgMCAxIDEgNDAuMjU2IDQwLjI1Nkw1NDkuNzYgNTA5LjUwNGwxMjguMTkyIDEyOC4yNTZ6IiBmaWxsPSIjRjY1RTVFIiBwLWlkPSIxMDg5Ij48L3BhdGg+PC9zdmc+" alt="img">答错了，您选择的答案是C</p>
<p><strong>正确答案:</strong>A</p>
<img src="https://tva1.sinaimg.cn/large/00831rSTgy1gdcduksozaj30og0jatfy.jpg" alt="image-20200330234246254" style="zoom:67%;" />
</blockquote>
<p>Virtual node</p>
<p>理想新加入的機器的「分身」可以去均勻占到不同的前ｎ台機器的分身。如一台切成1000個，理想就是其他的10台，每台可以分到100個我的分身。</p>
<blockquote>
<h5 id="单选题-找比某个数大的最小值可以用什么数据结构？"><a href="#单选题-找比某个数大的最小值可以用什么数据结构？" class="headerlink" title="[单选题]找比某个数大的最小值可以用什么数据结构？"></a>[单选题]找比某个数大的最小值可以用什么数据结构？</h5><p>A.堆 Heap24.45% 选择</p>
<p>B.红黑树 Red-black Tree(Balanced Binary Search Tree)65.64% 选择</p>
<p>C.哈希表 HashMap2.45% 选择</p>
<p>D.链表 Linked List7.45% 选择</p>
<p><img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBzdGFuZGFsb25lPSJubyI/PjwhRE9DVFlQRSBzdmcgUFVCTElDICItLy9XM0MvL0RURCBTVkcgMS4xLy9FTiIgImh0dHA6Ly93d3cudzMub3JnL0dyYXBoaWNzL1NWRy8xLjEvRFREL3N2ZzExLmR0ZCI+PHN2ZyB0PSIxNTM0MTgxMjgxODM5IiBjbGFzcz0iaWNvbiIgc3R5bGU9IiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgdmVyc2lvbj0iMS4xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHAtaWQ9IjM3NjIiIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB3aWR0aD0iMzIiIGhlaWdodD0iMzIiPjxkZWZzPjxzdHlsZSB0eXBlPSJ0ZXh0L2NzcyI+PC9zdHlsZT48L2RlZnM+PHBhdGggZD0iTTUxOC4xMiA1MTYuMTZtLTQ5MCAwYTQ5MCA0OTAgMCAxIDAgOTgwIDAgNDkwIDQ5MCAwIDEgMC05ODAgMFoiIGZpbGw9IiM1NkI0MzIiIHAtaWQ9IjM3NjMiPjwvcGF0aD48cGF0aCBkPSJNMzkzLjIxMzYxOSA2NjQuMzM1NDk1bTI4LjI4NDI3MS0yOC4yODQyNzFsMjk2Ljk4NDg0OS0yOTYuOTg0ODQ4cTI4LjI4NDI3MS0yOC4yODQyNzEgNTYuNTY4NTQyIDBsMCAwcTI4LjI4NDI3MSAyOC4yODQyNzEgMCA1Ni41Njg1NDJsLTI5Ni45ODQ4NDggMjk2Ljk4NDg0OHEtMjguMjg0MjcxIDI4LjI4NDI3MS01Ni41Njg1NDMgMGwwIDBxLTI4LjI4NDI3MS0yOC4yODQyNzEgMC01Ni41Njg1NDJaIiBmaWxsPSIjRkZGRkZGIiBwLWlkPSIzNzY0Ij48L3BhdGg+PHBhdGggZD0iTTI4OS40Njk4NCA0NTIuODQ3ODgzbTI4LjI4NDI3MSAyOC4yODQyNzFsMTU1LjU2MzQ5MiAxNTUuNTYzNDkycTI4LjI4NDI3MSAyOC4yODQyNzEgMCA1Ni41Njg1NDNsMCAwcS0yOC4yODQyNzEgMjguMjg0MjcxLTU2LjU2ODU0MyAwbC0xNTUuNTYzNDkxLTE1NS41NjM0OTJxLTI4LjI4NDI3MS0yOC4yODQyNzEgMC01Ni41Njg1NDNsMCAwcTI4LjI4NDI3MS0yOC4yODQyNzEgNTYuNTY4NTQyIDBaIiBmaWxsPSIjRkZGRkZGIiBwLWlkPSIzNzY1Ij48L3BhdGg+PC9zdmc+" alt="img">答对了，您选择的答案是B</p>
<p><strong>正确答案:</strong>B</p>
<p><strong>解析:</strong></p>
<p>Heap 只能找全局最大最小。</p>
</blockquote>
<p>要增刪查改還是用Binary Search Tree, 可快速找到比某數大的最小數。</p>
<p>從順時間碰到的node的真實機器作遷移</p>
<blockquote>
<ul>
<li>key如何设计才能保证hash算出来几乎均匀分布在0到2的64次方这么大的范围？<ul>
<li>选择一个好的哈希函数就行了，比如： MurmurHash, xxHash, MetroHash or SipHash1–3</li>
</ul>
</li>
<li>问题同上面的同学：怎么保持key均匀分布？<ul>
<li>选择一个好的哈希函数是可以保证这个性质的。<a href="https://en.wikipedia.org/wiki/Hash_function#Uniformity" target="_blank" rel="noopener">https://en.wikipedia.org/wiki/Hash_function#Uniformity</a></li>
</ul>
</li>
<li>这个哈希算法是用来做数据库horizontal sharding的吗，它能用在分配服务器上吗？能用在vertical sharding上吗？<ul>
<li>是的，用来做 <strong>Horizontal Sharding</strong>。不能用在 Veritical Sharding 上。Vertical Sharding 是按照 column / table 进行 sharding 并不按照数据本身的值来进行 sharding。<strong><em>他可以用在分配数据服务器上</em></strong>，但是不能用在分配 web 服务器上。<strong>因为 web 服务器是 stateless 的，不需要固定的去同一个 web server，只需要随机分配即可。</strong></li>
</ul>
</li>
<li>新增加机器时，增加的虚拟的点的位置是随机的么？<ul>
<li>本质上都是根据机器名字 hash 出来的，不能认为是随机的。</li>
</ul>
</li>
</ul>
</blockquote>
<h4 id="Consistent-HashⅡ"><a href="#Consistent-HashⅡ" class="headerlink" title="Consistent HashⅡ"></a>Consistent HashⅡ</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">描述</span><br><span class="line">在 Consistent Hashing I 中我们介绍了一个比较简单的一致性哈希算法，这个简单的版本有两个缺陷：</span><br><span class="line"></span><br><span class="line">增加一台机器之后，数据全部从其中一台机器过来，这一台机器的读负载过大，对正常的服务会造成影响。</span><br><span class="line">当增加到3台机器的时候，每台服务器的负载量不均衡，为1:1:2。</span><br><span class="line">为了解决这个问题，引入了 micro-shards 的概念，一个更好的算法是这样：</span><br><span class="line"></span><br><span class="line">将 360° 的区间分得更细。从 0~359 变为一个 0 ~ n-1 的区间，将这个区间首尾相接，连成一个圆。</span><br><span class="line">当加入一台新的机器的时候，随机选择在圆周中撒 k 个点，代表这台机器的 k 个 micro-shards。</span><br><span class="line">每个数据在圆周上也对应一个点，这个点通过一个 <span class="built_in">hash</span> <span class="keyword">function</span> 来计算。</span><br><span class="line">一个数据该属于哪台机器负责管理，是按照该数据对应的圆周上的点在圆上顺时针碰到的第一个 micro-shard 点所属的机器来决定。</span><br><span class="line">n 和 k在真实的 NoSQL 数据库中一般是 2^64 和 1000。</span><br><span class="line"></span><br><span class="line">请实现这种引入了 micro-shard 的 consistent hashing 的方法。主要实现如下的三个函数：</span><br><span class="line"></span><br><span class="line">create(int n, int k)</span><br><span class="line">addMachine(int machine_id) // add a new machine, <span class="built_in">return</span> a list of shard ids.</span><br><span class="line">getMachineIdByHashCode(int hashcode) // <span class="built_in">return</span> machine id</span><br></pre></td></tr></table></figure>



<h2 id="Replica"><a href="#Replica" class="headerlink" title="Replica"></a>Replica</h2><blockquote>
<h5 id="多选题-下列关于-Backup-和-Replica-的区别描述正确的有？"><a href="#多选题-下列关于-Backup-和-Replica-的区别描述正确的有？" class="headerlink" title="[多选题]下列关于 Backup 和 Replica 的区别描述正确的有？"></a>[多选题]下列关于 Backup 和 Replica 的区别描述正确的有？</h5><p>A.Backup 一般是周期性的，Replica 是实时的31.83% 选择</p>
<p>B.Backup 一天做一次7.07% 选择</p>
<p>C.Replica 一般一式三份27.59% 选择</p>
<p>D.Backup 可以分摊读请求1.54% 选择</p>
<p>E.Replica 可以分摊读请求29.77% 选择</p>
<p>F.有了 Replica 之后就不需要 Backup 了2.21% 选择</p>
<p><img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBzdGFuZGFsb25lPSJubyI/PjwhRE9DVFlQRSBzdmcgUFVCTElDICItLy9XM0MvL0RURCBTVkcgMS4xLy9FTiIgImh0dHA6Ly93d3cudzMub3JnL0dyYXBoaWNzL1NWRy8xLjEvRFREL3N2ZzExLmR0ZCI+PHN2ZyB0PSIxNTM0MTgxMjgxODM5IiBjbGFzcz0iaWNvbiIgc3R5bGU9IiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgdmVyc2lvbj0iMS4xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHAtaWQ9IjM3NjIiIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB3aWR0aD0iMzIiIGhlaWdodD0iMzIiPjxkZWZzPjxzdHlsZSB0eXBlPSJ0ZXh0L2NzcyI+PC9zdHlsZT48L2RlZnM+PHBhdGggZD0iTTUxOC4xMiA1MTYuMTZtLTQ5MCAwYTQ5MCA0OTAgMCAxIDAgOTgwIDAgNDkwIDQ5MCAwIDEgMC05ODAgMFoiIGZpbGw9IiM1NkI0MzIiIHAtaWQ9IjM3NjMiPjwvcGF0aD48cGF0aCBkPSJNMzkzLjIxMzYxOSA2NjQuMzM1NDk1bTI4LjI4NDI3MS0yOC4yODQyNzFsMjk2Ljk4NDg0OS0yOTYuOTg0ODQ4cTI4LjI4NDI3MS0yOC4yODQyNzEgNTYuNTY4NTQyIDBsMCAwcTI4LjI4NDI3MSAyOC4yODQyNzEgMCA1Ni41Njg1NDJsLTI5Ni45ODQ4NDggMjk2Ljk4NDg0OHEtMjguMjg0MjcxIDI4LjI4NDI3MS01Ni41Njg1NDMgMGwwIDBxLTI4LjI4NDI3MS0yOC4yODQyNzEgMC01Ni41Njg1NDJaIiBmaWxsPSIjRkZGRkZGIiBwLWlkPSIzNzY0Ij48L3BhdGg+PHBhdGggZD0iTTI4OS40Njk4NCA0NTIuODQ3ODgzbTI4LjI4NDI3MSAyOC4yODQyNzFsMTU1LjU2MzQ5MiAxNTUuNTYzNDkycTI4LjI4NDI3MSAyOC4yODQyNzEgMCA1Ni41Njg1NDNsMCAwcS0yOC4yODQyNzEgMjguMjg0MjcxLTU2LjU2ODU0MyAwbC0xNTUuNTYzNDkxLTE1NS41NjM0OTJxLTI4LjI4NDI3MS0yOC4yODQyNzEgMC01Ni41Njg1NDNsMCAwcTI4LjI4NDI3MS0yOC4yODQyNzEgNTYuNTY4NTQyIDBaIiBmaWxsPSIjRkZGRkZGIiBwLWlkPSIzNzY1Ij48L3BhdGg+PC9zdmc+" alt="img">答对了，您选择的答案是ACE</p>
<p><strong>正确答案:</strong>ACE</p>
<p><strong>解析:</strong></p>
<p>Backup 一般一天做一次，但是这个完全是因人而异，不是强制的。<br>Backup 存储的是离线数据，无法分摊在线读请求。<br><strong>虽然 Replica 很强大，但是 Backup 也是很有必要的，可以认为是一个双保险。且可以服务于一些离线数据计算，这样不会给在线数据库带来压力</strong>。</p>
</blockquote>
<p>雙重保險</p>
<p><strong>不是每種DB都有replica，所以backup還是保險</strong></p>
<p>更穩定，就是發展的先後問題。</p>
<blockquote>
<ul>
<li>replica和backup代价是一样的吗？比如说都需要一台机器？是不是说replica的机器可能性能好一点，而backup对机器性能没有要求<ul>
<li>有的。你说的方式就是很多 NoSQL 现在用的方式，选择一个 Replica 写进去，然后这个 Replica 负责同步给其他的 Replica。 <strong><em>Replica 之间的地位是等价的，没有 master-slave 的上下级之分。</em></strong></li>
</ul>
</li>
</ul>
</blockquote>
<h3 id="SQL-用-MasterSlave-VS-NoSQL-用等價的replica-w-Consistent-Hashing-作傳遞"><a href="#SQL-用-MasterSlave-VS-NoSQL-用等價的replica-w-Consistent-Hashing-作傳遞" class="headerlink" title="SQL - 用 MasterSlave VS NoSQL 用等價的replica w/ Consistent Hashing 作傳遞"></a>SQL - 用 MasterSlave VS NoSQL 用等價的replica w/ Consistent Hashing 作傳遞</h3><ul>
<li>也可手動作 Consistent Hash Ring</li>
</ul>
<h4 id="Write-Ahead-Log"><a href="#Write-Ahead-Log" class="headerlink" title="Write Ahead Log"></a>Write Ahead Log</h4><p>就只會一直追加</p>
<p>所以slave上讀會比較慢</p>
<ul>
<li><p>Master 掛了時要是Slave還沒拉過去，雖然Slave被升級成了Master，但data還是就不見了。</p>
</li>
<li><p>也要根據這個支持把 transaction 反向。</p>
</li>
</ul>
<blockquote>
<ul>
<li>How to do consistent hashing for a web server? For DB, the web server can compute the hashcode and then choose DB. Which component to do this for Web Server? DNS? NGIX?<ul>
<li><strong><em>Web Server 是不需要做 Consistent Hashing 的。因为 Web Server 是 stateless 的，你不需要保证每个用户每次访问的都是同一个 Web Server</em></strong>，随机来一个 Server 服务他就可以了，就跟你去银行不一定每次都去一个窗口排队，哪个人少去哪个排队就可以了。只有 DB 才需要做 Consistent Hashing 因为你的钱如果存在工商银行你去建设银行是取不到钱的。 <strong>Web Server 只需要做 Load Balancing ，这个步骤是 NGINX 或者专门的 Load Balancing 的硬件 或者 AWS 的 Load Balanacing 服务负责做的</strong>。</li>
</ul>
</li>
<li>replica和backup代价是一样的吗？比如说都需要一台机器？是不是说replica的机器可能性能好一点，而backup对机器性能没有要求<ul>
<li>代价不一样。replica 要实时，而且要服务在线请求，要求是比较高的。backup 只是做一下存储备份，不服务用户，要求比较低。</li>
</ul>
</li>
<li><strong><em>replica方法除了master slave，还有别的方法吗，比如说所有服务器都是master，都能接受写操作，隔一段时间同步一次</em></strong><ul>
<li><strong>*有的。你说的方式就是很多 NoSQL 现在用的方式，选择一个 Replica 写进去，然后这个 Replica 负责同步给其他的 Replica。 Replica 之间的地位是等价的，没有 master-slave 的上下级之分</strong>。*</li>
</ul>
</li>
<li>“下列关于 Backup 和 Replica 的区别描述正确的有？” 为什么replica一般一式三份？<ul>
<li>經驗值</li>
</ul>
</li>
<li>Replica在一致性哈希环上顺时针存三份我理解的是紧挨着的3个位置，对吗？这样读请求来的时候可以分摊给这3个机器吗？<ul>
<li>对的。<strong><em>读请求可以分摊给replica</em></strong>。</li>
</ul>
</li>
</ul>
</blockquote>
<h2 id="Ex-1-Sharding-User-Table"><a href="#Ex-1-Sharding-User-Table" class="headerlink" title="Ex.1 Sharding User Table"></a>Ex.1 Sharding User Table</h2><ul>
<li><p>某個數據庫如按哪個key, Column去sharding好？</p>
<p>User Table怎麼算sharding 好？</p>
<p><strong><em>就是說要拿什麼去跑一次consistent hash去得到機器的編號，然後連上那台機器，然後去那台機器拿出數據呢？</em></strong></p>
<ul>
<li><p>怎麼取數據就怎麼拆數據</p>
<p>就是看最常見是按什麼去查呢？就把這個拆開去作sharding吧。</p>
<p><em>舉例：*</em>user_id是最常被其他的表單用到的foreign_key，就用它作拆分***</p>
<ul>
<li>但一般都是用username找用戶啊？<ul>
<li><strong>*就再建個表單作username =&gt; user_id映射，多查一個步驟就好</strong>。*</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p>Insert時怎辦？該去哪台數據庫作insert呢？</p>
<ul>
<li><strong><em>同一台機器時可以設sequential id，就是有另張表紀錄這張表的sequential id到了哪了，然後會加鎖去保持連續性。</em></strong></li>
<li>這時可以自己自建一個uuid作為用戶的user_id,  不同人不會撞啦！<strong><em>因為是uuid，宇宙爆炸的機率</em></strong><ul>
<li>然後再拿去作consistent hashing</li>
</ul>
</li>
<li><strong>擴機器時怎辦？uuid是字串，本來人少時是用整數呀，怎辦？</strong><ul>
<li><strong><em>建個表，在一個新的service裡（這個可以全局共享），就是要先去那個表查，那個表在查時會加鎖，再map到uuid。</em></strong><ul>
<li>也就是說用加鎖保證數據的原子性。</li>
<li>創建用戶也不是大QPS，所以問題也不是特大。</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<blockquote>
<h5 id="单选题-User-Table-最常见的需求是按照什么去查询？"><a href="#单选题-User-Table-最常见的需求是按照什么去查询？" class="headerlink" title="[单选题]User Table 最常见的需求是按照什么去查询？"></a>[单选题]User Table 最常见的需求是按照什么去查询？</h5><p>A.username21.85% 选择</p>
<p>B.id (user_id)76.69% 选择</p>
<p>C.phone number0.09% 选择</p>
<p>D.email1.37% 选择</p>
<p><img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBzdGFuZGFsb25lPSJubyI/PjwhRE9DVFlQRSBzdmcgUFVCTElDICItLy9XM0MvL0RURCBTVkcgMS4xLy9FTiIgImh0dHA6Ly93d3cudzMub3JnL0dyYXBoaWNzL1NWRy8xLjEvRFREL3N2ZzExLmR0ZCI+PHN2ZyB0PSIxNTQxNzAwNjYyNTQzIiBjbGFzcz0iaWNvbiIgc3R5bGU9IiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgdmVyc2lvbj0iMS4xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHAtaWQ9IjEwODgiIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB3aWR0aD0iNjQiIGhlaWdodD0iNjQiPjxkZWZzPjxzdHlsZSB0eXBlPSJ0ZXh0L2NzcyI+PC9zdHlsZT48L2RlZnM+PHBhdGggZD0iTTUxMiAwYTUxMiA1MTIgMCAxIDAgMCAxMDI0QTUxMiA1MTIgMCAwIDAgNTEyIDB6IG0xNjUuOTUyIDYzNy43NmwxNS4wNCAxNC45NzZhMjguNDE2IDI4LjQxNiAwIDEgMS00MC4yNTYgNDAuMjU2bC0xNC45NzYtMTUuMDRMNTA5LjUwNCA1NDkuNzYgMzcxLjIgNjg4YTI4LjQxNiAyOC40MTYgMCAxIDEtNDAuMjU2LTQwLjI1NmwxMzguMzA0LTEzOC4yNC0xMjMuMi0xMjMuMi0xNS4xMDQtMTUuMTA0YTI4LjU0NCAyOC41NDQgMCAwIDEgMC00MC4yNTYgMjguNTQ0IDI4LjU0NCAwIDAgMSA0MC4yNTYgMGwxNS4wNCAxNS4xMDRMNTA5LjQ0IDQ2OS4yNDhsMTQzLjIzMi0xNDMuMjk2YTI4LjQxNiAyOC40MTYgMCAxIDEgNDAuMjU2IDQwLjI1Nkw1NDkuNzYgNTA5LjUwNGwxMjguMTkyIDEyOC4yNTZ6IiBmaWxsPSIjRjY1RTVFIiBwLWlkPSIxMDg5Ij48L3BhdGg+PC9zdmc+" alt="img">答错了，您选择的答案是A</p>
<p><strong>正确答案:</strong>B</p>
<p><strong>解析:</strong></p>
<p>user_id 会作为其他 Table 的 Foreign key 存在，所以是最频繁的查询需求。</p>
</blockquote>
<blockquote>
<ul>
<li><strong><em>这个新的表单存储username, userid, 这个不需要sharding对吧？ 因为读取比较少？</em></strong><ul>
<li><strong><em>如果读取比较少的情况下，不 sharding 也没问题。不过一般这类 Key-value 的查询都会放在 NoSQL 数据库里，默认就会 sharding。</em></strong></li>
</ul>
</li>
<li>好像可以用当前时间加其他的限制条件来创建ID，这样可以让ID有其他的信息，这样好么？<ul>
<li><strong><em>这样做也是可以的，相当于denormalization，但是有一定风险，要注意保持id的随机性，否则可能会让id的生成变得predictable</em></strong>。</li>
</ul>
</li>
<li>如果table QPS需求大的话，而且已经采用了自增id，是不是就不用自增id， 创建一个新table， 用uuid来做key， 然后把原有数据移植到新的table？ 然后更新其他 引用它的table的foreign key？<ul>
<li>更新 foreign key 是一个很大的工程（引用太多了。而且随时可能更改）。<strong><em>所以最后一点说的是，创立一个单独的 UserIdService 来负责产生这个全局自增的 user_id</em></strong>。<strong>更新 foreign key 这个并不现实</strong>。</li>
</ul>
</li>
<li>可以通过hash把原来的id改成uuid吗<ul>
<li><strong><em>uuid是有标准的生成方式的，不能仅仅通过求Hash的方式来获得uuid:</em></strong> <a href="https://en.wikipedia.org/wiki/Universally_unique_identifier#Versions" target="_blank" rel="noopener">https://en.wikipedia.org/wiki/Universally_unique_identifier#Versions</a></li>
</ul>
</li>
<li>这个UserIdservice是不是一种分布式锁啊？<ul>
<li><strong><em>原理有些类似，但是这个还算不上一个general-purpose的分布式锁，只是在系统中设计了一个单点来保证生成ID的顺序和唯一性</em></strong>。</li>
</ul>
</li>
</ul>
</blockquote>
<h2 id="Session-Table-Sharding"><a href="#Session-Table-Sharding" class="headerlink" title="Session Table Sharding"></a>Session Table Sharding</h2><blockquote>
<h5 id="单选题-Session-Table-通常按照哪一项去查询？"><a href="#单选题-Session-Table-通常按照哪一项去查询？" class="headerlink" title="[单选题]Session Table 通常按照哪一项去查询？"></a>[单选题]Session Table 通常按照哪一项去查询？</h5><p>A.session key (session token)84.15% 选择</p>
<p>B.user_id14.54% 选择</p>
<p>C.expire_at1.31% 选择</p>
<p><img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBzdGFuZGFsb25lPSJubyI/PjwhRE9DVFlQRSBzdmcgUFVCTElDICItLy9XM0MvL0RURCBTVkcgMS4xLy9FTiIgImh0dHA6Ly93d3cudzMub3JnL0dyYXBoaWNzL1NWRy8xLjEvRFREL3N2ZzExLmR0ZCI+PHN2ZyB0PSIxNTM0MTgxMjgxODM5IiBjbGFzcz0iaWNvbiIgc3R5bGU9IiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgdmVyc2lvbj0iMS4xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHAtaWQ9IjM3NjIiIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB3aWR0aD0iMzIiIGhlaWdodD0iMzIiPjxkZWZzPjxzdHlsZSB0eXBlPSJ0ZXh0L2NzcyI+PC9zdHlsZT48L2RlZnM+PHBhdGggZD0iTTUxOC4xMiA1MTYuMTZtLTQ5MCAwYTQ5MCA0OTAgMCAxIDAgOTgwIDAgNDkwIDQ5MCAwIDEgMC05ODAgMFoiIGZpbGw9IiM1NkI0MzIiIHAtaWQ9IjM3NjMiPjwvcGF0aD48cGF0aCBkPSJNMzkzLjIxMzYxOSA2NjQuMzM1NDk1bTI4LjI4NDI3MS0yOC4yODQyNzFsMjk2Ljk4NDg0OS0yOTYuOTg0ODQ4cTI4LjI4NDI3MS0yOC4yODQyNzEgNTYuNTY4NTQyIDBsMCAwcTI4LjI4NDI3MSAyOC4yODQyNzEgMCA1Ni41Njg1NDJsLTI5Ni45ODQ4NDggMjk2Ljk4NDg0OHEtMjguMjg0MjcxIDI4LjI4NDI3MS01Ni41Njg1NDMgMGwwIDBxLTI4LjI4NDI3MS0yOC4yODQyNzEgMC01Ni41Njg1NDJaIiBmaWxsPSIjRkZGRkZGIiBwLWlkPSIzNzY0Ij48L3BhdGg+PHBhdGggZD0iTTI4OS40Njk4NCA0NTIuODQ3ODgzbTI4LjI4NDI3MSAyOC4yODQyNzFsMTU1LjU2MzQ5MiAxNTUuNTYzNDkycTI4LjI4NDI3MSAyOC4yODQyNzEgMCA1Ni41Njg1NDNsMCAwcS0yOC4yODQyNzEgMjguMjg0MjcxLTU2LjU2ODU0MyAwbC0xNTUuNTYzNDkxLTE1NS41NjM0OTJxLTI4LjI4NDI3MS0yOC4yODQyNzEgMC01Ni41Njg1NDNsMCAwcTI4LjI4NDI3MS0yOC4yODQyNzEgNTYuNTY4NTQyIDBaIiBmaWxsPSIjRkZGRkZGIiBwLWlkPSIzNzY1Ij48L3BhdGg+PC9zdmc+" alt="img">答对了，您选择的答案是A</p>
<p><strong>正确答案:</strong>A</p>
</blockquote>
<blockquote>
<ul>
<li><em>为什么哪一项最常用就要根据哪一项去sharding呢，能详细解释一下吗</em><ul>
<li><strong><em>不是哪一项常用就按照哪一项去 sharding，是按照哪一项查询</em></strong>就按照哪一项 sharding。假如一个数据有 col1, col2 两项，按照 col1 sharding 的意思就是，如果两条数据的 col1 相同，就会被分配在同一台机器上。所以当你按照 col1 查询的时候，才能保证在同一台机器上找到这两条数据。如果你查询是按照 col1 来查询，存的时候却按照 col2 来sharding 的话，那么就没法保证 col1 相同的都在同一台机器上，这样 sharding 的意义就没有了，<strong><em>sharding 就是要让你能分摊查询请求到不同的机器</em></strong>，<strong><em>如果你的一次查询需要去所有机器汇总结果的话，这个 sharding 就是失败的 sharding</em></strong>。</li>
</ul>
</li>
</ul>
</blockquote>
<h2 id="News-Feed-Timeline-Shardings"><a href="#News-Feed-Timeline-Shardings" class="headerlink" title="News Feed / Timeline Shardings"></a>News Feed / Timeline Shardings</h2><blockquote>
<ul>
<li><em>TimeLine table 即 Post Table 刚才课上说到了是以User ID做为sharding key。 我有一个问题：如果我想查 Post 详情的话， 那是不是每次请求都要带上 User ID 才能定位到具体某台机器上。但是基本获取Post 详情的请求都只会带 Post ID而不是 Post ID 和 User ID啊。 求解答~</em><ul>
<li><strong>这种情况下，通常的做法是 post_id 里，前缀就带上 user_id。这样可以通过 post_id 得到 user_id。此时 post_id</strong> 通常是一个字符串，可以自定义格式。*</li>
</ul>
</li>
<li>news feed一般是会专门存一个table吗？比如我要看我的news feed，是<strong>拿我的user id去news feed table里面找，而不是拿我的所有关注user的id去post table里面找然后汇总</strong>？那么这个news feed table里面的信息总归是通过去post table里面查找汇总好了以后存在news feed table里的吧？可不可以介绍一下： 1. 这个table的schema。 2. 去post table查找和汇总发生在什么时候？<ul>
<li><em>news feed 一般就是一个专门的 table。</em><br><em>news feed table 的 schema 在 PPT 里有，你看一下。视频里也有讲到的。</em><br><strong><em>*去 post table 里查找和汇总可能不会发生，因为 news feed table 可以通过 denormalize 的方法把 post 的内容复制一份存在 news feed table</em></strong> 里来加速这个查询过程。*</li>
</ul>
</li>
</ul>
</blockquote>
<p>Ref:</p>
<ol>
<li><a href="https://afghl.github.io/2016/07/04/consistent-hashing.html" target="_blank" rel="noopener">https://afghl.github.io/2016/07/04/consistent-hashing.html</a></li>
<li><a href="http://blog.codinglabs.org/articles/consistent-hashing.html" target="_blank" rel="noopener">http://blog.codinglabs.org/articles/consistent-hashing.html</a></li>
</ol>
<h2 id="leetcode可能怎麼sharding"><a href="#leetcode可能怎麼sharding" class="headerlink" title="leetcode可能怎麼sharding?"></a>leetcode可能怎麼sharding?</h2><p>submission, user, timestamp, problem, status</p>
<blockquote>
<h5 id="单选题-LintCode-Submission-Table-按照什么进行-Sharding？"><a href="#单选题-LintCode-Submission-Table-按照什么进行-Sharding？" class="headerlink" title="[单选题]LintCode Submission Table 按照什么进行 Sharding？"></a>[单选题]LintCode Submission Table 按照什么进行 Sharding？</h5><p>A.user_id13.52% 选择</p>
<p>B.submission_id19.07% 选择</p>
<p>C.problem_id4.17% 选择</p>
<p>D.status0.28% 选择</p>
<p>E.用两个表单，分别按照 user_id 和 problem_id 来 sharding62.96% 选择</p>
<p><img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBzdGFuZGFsb25lPSJubyI/PjwhRE9DVFlQRSBzdmcgUFVCTElDICItLy9XM0MvL0RURCBTVkcgMS4xLy9FTiIgImh0dHA6Ly93d3cudzMub3JnL0dyYXBoaWNzL1NWRy8xLjEvRFREL3N2ZzExLmR0ZCI+PHN2ZyB0PSIxNTM0MTgxMjgxODM5IiBjbGFzcz0iaWNvbiIgc3R5bGU9IiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgdmVyc2lvbj0iMS4xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHAtaWQ9IjM3NjIiIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB3aWR0aD0iMzIiIGhlaWdodD0iMzIiPjxkZWZzPjxzdHlsZSB0eXBlPSJ0ZXh0L2NzcyI+PC9zdHlsZT48L2RlZnM+PHBhdGggZD0iTTUxOC4xMiA1MTYuMTZtLTQ5MCAwYTQ5MCA0OTAgMCAxIDAgOTgwIDAgNDkwIDQ5MCAwIDEgMC05ODAgMFoiIGZpbGw9IiM1NkI0MzIiIHAtaWQ9IjM3NjMiPjwvcGF0aD48cGF0aCBkPSJNMzkzLjIxMzYxOSA2NjQuMzM1NDk1bTI4LjI4NDI3MS0yOC4yODQyNzFsMjk2Ljk4NDg0OS0yOTYuOTg0ODQ4cTI4LjI4NDI3MS0yOC4yODQyNzEgNTYuNTY4NTQyIDBsMCAwcTI4LjI4NDI3MSAyOC4yODQyNzEgMCA1Ni41Njg1NDJsLTI5Ni45ODQ4NDggMjk2Ljk4NDg0OHEtMjguMjg0MjcxIDI4LjI4NDI3MS01Ni41Njg1NDMgMGwwIDBxLTI4LjI4NDI3MS0yOC4yODQyNzEgMC01Ni41Njg1NDJaIiBmaWxsPSIjRkZGRkZGIiBwLWlkPSIzNzY0Ij48L3BhdGg+PHBhdGggZD0iTTI4OS40Njk4NCA0NTIuODQ3ODgzbTI4LjI4NDI3MSAyOC4yODQyNzFsMTU1LjU2MzQ5MiAxNTUuNTYzNDkycTI4LjI4NDI3MSAyOC4yODQyNzEgMCA1Ni41Njg1NDNsMCAwcS0yOC4yODQyNzEgMjguMjg0MjcxLTU2LjU2ODU0MyAwbC0xNTUuNTYzNDkxLTE1NS41NjM0OTJxLTI4LjI4NDI3MS0yOC4yODQyNzEgMC01Ni41Njg1NDNsMCAwcTI4LjI4NDI3MS0yOC4yODQyNzEgNTYuNTY4NTQyIDBaIiBmaWxsPSIjRkZGRkZGIiBwLWlkPSIzNzY1Ij48L3BhdGg+PC9zdmc+" alt="img">答对了，您选择的答案是E</p>
<p><strong>正确答案:</strong>E</p>
</blockquote>
<p>需求１我們要查詢某個題的所有提交紀錄</p>
<p>Where problem_id = 999;</p>
<p>需求２我們要查詢某個人的所有提交紀錄</p>
<p>Where user_id = 999;</p>
<p>如果按user_id作sharding時，那當被查詢需求１時，就要去每台機器都拿過來，這樣效率就低。</p>
<p>NoSQL一般可Sharding, 也就比較不支持multi-index。麻煩。</p>
<p>用於篩選的info可以存兩份。</p>
<blockquote>
<ul>
<li>可以把code存在一个单独的table里面然后让两个表都去reference一个code id。当然也可以把code冗余地存在两个表中。前一种方法省空间，但是需要读两次数据库，后一种方法浪费一点空间但是只需要读一次数据库。</li>
</ul>
</blockquote>
<h2 id="Rate-Limiter"><a href="#Rate-Limiter" class="headerlink" title="Rate Limiter"></a>Rate Limiter</h2><p><img src="https://tva1.sinaimg.cn/large/00831rSTgy1gdgxpdr0mpj31ci0lae0x.jpg" alt="image-20200403221207316"></p>
<p>主要滿足大多人的滿意度、別有惡劣的影響</p>
<p><img src="https://tva1.sinaimg.cn/large/00831rSTgy1gdgxvl4bxej31f00kmq6n.jpg" alt="image-20200403221757444"></p>
<blockquote>
<ul>
<li>key,你这个event+feature+ts，无法区分是谁，哪个用户来的req啊？你如何block恶意的点击呢？<ul>
<li>这里举的只是一个简单的例子，实际中feature里面除了ip也可以包含user id之类的信息，你可以根据自己的需要去扩展。</li>
</ul>
</li>
<li>memcahed是一个字典还是一个自定义的类？<ul>
<li>memcached是一个内存型key-value数据库，你可以把它当作字典用。</li>
</ul>
</li>
</ul>
</blockquote>
<p><img src="https://tva1.sinaimg.cn/large/00831rSTgy1gdgxy3he6jj31100js4k6.jpg" alt="image-20200403222029916"></p>
<h2 id="Rate-Limiter-Mine-限流"><a href="#Rate-Limiter-Mine-限流" class="headerlink" title="Rate Limiter (Mine) 限流"></a>Rate Limiter (Mine) 限流</h2><p>ref: <a href="https://www.youtube.com/watch?v=e3-MTmtUpf4" target="_blank" rel="noopener">https://www.youtube.com/watch?v=e3-MTmtUpf4</a></p>
<p>限流就是如</p>
<p>A系統調(2000/s) B系統的接口，B處理流量的能力如 (1000/s)，B會被搞掛</p>
<p>所以</p>
<p>A –請求&lt;限流&gt; –&gt; B接口 (1000/s)</p>
<h3 id="Leaky-Bucket-漏桶算法-到底是漏桶還是漏斗"><a href="#Leaky-Bucket-漏桶算法-到底是漏桶還是漏斗" class="headerlink" title="Leaky Bucket 漏桶算法 (到底是漏桶還是漏斗?)"></a>Leaky Bucket 漏桶算法 (到底是漏桶還是漏斗?)</h3><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1ghbjtx1704j30do0ekwh9.jpg" alt="image-20200801194536656" style="zoom:50%;" />

<ul>
<li>一滴水代表一個http請求，把請求先裝到一個漏桶去，就很多滴水，出漏斗時表示去調B的接口了，如果漏出的速度比較慢，就是杯子會慢慢滿了，自己就會流出來了，叫作系統流量的最大值已經被超過。當超過漏桶容量時<ul>
<li>比較直接就是A再流進來系統就直接吐掉了</li>
<li>或是，有人性一點，再進來的水滴加一個隊列，再慢慢把隊列的丟進去漏桶去</li>
<li>當然漏桶自己本身當然也是個隊列啦。</li>
<li>量是根據第三方的限量去設計的</li>
<li>可強制限制調用的速率</li>
</ul>
</li>
<li>思路就是：<ol>
<li>請求先進入到漏桶裡</li>
<li>漏桶以一定的速度出水</li>
<li>當水請求較大，可能會溢出</li>
<li>能強行限制數據調用的速率</li>
</ol>
</li>
</ul>
<h3 id="Token-Bucket-令牌桶算法"><a href="#Token-Bucket-令牌桶算法" class="headerlink" title="Token Bucket 令牌桶算法"></a>Token Bucket 令牌桶算法</h3><img src="/Users/joe/Library/Application Support/typora-user-images/image-20200801205923248.png" alt="image-20200801205923248" style="zoom:50%;" />

<ul>
<li>這個是用得最多，一般在分布式的限流就是用這個</li>
<li>上面藍色是個令牌的池子，每隔一秒會往這個池子裡面放一張令牌</li>
<li>左邊是A系統要調時，會先去令牌池拿張牌出來再去調B接口，就是B前面有一道門，池子裡就像是keys，別人要先去撈keys，才能開門</li>
<li>令牌無時無刻都在丟<ol>
<li>溢出時：如果拿得比較慢，令牌桶會溢出，滿了就滿了，令牌桶新生成的丟不進去了，滿跟不滿都沒區別，我用老、新令牌沒差，都是可以開門的</li>
<li>沒得拿時：當A去拿令牌池裡的keys，發現沒有keys，其他沒令牌拿的9次就等待，不然就是拒絕服務，或也是把請求丟去隊列等著</li>
</ol>
</li>
</ul>
<h3 id="差別："><a href="#差別：" class="headerlink" title="差別："></a>差別：</h3><ol>
<li>如果有秒殺，如果有1000個商品，12點前令牌就要預處理，要保證有1000個令牌，因為12點那瞬間會有1000個併發操作的「突發流量」的令牌保證，保證業務能玩下去<ul>
<li>限制了平均速率</li>
<li>可接受突發狀況</li>
<li>會以一個恆定的速度往令牌池放令牌</li>
<li>沒令牌時，拒絕</li>
</ul>
</li>
<li>相對的，漏斗就是丟滿了就溢出了 <ul>
<li>滿時，<strong>熔斷</strong></li>
</ul>
</li>
</ol>
<h2 id="More-Cases"><a href="#More-Cases" class="headerlink" title="More Cases"></a>More Cases</h2><p>ref: <a href="https://zhuanlan.zhihu.com/p/21103657" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/21103657</a></p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2019/03/18/System-Design/9p/2019-03-18-Design%20User%20System%20DB%20&amp;%20Cache/">System-Design/9p/2019-03-18-Design User System DB &amp; Cache</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2019-03-18</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/SystemDesign/">SystemDesign</a></span><div class="content"><h1 id="Design-User-System"><a href="#Design-User-System" class="headerlink" title="Design User System"></a>Design User System</h1><h2 id="Memcached"><a href="#Memcached" class="headerlink" title="Memcached"></a>Memcached</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">538. 内存缓存</span><br><span class="line">中文English</span><br><span class="line">实现下列几个方法：</span><br><span class="line">1.get(curtTime, key). 得到key的值，如果不存在返回2147483647</span><br><span class="line">2.set(curtTime, key, value, ttl). 设置一个pair(key,value)，有效期从curtTime到curtTime + ttl -1 , 如果ttl为0，则一直存在</span><br><span class="line">3.delete(curtTime, key). 删除这个key</span><br><span class="line">4.incr(curtTime, key, delta). 给key的value加上delta，并且返回 如果不存在返回 2147483647。</span><br><span class="line">5.decr(curtTime, key, delta). 给key的value减去delta，并且返回 如果不存在返回 2147483647。</span><br><span class="line"></span><br><span class="line">Example</span><br><span class="line">样例1</span><br><span class="line"></span><br><span class="line">get(1, 0)</span><br><span class="line">&gt;&gt; 2147483647</span><br><span class="line"><span class="built_in">set</span>(2, 1, 1, 2)</span><br><span class="line">get(3, 1)</span><br><span class="line">&gt;&gt; 1</span><br><span class="line">get(4, 1)</span><br><span class="line">&gt;&gt; 2147483647</span><br><span class="line">incr(5, 1, 1)</span><br><span class="line">&gt;&gt; 2147483647</span><br><span class="line"><span class="built_in">set</span>(6, 1, 3, 0)</span><br><span class="line">incr(7, 1, 1)</span><br><span class="line">&gt;&gt; 4</span><br><span class="line">decr(8, 1, 1)</span><br><span class="line">&gt;&gt; 3</span><br><span class="line">get(9, 1)</span><br><span class="line">&gt;&gt; 3</span><br><span class="line">delete(10, 1)</span><br><span class="line">get(11, 1)</span><br><span class="line">&gt;&gt; 2147483647</span><br><span class="line">incr(12, 1, 1)</span><br><span class="line">&gt;&gt; 2147483647</span><br><span class="line">```**样例1**</span><br><span class="line"></span><br><span class="line">get(1, 0)</span><br><span class="line"></span><br><span class="line">2147483647</span><br><span class="line"><span class="built_in">set</span>(2, 1, 1, 2)</span><br><span class="line">get(3, 1)</span><br><span class="line"></span><br><span class="line">1</span><br><span class="line">get(4, 1)</span><br><span class="line"></span><br><span class="line">2147483647</span><br><span class="line">incr(5, 1, 1)</span><br><span class="line"></span><br><span class="line">2147483647</span><br><span class="line"><span class="built_in">set</span>(6, 1, 3, 0)</span><br><span class="line">incr(7, 1, 1)</span><br><span class="line"></span><br><span class="line">4</span><br><span class="line">decr(8, 1, 1)</span><br><span class="line"></span><br><span class="line">3</span><br><span class="line">get(9, 1)</span><br><span class="line"></span><br><span class="line">3</span><br><span class="line">delete(10, 1)</span><br><span class="line">get(11, 1)</span><br><span class="line"></span><br><span class="line">2147483647</span><br><span class="line">incr(12, 1, 1)</span><br><span class="line"></span><br><span class="line">2147483647</span><br><span class="line"></span><br><span class="line">Clarification</span><br><span class="line">实际上，如果内存不足，存缓存服务器将驱逐key，并且它还支持各种值类型，如字符串和整数。 在我们的例子中我们将这个问题简化了，我们可以假设我们有足够的内存，所有的值都是整数。</span><br><span class="line"></span><br><span class="line">在谷歌上搜索“LRU”和“LFU”以获取有关memcache如何逐出数据的更多信息。</span><br></pre></td></tr></table></figure>



<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Resource</span>:</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, value, expired)</span>:</span></span><br><span class="line">        self.value = value</span><br><span class="line">        self.expired = expired</span><br><span class="line"></span><br><span class="line">INT_MAX = <span class="number">0x7fffffff</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Memcache</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="comment"># initialize your data structure here.</span></span><br><span class="line">        self.client = dict()</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># @param &#123;int&#125; curtTime an integer</span></span><br><span class="line">    <span class="comment"># @param &#123;int&#125; key an integer</span></span><br><span class="line">    <span class="comment"># @return an integer</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self, curtTime, key)</span>:</span></span><br><span class="line">        <span class="comment"># Write your code here</span></span><br><span class="line">        <span class="keyword">if</span> key <span class="keyword">not</span> <span class="keyword">in</span> self.client:</span><br><span class="line">            <span class="keyword">return</span> INT_MAX</span><br><span class="line">        res = self.client.get(key)</span><br><span class="line">        <span class="keyword">if</span> res.expired &gt;= curtTime <span class="keyword">or</span> res.expired == <span class="number">-1</span>:</span><br><span class="line">            <span class="keyword">return</span> res.value</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> INT_MAX</span><br><span class="line"></span><br><span class="line">    <span class="comment"># @param &#123;int&#125; curtTime an integer</span></span><br><span class="line">    <span class="comment"># @param &#123;int&#125; key an integer</span></span><br><span class="line">    <span class="comment"># @param &#123;int&#125; value an integer</span></span><br><span class="line">    <span class="comment"># @param &#123;int&#125; ttl an integer</span></span><br><span class="line">    <span class="comment"># @return nothing</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">set</span><span class="params">(self, curtTime, key, value, ttl)</span>:</span></span><br><span class="line">        <span class="comment"># Write your code here</span></span><br><span class="line">        <span class="keyword">if</span> ttl:</span><br><span class="line">            res = Resource(value, curtTime + ttl - <span class="number">1</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            res = Resource(value, <span class="number">-1</span>)</span><br><span class="line"></span><br><span class="line">        self.client[key] = res </span><br><span class="line">        </span><br><span class="line">    <span class="comment"># @param &#123;int&#125; curtTime an integer</span></span><br><span class="line">    <span class="comment"># @param &#123;int&#125; key an integer</span></span><br><span class="line">    <span class="comment"># @return nothing</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(self, curtTime, key)</span>:</span></span><br><span class="line">        <span class="comment"># Write your code here</span></span><br><span class="line">        <span class="keyword">if</span> key <span class="keyword">not</span> <span class="keyword">in</span> self.client:</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">del</span> self.client[key]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># @param &#123;int&#125; curtTime an integer</span></span><br><span class="line">    <span class="comment"># @param &#123;int&#125; key an integer</span></span><br><span class="line">    <span class="comment"># @param &#123;int&#125; delta an integer</span></span><br><span class="line">    <span class="comment"># @return an integer</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">incr</span><span class="params">(self, curtTime, key, delta)</span>:</span></span><br><span class="line">        <span class="comment"># Write your code here</span></span><br><span class="line">        <span class="keyword">if</span> self.get(curtTime, key) == INT_MAX:</span><br><span class="line">            <span class="keyword">return</span> INT_MAX</span><br><span class="line">        self.client[key].value += delta</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> self.client[key].value</span><br><span class="line"></span><br><span class="line">    <span class="comment"># @param &#123;int&#125; curtTime an integer</span></span><br><span class="line">    <span class="comment"># @param &#123;int&#125; key an integer</span></span><br><span class="line">    <span class="comment"># @param &#123;int&#125; delta an integer</span></span><br><span class="line">    <span class="comment"># @return an integer</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">decr</span><span class="params">(self, curtTime, key, delta)</span>:</span></span><br><span class="line">        <span class="comment"># Write your code here</span></span><br><span class="line">        <span class="keyword">if</span> self.get(curtTime, key) == INT_MAX:</span><br><span class="line">            <span class="keyword">return</span> INT_MAX</span><br><span class="line">        self.client[key].value -= delta</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> self.client[key].value</span><br></pre></td></tr></table></figure>



<h2 id="Mini-Cassandra"><a href="#Mini-Cassandra" class="headerlink" title="Mini Cassandra"></a>Mini Cassandra</h2><p>Cassandra is a NoSQL database (a.k.a key-value storage). One individual data entry in cassandra constructed by 3 parts:</p>
<ol>
<li>row_key. (a.k.a hash_key, partition key or sharding_key.)</li>
<li>column_key.</li>
<li>value</li>
</ol>
<p>row_key is used to hash and can not support range query. Let’s simplify this to a string.<br>column_key is sorted and support range query. Let’s simplify this to integer.<br>value is a string. You can serialize any data into a string and store it in value.</p>
<p>Implement the following methods:</p>
<ol>
<li><code>insert(row_key, column_key, value)</code></li>
<li><code>query(row_key, column_start, column_end)</code> return a list of entries</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">502. Mini Cassandra</span><br><span class="line">中文English</span><br><span class="line">Cassandra is a NoSQL database (a.k.a key-value storage). One individual data entry <span class="keyword">in</span> cassandra constructed by 3 parts:</span><br><span class="line"></span><br><span class="line">row_key. (a.k.a hash_key, partition key or sharding_key.)</span><br><span class="line">column_key.</span><br><span class="line">value</span><br><span class="line">row_key is used to <span class="built_in">hash</span> and can not support range query. Let<span class="string">'s simplify this to a string.</span></span><br><span class="line"><span class="string">column_key is sorted and support range query. Let'</span>s simplify this to <span class="built_in">integer</span>.</span><br><span class="line">value is a string. You can serialize any data into a string and store it <span class="keyword">in</span> value.</span><br><span class="line"></span><br><span class="line">Implement the following methods:</span><br><span class="line"></span><br><span class="line">insert(row_key, column_key, value)</span><br><span class="line">query(row_key, column_start, column_end) <span class="built_in">return</span> a list of entries</span><br><span class="line">Example</span><br><span class="line">Example 1:</span><br><span class="line"></span><br><span class="line">Input:</span><br><span class="line">  insert(<span class="string">"google"</span>, 1, <span class="string">"haha"</span>)</span><br><span class="line">  query(<span class="string">"google"</span>, 0, 1)</span><br><span class="line">Output: [(1, <span class="string">"haha"</span>)]</span><br><span class="line">Example 2:</span><br><span class="line"></span><br><span class="line">Input:</span><br><span class="line">  insert(<span class="string">"google"</span>, 1, <span class="string">"haha"</span>)</span><br><span class="line">  insert(<span class="string">"lintcode"</span>, 1, <span class="string">"Good"</span>)</span><br><span class="line">  insert(<span class="string">"google"</span>, 2, <span class="string">"hehe"</span>)</span><br><span class="line">  query(<span class="string">"google"</span>, 0, 1)</span><br><span class="line">  query(<span class="string">"google"</span>, 0, 2)</span><br><span class="line">  query(<span class="string">"go"</span>, 0, 1)</span><br><span class="line">  query(<span class="string">"lintcode"</span>, 0, 10)</span><br><span class="line">Output:</span><br><span class="line">  [(1, <span class="string">"haha"</span>)]</span><br><span class="line">  [(1, <span class="string">"haha"</span>),(2, <span class="string">"hehe"</span>)]</span><br><span class="line">  []</span><br><span class="line">  [(1, <span class="string">"Good"</span>)]</span><br></pre></td></tr></table></figure>



<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">Definition of Column:</span></span><br><span class="line"><span class="string">class Column:</span></span><br><span class="line"><span class="string">    def __init__(self, key, value):</span></span><br><span class="line"><span class="string">        self.key = key</span></span><br><span class="line"><span class="string">        self.value = value</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> OrderedDict</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MiniCassandra</span>:</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="comment"># do intialization if necessary</span></span><br><span class="line">        self.hash = &#123;&#125;</span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    @param: row_key: a string</span></span><br><span class="line"><span class="string">    @param: column_key: An integer</span></span><br><span class="line"><span class="string">    @param: value: a string</span></span><br><span class="line"><span class="string">    @return: nothing</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">insert</span><span class="params">(self, row_key, column_key, value)</span>:</span></span><br><span class="line">        <span class="comment"># write your code here</span></span><br><span class="line">        <span class="keyword">if</span> row_key <span class="keyword">not</span> <span class="keyword">in</span> self.hash:</span><br><span class="line">            self.hash[row_key] = OrderedDict()</span><br><span class="line">        self.hash[row_key][column_key] = value</span><br><span class="line"></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    @param: row_key: a string</span></span><br><span class="line"><span class="string">    @param: column_start: An integer</span></span><br><span class="line"><span class="string">    @param: column_end: An integer</span></span><br><span class="line"><span class="string">    @return: a list of Columns</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">query</span><span class="params">(self, row_key, column_start, column_end)</span>:</span></span><br><span class="line">        <span class="comment"># Write your code here</span></span><br><span class="line">        rt = []</span><br><span class="line">        <span class="keyword">if</span> row_key <span class="keyword">not</span> <span class="keyword">in</span> self.hash:</span><br><span class="line">            <span class="keyword">return</span> rt</span><br><span class="line"></span><br><span class="line">        self.hash[row_key] = OrderedDict(sorted(self.hash[row_key].items()))</span><br><span class="line">        <span class="keyword">for</span> key, value <span class="keyword">in</span> self.hash[row_key].items():</span><br><span class="line">            <span class="keyword">if</span> key &gt;= column_start <span class="keyword">and</span> key &lt;= column_end:</span><br><span class="line">                rt.append(Column(key, value))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> rt</span><br><span class="line">        </span><br><span class="line">    <span class="comment"># def query(self, row_key, column_start, column_end):</span></span><br><span class="line">        <span class="comment"># write your code here</span></span><br><span class="line">        <span class="comment"># return []</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># print(self.od[row_key])</span></span><br><span class="line">        <span class="comment"># return self.od[row_key]#[column_start:column_end]</span></span><br></pre></td></tr></table></figure>



<h2 id="Friendship-Service"><a href="#Friendship-Service" class="headerlink" title="Friendship Service"></a>Friendship Service</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> defaultdict</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FriendshipService</span>:</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="comment"># do intialization if necessary</span></span><br><span class="line">        self.fans = defaultdict(list)</span><br><span class="line">        self.followings = defaultdict(list)</span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    @param: user_id: An integer</span></span><br><span class="line"><span class="string">    @return: all followers and sort by user_id</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">getFollowers</span><span class="params">(self, user_id)</span>:</span></span><br><span class="line">        <span class="comment"># write your code here</span></span><br><span class="line">        <span class="comment"># return []</span></span><br><span class="line">        <span class="keyword">return</span> sorted(self.fans[user_id])</span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    @param: user_id: An integer</span></span><br><span class="line"><span class="string">    @return: all followings and sort by user_id</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">getFollowings</span><span class="params">(self, user_id)</span>:</span></span><br><span class="line">        <span class="comment"># write your code here</span></span><br><span class="line">        <span class="comment"># return []</span></span><br><span class="line">        <span class="keyword">return</span> sorted(self.followings[user_id])</span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    @param: from_user_id: An integer</span></span><br><span class="line"><span class="string">    @param: to_user_id: An integer</span></span><br><span class="line"><span class="string">    @return: nothing</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">follow</span><span class="params">(self, to_user_id, from_user_id)</span>:</span></span><br><span class="line">        <span class="comment"># write your code here</span></span><br><span class="line">        <span class="keyword">if</span> to_user_id <span class="keyword">not</span> <span class="keyword">in</span> self.followings[from_user_id]:</span><br><span class="line">            self.followings[from_user_id] += [to_user_id]</span><br><span class="line">            <span class="comment"># self.followings[from_user_id].sort()</span></span><br><span class="line">        <span class="keyword">if</span> from_user_id <span class="keyword">not</span> <span class="keyword">in</span> self.fans[to_user_id]:</span><br><span class="line">            self.fans[to_user_id] += [from_user_id]</span><br><span class="line">            <span class="comment"># self.followings[from_user_id].sort()</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    @param: from_user_id: An integer</span></span><br><span class="line"><span class="string">    @param: to_user_id: An integer</span></span><br><span class="line"><span class="string">    @return: nothing</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">unfollow</span><span class="params">(self, to_user_id, from_user_id)</span>:</span></span><br><span class="line">        <span class="comment"># write your code here</span></span><br><span class="line">        <span class="comment"># self.followings[from_user_id].pop(self.followings[from_user_id].index(to_user_id))</span></span><br><span class="line">        <span class="comment"># self.fans[to_user_id].pop(self.fans[to_user_id].index(from_user_id))</span></span><br><span class="line">        a = self.followings[from_user_id]</span><br><span class="line">        b = self.fans[to_user_id]</span><br><span class="line">        <span class="keyword">if</span> from_user_id <span class="keyword">in</span> self.followings:</span><br><span class="line">            <span class="keyword">if</span> to_user_id <span class="keyword">in</span> a:</span><br><span class="line">                a.pop(a.index(to_user_id))</span><br><span class="line">        <span class="keyword">if</span> to_user_id <span class="keyword">in</span> self.fans:</span><br><span class="line">            <span class="keyword">if</span> from_user_id <span class="keyword">in</span> b:</span><br><span class="line">                b.pop(b.index(from_user_id))</span><br></pre></td></tr></table></figure>



<h2 id="LRU"><a href="#LRU" class="headerlink" title="LRU"></a>LRU</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> OrderedDict</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LRUCache</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    @param: capacity: An integer</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, capacity)</span>:</span></span><br><span class="line">        <span class="comment"># do intialization if necessary</span></span><br><span class="line">        self.od = OrderedDict()</span><br><span class="line">        self.capacity = capacity</span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    @param: key: An integer</span></span><br><span class="line"><span class="string">    @return: An integer</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self, key)</span>:</span></span><br><span class="line">        <span class="comment"># write your code here</span></span><br><span class="line">        <span class="keyword">if</span> key <span class="keyword">not</span> <span class="keyword">in</span> self.od:</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span></span><br><span class="line">        ret = self.od[key]</span><br><span class="line">        <span class="keyword">del</span> self.od[key]</span><br><span class="line">        self.od[key] = ret </span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> ret</span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    @param: key: An integer</span></span><br><span class="line"><span class="string">    @param: value: An integer</span></span><br><span class="line"><span class="string">    @return: nothing</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">set</span><span class="params">(self, key, value)</span>:</span></span><br><span class="line">        <span class="comment"># write your code here</span></span><br><span class="line">        <span class="keyword">if</span> key <span class="keyword">in</span> self.od:</span><br><span class="line">            <span class="keyword">del</span> self.od[key]</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">if</span> len(self.od) &gt;= self.capacity:</span><br><span class="line">                <span class="keyword">del</span> self.od[next(iter(self.od))]</span><br><span class="line">        self.od[key] = value</span><br></pre></td></tr></table></figure>







<p>註冊、登錄、查詢 (看別的好友之類)、修改info</p>
<blockquote>
<h5 id="单选题-以下四个操作哪个最频繁？"><a href="#单选题-以下四个操作哪个最频繁？" class="headerlink" title="[单选题]以下四个操作哪个最频繁？"></a>[单选题]以下四个操作哪个最频繁？</h5><p>A.注册3.36% 选择</p>
<p>B.登录44.02% 选择</p>
<p>C.用户信息查询50.67% 选择</p>
<p>D.用户信息修改1.94% 选择</p>
<p><img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBzdGFuZGFsb25lPSJubyI/PjwhRE9DVFlQRSBzdmcgUFVCTElDICItLy9XM0MvL0RURCBTVkcgMS4xLy9FTiIgImh0dHA6Ly93d3cudzMub3JnL0dyYXBoaWNzL1NWRy8xLjEvRFREL3N2ZzExLmR0ZCI+PHN2ZyB0PSIxNTQxNzAwNjYyNTQzIiBjbGFzcz0iaWNvbiIgc3R5bGU9IiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgdmVyc2lvbj0iMS4xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHAtaWQ9IjEwODgiIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB3aWR0aD0iNjQiIGhlaWdodD0iNjQiPjxkZWZzPjxzdHlsZSB0eXBlPSJ0ZXh0L2NzcyI+PC9zdHlsZT48L2RlZnM+PHBhdGggZD0iTTUxMiAwYTUxMiA1MTIgMCAxIDAgMCAxMDI0QTUxMiA1MTIgMCAwIDAgNTEyIDB6IG0xNjUuOTUyIDYzNy43NmwxNS4wNCAxNC45NzZhMjguNDE2IDI4LjQxNiAwIDEgMS00MC4yNTYgNDAuMjU2bC0xNC45NzYtMTUuMDRMNTA5LjUwNCA1NDkuNzYgMzcxLjIgNjg4YTI4LjQxNiAyOC40MTYgMCAxIDEtNDAuMjU2LTQwLjI1NmwxMzguMzA0LTEzOC4yNC0xMjMuMi0xMjMuMi0xNS4xMDQtMTUuMTA0YTI4LjU0NCAyOC41NDQgMCAwIDEgMC00MC4yNTYgMjguNTQ0IDI4LjU0NCAwIDAgMSA0MC4yNTYgMGwxNS4wNCAxNS4xMDRMNTA5LjQ0IDQ2OS4yNDhsMTQzLjIzMi0xNDMuMjk2YTI4LjQxNiAyOC40MTYgMCAxIDEgNDAuMjU2IDQwLjI1Nkw1NDkuNzYgNTA5LjUwNGwxMjguMTkyIDEyOC4yNTZ6IiBmaWxsPSIjRjY1RTVFIiBwLWlkPSIxMDg5Ij48L3BhdGg+PC9zdmc+" alt="img">答错了，您选择的答案是B</p>
<p><strong>正确答案:</strong>C</p>
</blockquote>
<h3 id="Scenario"><a href="#Scenario" class="headerlink" title="Scenario"></a>Scenario</h3><h3 id="Service"><a href="#Service" class="headerlink" title="Service"></a>Service</h3><ul>
<li>Authentication Service</li>
<li>UserService</li>
<li>FriendshipService</li>
</ul>
<h3 id="Storage"><a href="#Storage" class="headerlink" title="Storage"></a>Storage</h3><p>check SQL &amp; NoSQL &amp; Redis 對 QPS數的支持</p>
<blockquote>
<h5 id="多选题-注册，登录，信息修改使用哪种数据库可以满足？"><a href="#多选题-注册，登录，信息修改使用哪种数据库可以满足？" class="headerlink" title="[多选题]注册，登录，信息修改使用哪种数据库可以满足？"></a>[多选题]注册，登录，信息修改使用哪种数据库可以满足？</h5><p>A.MySQL60.32% 选择</p>
<p>B.Cassandra18.05% 选择</p>
<p>C.Redis13.46% 选择</p>
<p>D.Memcached8.18% 选择</p>
<p><img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBzdGFuZGFsb25lPSJubyI/PjwhRE9DVFlQRSBzdmcgUFVCTElDICItLy9XM0MvL0RURCBTVkcgMS4xLy9FTiIgImh0dHA6Ly93d3cudzMub3JnL0dyYXBoaWNzL1NWRy8xLjEvRFREL3N2ZzExLmR0ZCI+PHN2ZyB0PSIxNTQxNzAwNjYyNTQzIiBjbGFzcz0iaWNvbiIgc3R5bGU9IiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgdmVyc2lvbj0iMS4xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHAtaWQ9IjEwODgiIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB3aWR0aD0iNjQiIGhlaWdodD0iNjQiPjxkZWZzPjxzdHlsZSB0eXBlPSJ0ZXh0L2NzcyI+PC9zdHlsZT48L2RlZnM+PHBhdGggZD0iTTUxMiAwYTUxMiA1MTIgMCAxIDAgMCAxMDI0QTUxMiA1MTIgMCAwIDAgNTEyIDB6IG0xNjUuOTUyIDYzNy43NmwxNS4wNCAxNC45NzZhMjguNDE2IDI4LjQxNiAwIDEgMS00MC4yNTYgNDAuMjU2bC0xNC45NzYtMTUuMDRMNTA5LjUwNCA1NDkuNzYgMzcxLjIgNjg4YTI4LjQxNiAyOC40MTYgMCAxIDEtNDAuMjU2LTQwLjI1NmwxMzguMzA0LTEzOC4yNC0xMjMuMi0xMjMuMi0xNS4xMDQtMTUuMTA0YTI4LjU0NCAyOC41NDQgMCAwIDEgMC00MC4yNTYgMjguNTQ0IDI4LjU0NCAwIDAgMSA0MC4yNTYgMGwxNS4wNCAxNS4xMDRMNTA5LjQ0IDQ2OS4yNDhsMTQzLjIzMi0xNDMuMjk2YTI4LjQxNiAyOC40MTYgMCAxIDEgNDAuMjU2IDQwLjI1Nkw1NDkuNzYgNTA5LjUwNGwxMjguMTkyIDEyOC4yNTZ6IiBmaWxsPSIjRjY1RTVFIiBwLWlkPSIxMDg5Ij48L3BhdGg+PC9zdmc+" alt="img">答错了，您选择的答案是ACD</p>
<p><strong>正确答案:</strong>ABC</p>
<p><strong>解析:</strong></p>
<p>Memcached 不能持久化存储数据，不适合用来存储用户信息</p>
</blockquote>
<blockquote>
<ul>
<li><p>Q: 10k ~ 100k QPS?</p>
<ul>
<li>看需求。可以使用单台redis或者使用多台Cassandra的集群，又或者如果你的场景需要高可靠性的事务支持，但是读多写少，那就MySQL做持久化+memcached做cache优化。不同的数据库有不同的功能，这里列出的QPS只是为了告诉你各个数据库的承载能力，不是说xxxQPS就一定要用xxx数据库，QPS不是唯一决定因素，需要结合实际需求分析。</li>
</ul>
</li>
<li><p>为什么Mysql只支持1k 的QPS,但facebook 依然会选择。 facebook的QPS应该远高于1k吧</p>
<ul>
<li>单机1k左右，但是facebook的是mysql集群，QPS肯定不是这个量级的</li>
</ul>
</li>
<li><p>redis，memcached会比普通的存储贵吗</p>
<ul>
<li>redis memcached 用 memory 多，肯定比主要用 disk 的机器要贵的。</li>
</ul>
</li>
</ul>
</blockquote>
<p>讀多寫少，代表經常不會變！</p>
<blockquote>
<h5 id="多选题-文件系统可以用作缓存么？如果可以，可以做什么的缓存？"><a href="#多选题-文件系统可以用作缓存么？如果可以，可以做什么的缓存？" class="headerlink" title="[多选题]文件系统可以用作缓存么？如果可以，可以做什么的缓存？"></a>[多选题]文件系统可以用作缓存么？如果可以，可以做什么的缓存？</h5><p>A.不可以1.22% 选择</p>
<p>B.用来做网络请求的缓存。30.30% 选择</p>
<p>C.用来做计算结果的缓存34.45% 选择</p>
<p>D.用来做数据库的缓存34.04% 选择</p>
<p><img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBzdGFuZGFsb25lPSJubyI/PjwhRE9DVFlQRSBzdmcgUFVCTElDICItLy9XM0MvL0RURCBTVkcgMS4xLy9FTiIgImh0dHA6Ly93d3cudzMub3JnL0dyYXBoaWNzL1NWRy8xLjEvRFREL3N2ZzExLmR0ZCI+PHN2ZyB0PSIxNTQxNzAwNjYyNTQzIiBjbGFzcz0iaWNvbiIgc3R5bGU9IiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgdmVyc2lvbj0iMS4xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHAtaWQ9IjEwODgiIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB3aWR0aD0iNjQiIGhlaWdodD0iNjQiPjxkZWZzPjxzdHlsZSB0eXBlPSJ0ZXh0L2NzcyI+PC9zdHlsZT48L2RlZnM+PHBhdGggZD0iTTUxMiAwYTUxMiA1MTIgMCAxIDAgMCAxMDI0QTUxMiA1MTIgMCAwIDAgNTEyIDB6IG0xNjUuOTUyIDYzNy43NmwxNS4wNCAxNC45NzZhMjguNDE2IDI4LjQxNiAwIDEgMS00MC4yNTYgNDAuMjU2bC0xNC45NzYtMTUuMDRMNTA5LjUwNCA1NDkuNzYgMzcxLjIgNjg4YTI4LjQxNiAyOC40MTYgMCAxIDEtNDAuMjU2LTQwLjI1NmwxMzguMzA0LTEzOC4yNC0xMjMuMi0xMjMuMi0xNS4xMDQtMTUuMTA0YTI4LjU0NCAyOC41NDQgMCAwIDEgMC00MC4yNTYgMjguNTQ0IDI4LjU0NCAwIDAgMSA0MC4yNTYgMGwxNS4wNCAxNS4xMDRMNTA5LjQ0IDQ2OS4yNDhsMTQzLjIzMi0xNDMuMjk2YTI4LjQxNiAyOC40MTYgMCAxIDEgNDAuMjU2IDQwLjI1Nkw1NDkuNzYgNTA5LjUwNGwxMjguMTkyIDEyOC4yNTZ6IiBmaWxsPSIjRjY1RTVFIiBwLWlkPSIxMDg5Ij48L3BhdGg+PC9zdmc+" alt="img">答错了，您选择的答案是BD</p>
<p><strong>正确答案:</strong>BC</p>
<p><strong>解析:</strong></p>
<p>缓存的目的是让访问变得更快。文件系统的访问比网络访问快，一些耗时很长的计算得到的结果也可以缓存在文件中，但是文件系统的访问速度和数据库的访问速度基本上是差不多，所以一般不会用文件系统来做数据库的缓存，意义不大。</p>
</blockquote>
<blockquote>
<h5 id="多选题-下面哪些写法是“不对”的？"><a href="#多选题-下面哪些写法是“不对”的？" class="headerlink" title="[多选题]下面哪些写法是“不对”的？"></a>[多选题]下面哪些写法是“不对”的？</h5><p>哪些写法可能造成数据的不一致？也就是数据库和缓存中存储的数据不一样。</p>
<p>A.db.set; cache.set29.67% 选择</p>
<p>B.db.set; cache.delete29.48% 选择</p>
<p>C.cache.set; db.set29.83% 选择</p>
<p>D.cache.delete; db.set11.02% 选择</p>
<p><img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBzdGFuZGFsb25lPSJubyI/PjwhRE9DVFlQRSBzdmcgUFVCTElDICItLy9XM0MvL0RURCBTVkcgMS4xLy9FTiIgImh0dHA6Ly93d3cudzMub3JnL0dyYXBoaWNzL1NWRy8xLjEvRFREL3N2ZzExLmR0ZCI+PHN2ZyB0PSIxNTM0MTgxMjgxODM5IiBjbGFzcz0iaWNvbiIgc3R5bGU9IiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgdmVyc2lvbj0iMS4xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHAtaWQ9IjM3NjIiIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB3aWR0aD0iMzIiIGhlaWdodD0iMzIiPjxkZWZzPjxzdHlsZSB0eXBlPSJ0ZXh0L2NzcyI+PC9zdHlsZT48L2RlZnM+PHBhdGggZD0iTTUxOC4xMiA1MTYuMTZtLTQ5MCAwYTQ5MCA0OTAgMCAxIDAgOTgwIDAgNDkwIDQ5MCAwIDEgMC05ODAgMFoiIGZpbGw9IiM1NkI0MzIiIHAtaWQ9IjM3NjMiPjwvcGF0aD48cGF0aCBkPSJNMzkzLjIxMzYxOSA2NjQuMzM1NDk1bTI4LjI4NDI3MS0yOC4yODQyNzFsMjk2Ljk4NDg0OS0yOTYuOTg0ODQ4cTI4LjI4NDI3MS0yOC4yODQyNzEgNTYuNTY4NTQyIDBsMCAwcTI4LjI4NDI3MSAyOC4yODQyNzEgMCA1Ni41Njg1NDJsLTI5Ni45ODQ4NDggMjk2Ljk4NDg0OHEtMjguMjg0MjcxIDI4LjI4NDI3MS01Ni41Njg1NDMgMGwwIDBxLTI4LjI4NDI3MS0yOC4yODQyNzEgMC01Ni41Njg1NDJaIiBmaWxsPSIjRkZGRkZGIiBwLWlkPSIzNzY0Ij48L3BhdGg+PHBhdGggZD0iTTI4OS40Njk4NCA0NTIuODQ3ODgzbTI4LjI4NDI3MSAyOC4yODQyNzFsMTU1LjU2MzQ5MiAxNTUuNTYzNDkycTI4LjI4NDI3MSAyOC4yODQyNzEgMCA1Ni41Njg1NDNsMCAwcS0yOC4yODQyNzEgMjguMjg0MjcxLTU2LjU2ODU0MyAwbC0xNTUuNTYzNDkxLTE1NS41NjM0OTJxLTI4LjI4NDI3MS0yOC4yODQyNzEgMC01Ni41Njg1NDNsMCAwcTI4LjI4NDI3MS0yOC4yODQyNzEgNTYuNTY4NTQyIDBaIiBmaWxsPSIjRkZGRkZGIiBwLWlkPSIzNzY1Ij48L3BhdGg+PC9zdmc+" alt="img">答对了，您选择的答案是ABCD</p>
<p><strong>正确答案:</strong>ABCD</p>
</blockquote>
<blockquote>
<h5 id="单选题-有没有可能第一个执行失败，第二个执行成功？"><a href="#单选题-有没有可能第一个执行失败，第二个执行成功？" class="headerlink" title="[单选题]有没有可能第一个执行失败，第二个执行成功？"></a>[单选题]有没有可能第一个执行失败，第二个执行成功？</h5><p>A.可能，会造成数据不一致55.52% 选择</p>
<p>B.可能，不会造成数据不一致12.52% 选择</p>
<p>C.不可能，不会造成数据不一致31.96% 选择</p>
<p><img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBzdGFuZGFsb25lPSJubyI/PjwhRE9DVFlQRSBzdmcgUFVCTElDICItLy9XM0MvL0RURCBTVkcgMS4xLy9FTiIgImh0dHA6Ly93d3cudzMub3JnL0dyYXBoaWNzL1NWRy8xLjEvRFREL3N2ZzExLmR0ZCI+PHN2ZyB0PSIxNTQxNzAwNjYyNTQzIiBjbGFzcz0iaWNvbiIgc3R5bGU9IiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgdmVyc2lvbj0iMS4xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHAtaWQ9IjEwODgiIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB3aWR0aD0iNjQiIGhlaWdodD0iNjQiPjxkZWZzPjxzdHlsZSB0eXBlPSJ0ZXh0L2NzcyI+PC9zdHlsZT48L2RlZnM+PHBhdGggZD0iTTUxMiAwYTUxMiA1MTIgMCAxIDAgMCAxMDI0QTUxMiA1MTIgMCAwIDAgNTEyIDB6IG0xNjUuOTUyIDYzNy43NmwxNS4wNCAxNC45NzZhMjguNDE2IDI4LjQxNiAwIDEgMS00MC4yNTYgNDAuMjU2bC0xNC45NzYtMTUuMDRMNTA5LjUwNCA1NDkuNzYgMzcxLjIgNjg4YTI4LjQxNiAyOC40MTYgMCAxIDEtNDAuMjU2LTQwLjI1NmwxMzguMzA0LTEzOC4yNC0xMjMuMi0xMjMuMi0xNS4xMDQtMTUuMTA0YTI4LjU0NCAyOC41NDQgMCAwIDEgMC00MC4yNTYgMjguNTQ0IDI4LjU0NCAwIDAgMSA0MC4yNTYgMGwxNS4wNCAxNS4xMDRMNTA5LjQ0IDQ2OS4yNDhsMTQzLjIzMi0xNDMuMjk2YTI4LjQxNiAyOC40MTYgMCAxIDEgNDAuMjU2IDQwLjI1Nkw1NDkuNzYgNTA5LjUwNGwxMjguMTkyIDEyOC4yNTZ6IiBmaWxsPSIjRjY1RTVFIiBwLWlkPSIxMDg5Ij48L3BhdGg+PC9zdmc+" alt="img">答错了，您选择的答案是A</p>
<p><strong>正确答案:</strong>C</p>
<p><strong>解析:</strong></p>
<p>不可能。程序的执行是顺序执行的，第一个语句执行出错以后，第二个语句就不会执行了，用户会收到整个 setUser 操作失败的信息。</p>
</blockquote>
<blockquote>
<h5 id="多选题-cache-delete-db-set-什么情况下会造成数据不一致？"><a href="#多选题-cache-delete-db-set-什么情况下会造成数据不一致？" class="headerlink" title="[多选题]cache.delete + db.set 什么情况下会造成数据不一致？"></a>[多选题]cache.delete + db.set 什么情况下会造成数据不一致？</h5><p>A.多线程38.22% 选择</p>
<p>B.多进程28.27% 选择</p>
<p>C.多机器28.65% 选择</p>
<p>D.cache.delete 成功但 db.set 失败4.87% 选择</p>
<p><img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBzdGFuZGFsb25lPSJubyI/PjwhRE9DVFlQRSBzdmcgUFVCTElDICItLy9XM0MvL0RURCBTVkcgMS4xLy9FTiIgImh0dHA6Ly93d3cudzMub3JnL0dyYXBoaWNzL1NWRy8xLjEvRFREL3N2ZzExLmR0ZCI+PHN2ZyB0PSIxNTQxNzAwNjYyNTQzIiBjbGFzcz0iaWNvbiIgc3R5bGU9IiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgdmVyc2lvbj0iMS4xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHAtaWQ9IjEwODgiIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB3aWR0aD0iNjQiIGhlaWdodD0iNjQiPjxkZWZzPjxzdHlsZSB0eXBlPSJ0ZXh0L2NzcyI+PC9zdHlsZT48L2RlZnM+PHBhdGggZD0iTTUxMiAwYTUxMiA1MTIgMCAxIDAgMCAxMDI0QTUxMiA1MTIgMCAwIDAgNTEyIDB6IG0xNjUuOTUyIDYzNy43NmwxNS4wNCAxNC45NzZhMjguNDE2IDI4LjQxNiAwIDEgMS00MC4yNTYgNDAuMjU2bC0xNC45NzYtMTUuMDRMNTA5LjUwNCA1NDkuNzYgMzcxLjIgNjg4YTI4LjQxNiAyOC40MTYgMCAxIDEtNDAuMjU2LTQwLjI1NmwxMzguMzA0LTEzOC4yNC0xMjMuMi0xMjMuMi0xNS4xMDQtMTUuMTA0YTI4LjU0NCAyOC41NDQgMCAwIDEgMC00MC4yNTYgMjguNTQ0IDI4LjU0NCAwIDAgMSA0MC4yNTYgMGwxNS4wNCAxNS4xMDRMNTA5LjQ0IDQ2OS4yNDhsMTQzLjIzMi0xNDMuMjk2YTI4LjQxNiAyOC40MTYgMCAxIDEgNDAuMjU2IDQwLjI1Nkw1NDkuNzYgNTA5LjUwNGwxMjguMTkyIDEyOC4yNTZ6IiBmaWxsPSIjRjY1RTVFIiBwLWlkPSIxMDg5Ij48L3BhdGg+PC9zdmc+" alt="img">答错了，您选择的答案是D</p>
<p><strong>正确答案:</strong>ABC</p>
<p><strong>解析:</strong></p>
<p>多机器的话自然而然也是多进程的。</p>
</blockquote>
<blockquote>
<h5 id="单选题-能否给数据库和缓存的操作加锁来保证数据一致性？"><a href="#单选题-能否给数据库和缓存的操作加锁来保证数据一致性？" class="headerlink" title="[单选题]能否给数据库和缓存的操作加锁来保证数据一致性？"></a>[单选题]能否给数据库和缓存的操作加锁来保证数据一致性？</h5><p>A.可以加锁47.11% 选择</p>
<p>B.加不了锁52.89% 选择</p>
<p><img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBzdGFuZGFsb25lPSJubyI/PjwhRE9DVFlQRSBzdmcgUFVCTElDICItLy9XM0MvL0RURCBTVkcgMS4xLy9FTiIgImh0dHA6Ly93d3cudzMub3JnL0dyYXBoaWNzL1NWRy8xLjEvRFREL3N2ZzExLmR0ZCI+PHN2ZyB0PSIxNTM0MTgxMjgxODM5IiBjbGFzcz0iaWNvbiIgc3R5bGU9IiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgdmVyc2lvbj0iMS4xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHAtaWQ9IjM3NjIiIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB3aWR0aD0iMzIiIGhlaWdodD0iMzIiPjxkZWZzPjxzdHlsZSB0eXBlPSJ0ZXh0L2NzcyI+PC9zdHlsZT48L2RlZnM+PHBhdGggZD0iTTUxOC4xMiA1MTYuMTZtLTQ5MCAwYTQ5MCA0OTAgMCAxIDAgOTgwIDAgNDkwIDQ5MCAwIDEgMC05ODAgMFoiIGZpbGw9IiM1NkI0MzIiIHAtaWQ9IjM3NjMiPjwvcGF0aD48cGF0aCBkPSJNMzkzLjIxMzYxOSA2NjQuMzM1NDk1bTI4LjI4NDI3MS0yOC4yODQyNzFsMjk2Ljk4NDg0OS0yOTYuOTg0ODQ4cTI4LjI4NDI3MS0yOC4yODQyNzEgNTYuNTY4NTQyIDBsMCAwcTI4LjI4NDI3MSAyOC4yODQyNzEgMCA1Ni41Njg1NDJsLTI5Ni45ODQ4NDggMjk2Ljk4NDg0OHEtMjguMjg0MjcxIDI4LjI4NDI3MS01Ni41Njg1NDMgMGwwIDBxLTI4LjI4NDI3MS0yOC4yODQyNzEgMC01Ni41Njg1NDJaIiBmaWxsPSIjRkZGRkZGIiBwLWlkPSIzNzY0Ij48L3BhdGg+PHBhdGggZD0iTTI4OS40Njk4NCA0NTIuODQ3ODgzbTI4LjI4NDI3MSAyOC4yODQyNzFsMTU1LjU2MzQ5MiAxNTUuNTYzNDkycTI4LjI4NDI3MSAyOC4yODQyNzEgMCA1Ni41Njg1NDNsMCAwcS0yOC4yODQyNzEgMjguMjg0MjcxLTU2LjU2ODU0MyAwbC0xNTUuNTYzNDkxLTE1NS41NjM0OTJxLTI4LjI4NDI3MS0yOC4yODQyNzEgMC01Ni41Njg1NDNsMCAwcTI4LjI4NDI3MS0yOC4yODQyNzEgNTYuNTY4NTQyIDBaIiBmaWxsPSIjRkZGRkZGIiBwLWlkPSIzNzY1Ij48L3BhdGg+PC9zdmc+" alt="img">答对了，您选择的答案是B</p>
<p><strong>正确答案:</strong>B</p>
<p><strong>解析:</strong></p>
<p>加锁以后只能保证在同一个数据上的操作顺序执行，但是无法执行“回滚”，也就是说如果第一个操作成功，第二个操作失败了，也会导致数据的不一致。<br>另外互斥锁（mutex）是多线程内共享的，多进程内无法共享。如果要加锁，只能使用分布式锁，比如 Zookeeper，但是这会导致读取效率急剧降低。得不偿失。</p>
</blockquote>
<blockquote>
<h5 id="单选题-User-Table-的-Cache-Hit-Rate-一般有多少？"><a href="#单选题-User-Table-的-Cache-Hit-Rate-一般有多少？" class="headerlink" title="[单选题]User Table 的 Cache Hit Rate 一般有多少？"></a>[单选题]User Table 的 Cache Hit Rate 一般有多少？</h5><p>A.20%5.16% 选择</p>
<p>B.50%8.32% 选择</p>
<p>C.95%24.54% 选择</p>
<p>D.98%61.98% 选择</p>
<p><img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBzdGFuZGFsb25lPSJubyI/PjwhRE9DVFlQRSBzdmcgUFVCTElDICItLy9XM0MvL0RURCBTVkcgMS4xLy9FTiIgImh0dHA6Ly93d3cudzMub3JnL0dyYXBoaWNzL1NWRy8xLjEvRFREL3N2ZzExLmR0ZCI+PHN2ZyB0PSIxNTM0MTgxMjgxODM5IiBjbGFzcz0iaWNvbiIgc3R5bGU9IiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgdmVyc2lvbj0iMS4xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHAtaWQ9IjM3NjIiIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB3aWR0aD0iMzIiIGhlaWdodD0iMzIiPjxkZWZzPjxzdHlsZSB0eXBlPSJ0ZXh0L2NzcyI+PC9zdHlsZT48L2RlZnM+PHBhdGggZD0iTTUxOC4xMiA1MTYuMTZtLTQ5MCAwYTQ5MCA0OTAgMCAxIDAgOTgwIDAgNDkwIDQ5MCAwIDEgMC05ODAgMFoiIGZpbGw9IiM1NkI0MzIiIHAtaWQ9IjM3NjMiPjwvcGF0aD48cGF0aCBkPSJNMzkzLjIxMzYxOSA2NjQuMzM1NDk1bTI4LjI4NDI3MS0yOC4yODQyNzFsMjk2Ljk4NDg0OS0yOTYuOTg0ODQ4cTI4LjI4NDI3MS0yOC4yODQyNzEgNTYuNTY4NTQyIDBsMCAwcTI4LjI4NDI3MSAyOC4yODQyNzEgMCA1Ni41Njg1NDJsLTI5Ni45ODQ4NDggMjk2Ljk4NDg0OHEtMjguMjg0MjcxIDI4LjI4NDI3MS01Ni41Njg1NDMgMGwwIDBxLTI4LjI4NDI3MS0yOC4yODQyNzEgMC01Ni41Njg1NDJaIiBmaWxsPSIjRkZGRkZGIiBwLWlkPSIzNzY0Ij48L3BhdGg+PHBhdGggZD0iTTI4OS40Njk4NCA0NTIuODQ3ODgzbTI4LjI4NDI3MSAyOC4yODQyNzFsMTU1LjU2MzQ5MiAxNTUuNTYzNDkycTI4LjI4NDI3MSAyOC4yODQyNzEgMCA1Ni41Njg1NDNsMCAwcS0yOC4yODQyNzEgMjguMjg0MjcxLTU2LjU2ODU0MyAwbC0xNTUuNTYzNDkxLTE1NS41NjM0OTJxLTI4LjI4NDI3MS0yOC4yODQyNzEgMC01Ni41Njg1NDNsMCAwcTI4LjI4NDI3MS0yOC4yODQyNzEgNTYuNTY4NTQyIDBaIiBmaWxsPSIjRkZGRkZGIiBwLWlkPSIzNzY1Ij48L3BhdGg+PC9zdmc+" alt="img">答对了，您选择的答案是D</p>
<p><strong>正确答案:</strong>D</p>
<p><strong>解析:</strong></p>
<p>hit rate = cache hit / (cache hit + cache miss)</p>
</blockquote>
<ul>
<li>我们允许数据库和缓存有“短时间”内的不一致，但最终会一致。</li>
</ul>
<blockquote>
<ul>
<li>database.set(key, user);cache.set(key)我觉得没有脏数据啊。当第一个线程1执行到15-16行之间的时候。假如有另一个线程2进入setUser这个函数。线程2的cache.set也会覆盖线程1的cache.set结果的啊，所以旧数据就被覆盖了啊。没有脏数据啊，求解释？</li>
</ul>
<p>假设执行顺序如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">thread 1 line 15: database.set(user) &#x2F;&#x2F; old data</span><br><span class="line">thread 2 line 15: database.set(user) &#x2F;&#x2F; new data</span><br><span class="line">thread 2 line 16: cache.set(user) &#x2F;&#x2F; new data</span><br><span class="line">thread 1 line 15: cache.set(user) &#x2F;&#x2F; old data</span><br></pre></td></tr></table></figure>

<p>最后 cache 里是 old data, database 里是 new data</p>
<p>线程2的cache.set也会覆盖线程1的cache.set结果的啊<br>在上面列举的情况中，是 thread 1 覆盖了 thread 2。要注意 user 是一个局部变量。thread 2 里的 user 和 thread 1 里的 user 的内容是不同的。</p>
</blockquote>
<p>如果寫真的太多太多了，在Cache Aside下，就是加DB啊。</p>
<blockquote>
<ul>
<li>redis包含cache和一个db，是说redis里面包含了relational database management system , rdbms么？ 我记得redis只是缓存，没mysql的呢。<ul>
<li>redis可以跟mysql配合使用，redis会完全接管mysql，自己从mysql里面load数据，所以在外界<strong>看起来</strong>就像是redis里面包了一个mysql一样。并不是说redis里面有一个mysql。</li>
</ul>
</li>
</ul>
</blockquote>
<h2 id="Authentication-Service"><a href="#Authentication-Service" class="headerlink" title="Authentication Service"></a>Authentication Service</h2><h3 id="Session"><a href="#Session" class="headerlink" title="Session"></a>Session</h3><p>可以用uuid()算這個hash值</p>
<p>通常用UUID来作为Session Key(Session Token)，UUID(Universal Unique ID): UUID是由一组32位数的16进制数字所构成，所以UUID理论上的总数为16^32=2^128，约等于3.4 x 10^38。也就是说若每纳秒产生1兆个UUID，要花100亿年才会将所有UUID用完。所以通俗的称之为宇宙爆炸都不会出现重复的ID字段。</p>
<blockquote>
<ul>
<li>cookie 存在browser 的哪里？<ul>
<li>browser 就是一个 client 就是一个客户端软件，是一个 application 是一个 software，一个程序，一段代码。一个 software 要持久化的存储一个东西，最终都是存储在操作系统的文件系统上的。</li>
</ul>
</li>
<li>session key一般有效期多久？<ul>
<li>取决于网站的安全等级，比如银行类的一般浏览器关掉 session key就过期了。社交类的一般就三个月甚至更长。这个可以由网站开发人员自行定义。</li>
</ul>
</li>
<li>any security problems regarding to session key?<ul>
<li>如果你的 session key 被盗，比如你拿了你男朋友女朋友的电脑，悄悄的记录下了 session key，你就可以以你男朋友女朋友的身份登录了。所以通常一些安全性较高的网站，如银行，session key 几分钟就会失效。</li>
</ul>
</li>
<li>session table 是存在数据库里， 还是存在In memory db 里面?<ul>
<li>都是可以的。不过一般都是存在 数据库里，否则memory数据丢了所有用户都会被logout 这个体验并不好。</li>
</ul>
</li>
<li>what if i never log in again? my session will live forever?<ul>
<li>通常网站的逻辑都是最多3个月。session table 里有 expire_at 这个 field，记录了什么时候会过期。一般用户登陆以后，这一项设置为 3 个月。当然你可以根据你网站的安全性要求来设置不同的过期时间，安全性越高的网站过期时间越短。一般不会设置为永久不过期。</li>
</ul>
</li>
</ul>
</blockquote>
<h3 id="Cookies"><a href="#Cookies" class="headerlink" title="Cookies"></a>Cookies</h3><ul>
<li>用户 Login 以后，为他创建一个 session 对象</li>
<li>并把 session_key 返回给浏览器，让浏览器存储起来</li>
<li>浏览器将该值记录在浏览器的 cookie 中</li>
<li>用户每次向服务器发送的访问，都会自动带上该网站所有的 cookie</li>
<li>此时服务器拿到 cookie 中的 session_key，在 Session Table 中检测是否存在，是否过期</li>
<li>Cookie:HTTP协议中浏览器和服务器的沟通机制，服务器把一些用于标记用户身份的信息，传递给 浏览器，浏览器每次访问任何网页链接的时候，都会在 HTTP 请求中带上所有的该网站相关的 Cookie 信息。Cookie 可以理解为一个 Client 端的 hash table。</li>
</ul>
<blockquote>
<h5 id="单选题-Cookie-里存的东西是越多越好么？"><a href="#单选题-Cookie-里存的东西是越多越好么？" class="headerlink" title="[单选题]Cookie 里存的东西是越多越好么？"></a>[单选题]Cookie 里存的东西是越多越好么？</h5><p>A.是的3.13% 选择</p>
<p>B.不是96.87% 选择</p>
<p><img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBzdGFuZGFsb25lPSJubyI/PjwhRE9DVFlQRSBzdmcgUFVCTElDICItLy9XM0MvL0RURCBTVkcgMS4xLy9FTiIgImh0dHA6Ly93d3cudzMub3JnL0dyYXBoaWNzL1NWRy8xLjEvRFREL3N2ZzExLmR0ZCI+PHN2ZyB0PSIxNTM0MTgxMjgxODM5IiBjbGFzcz0iaWNvbiIgc3R5bGU9IiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgdmVyc2lvbj0iMS4xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHAtaWQ9IjM3NjIiIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB3aWR0aD0iMzIiIGhlaWdodD0iMzIiPjxkZWZzPjxzdHlsZSB0eXBlPSJ0ZXh0L2NzcyI+PC9zdHlsZT48L2RlZnM+PHBhdGggZD0iTTUxOC4xMiA1MTYuMTZtLTQ5MCAwYTQ5MCA0OTAgMCAxIDAgOTgwIDAgNDkwIDQ5MCAwIDEgMC05ODAgMFoiIGZpbGw9IiM1NkI0MzIiIHAtaWQ9IjM3NjMiPjwvcGF0aD48cGF0aCBkPSJNMzkzLjIxMzYxOSA2NjQuMzM1NDk1bTI4LjI4NDI3MS0yOC4yODQyNzFsMjk2Ljk4NDg0OS0yOTYuOTg0ODQ4cTI4LjI4NDI3MS0yOC4yODQyNzEgNTYuNTY4NTQyIDBsMCAwcTI4LjI4NDI3MSAyOC4yODQyNzEgMCA1Ni41Njg1NDJsLTI5Ni45ODQ4NDggMjk2Ljk4NDg0OHEtMjguMjg0MjcxIDI4LjI4NDI3MS01Ni41Njg1NDMgMGwwIDBxLTI4LjI4NDI3MS0yOC4yODQyNzEgMC01Ni41Njg1NDJaIiBmaWxsPSIjRkZGRkZGIiBwLWlkPSIzNzY0Ij48L3BhdGg+PHBhdGggZD0iTTI4OS40Njk4NCA0NTIuODQ3ODgzbTI4LjI4NDI3MSAyOC4yODQyNzFsMTU1LjU2MzQ5MiAxNTUuNTYzNDkycTI4LjI4NDI3MSAyOC4yODQyNzEgMCA1Ni41Njg1NDNsMCAwcS0yOC4yODQyNzEgMjguMjg0MjcxLTU2LjU2ODU0MyAwbC0xNTUuNTYzNDkxLTE1NS41NjM0OTJxLTI4LjI4NDI3MS0yOC4yODQyNzEgMC01Ni41Njg1NDNsMCAwcTI4LjI4NDI3MS0yOC4yODQyNzEgNTYuNTY4NTQyIDBaIiBmaWxsPSIjRkZGRkZGIiBwLWlkPSIzNzY1Ij48L3BhdGg+PC9zdmc+" alt="img">答对了，您选择的答案是B</p>
<p><strong>正确答案:</strong>B</p>
<p><strong>解析:</strong></p>
<p>首先 Cookie 的大小 HTTP 协议是有限制的。其次因为每次 Request 都要带上 Cookie 里的内容，因此 Cookie 里存的东西是越少越好而不是越多越好。</p>
</blockquote>
<p>一般就是放個session key表明用戶身份，如掛在胸前的牌，代表授權訪問的用戶。然後去session table查是不是過期了，查uuid(就是session key), 然後知道 user_id，就是client端的hash table。</p>
<blockquote>
<h5 id="单选题-服务器需要主动删除掉过期的-Session-么？"><a href="#单选题-服务器需要主动删除掉过期的-Session-么？" class="headerlink" title="[单选题]服务器需要主动删除掉过期的 Session 么？"></a>[单选题]服务器需要主动删除掉过期的 Session 么？</h5><p>A.需要34.19% 选择</p>
<p>B.不需要65.81% 选择</p>
<p><img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBzdGFuZGFsb25lPSJubyI/PjwhRE9DVFlQRSBzdmcgUFVCTElDICItLy9XM0MvL0RURCBTVkcgMS4xLy9FTiIgImh0dHA6Ly93d3cudzMub3JnL0dyYXBoaWNzL1NWRy8xLjEvRFREL3N2ZzExLmR0ZCI+PHN2ZyB0PSIxNTQxNzAwNjYyNTQzIiBjbGFzcz0iaWNvbiIgc3R5bGU9IiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgdmVyc2lvbj0iMS4xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHAtaWQ9IjEwODgiIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB3aWR0aD0iNjQiIGhlaWdodD0iNjQiPjxkZWZzPjxzdHlsZSB0eXBlPSJ0ZXh0L2NzcyI+PC9zdHlsZT48L2RlZnM+PHBhdGggZD0iTTUxMiAwYTUxMiA1MTIgMCAxIDAgMCAxMDI0QTUxMiA1MTIgMCAwIDAgNTEyIDB6IG0xNjUuOTUyIDYzNy43NmwxNS4wNCAxNC45NzZhMjguNDE2IDI4LjQxNiAwIDEgMS00MC4yNTYgNDAuMjU2bC0xNC45NzYtMTUuMDRMNTA5LjUwNCA1NDkuNzYgMzcxLjIgNjg4YTI4LjQxNiAyOC40MTYgMCAxIDEtNDAuMjU2LTQwLjI1NmwxMzguMzA0LTEzOC4yNC0xMjMuMi0xMjMuMi0xNS4xMDQtMTUuMTA0YTI4LjU0NCAyOC41NDQgMCAwIDEgMC00MC4yNTYgMjguNTQ0IDI4LjU0NCAwIDAgMSA0MC4yNTYgMGwxNS4wNCAxNS4xMDRMNTA5LjQ0IDQ2OS4yNDhsMTQzLjIzMi0xNDMuMjk2YTI4LjQxNiAyOC40MTYgMCAxIDEgNDAuMjU2IDQwLjI1Nkw1NDkuNzYgNTA5LjUwNGwxMjguMTkyIDEyOC4yNTZ6IiBmaWxsPSIjRjY1RTVFIiBwLWlkPSIxMDg5Ij48L3BhdGg+PC9zdmc+" alt="img">答错了，您选择的答案是A</p>
<p><strong>正确答案:</strong>B</p>
<p><strong>解析:</strong></p>
<p>做 lazy loading 就好了。因为有 expire_at，无需主动删除，被动删除即可，即在用户登陆的时候发现过期了再删。</p>
</blockquote>
<blockquote>
<ul>
<li>session table 是存在数据库里， 还是存在In memory db 里面?<ul>
<li>都是可以的。不过一般都是存在 数据库里，否则memory数据丢了所有用户都会被logout 这个体验并不好。</li>
</ul>
</li>
</ul>
</blockquote>
<p>device token 也可紀錄在 session table, </p>
<blockquote>
<h5 id="单选题-Session-Table-适合存储在什么数据库里？"><a href="#单选题-Session-Table-适合存储在什么数据库里？" class="headerlink" title="[单选题]Session Table 适合存储在什么数据库里？"></a>[单选题]Session Table 适合存储在什么数据库里？</h5><p>A.Memcached21.64% 选择</p>
<p>B.MySQL22.46% 选择</p>
<p>C.Memcached + MySQL55.90% 选择</p>
<p><img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBzdGFuZGFsb25lPSJubyI/PjwhRE9DVFlQRSBzdmcgUFVCTElDICItLy9XM0MvL0RURCBTVkcgMS4xLy9FTiIgImh0dHA6Ly93d3cudzMub3JnL0dyYXBoaWNzL1NWRy8xLjEvRFREL3N2ZzExLmR0ZCI+PHN2ZyB0PSIxNTQxNzAwNjYyNTQzIiBjbGFzcz0iaWNvbiIgc3R5bGU9IiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgdmVyc2lvbj0iMS4xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHAtaWQ9IjEwODgiIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB3aWR0aD0iNjQiIGhlaWdodD0iNjQiPjxkZWZzPjxzdHlsZSB0eXBlPSJ0ZXh0L2NzcyI+PC9zdHlsZT48L2RlZnM+PHBhdGggZD0iTTUxMiAwYTUxMiA1MTIgMCAxIDAgMCAxMDI0QTUxMiA1MTIgMCAwIDAgNTEyIDB6IG0xNjUuOTUyIDYzNy43NmwxNS4wNCAxNC45NzZhMjguNDE2IDI4LjQxNiAwIDEgMS00MC4yNTYgNDAuMjU2bC0xNC45NzYtMTUuMDRMNTA5LjUwNCA1NDkuNzYgMzcxLjIgNjg4YTI4LjQxNiAyOC40MTYgMCAxIDEtNDAuMjU2LTQwLjI1NmwxMzguMzA0LTEzOC4yNC0xMjMuMi0xMjMuMi0xNS4xMDQtMTUuMTA0YTI4LjU0NCAyOC41NDQgMCAwIDEgMC00MC4yNTYgMjguNTQ0IDI4LjU0NCAwIDAgMSA0MC4yNTYgMGwxNS4wNCAxNS4xMDRMNTA5LjQ0IDQ2OS4yNDhsMTQzLjIzMi0xNDMuMjk2YTI4LjQxNiAyOC40MTYgMCAxIDEgNDAuMjU2IDQwLjI1Nkw1NDkuNzYgNTA5LjUwNGwxMjguMTkyIDEyOC4yNTZ6IiBmaWxsPSIjRjY1RTVFIiBwLWlkPSIxMDg5Ij48L3BhdGg+PC9zdmc+" alt="img">答错了，您选择的答案是B</p>
<p><strong>正确答案:</strong>C</p>
</blockquote>
<p>如果自己建個網站，用戶不多，放在Memcache裡也Ok, 就算斷了，用戶就是再重登一次，不會怎樣，畢竟不是用戶信息的不能丟的。</p>
<p>大網站就最好撐久點，讓體驗好，訪問效率高</p>
<blockquote>
<ul>
<li>那个device id那一块，如何实现？有点模糊。<ul>
<li>就是在每个device第一次登录的时候给他分配一个id，然后把这个id放到该设备的cookie中，每次访问网站的时候都要带上这个id，这样根据id就能知道当前活动的是哪台设备了。</li>
</ul>
</li>
<li>db如何设计呢？如何判断这个session 是这个user，然后把之前的ipad的session logout，再让这个iphone的session建立？<ul>
<li>如果用NoSQL，那么表中的每一行可以是{user_id, session, expire_at，其中user_id是foreign key并且建立了index方便快速查找，session在生成的时候可以encode进去user_id的信息，方便直接从session中识别出当前用户。如果是key-value NoSQL，那就直接把上述结构改为user_id ==&gt; {session, expire_at}就行了。<br>当用户登录的时候直接生成一个新的session替换掉原来的。<br>当旧设备的session再次尝试请求数据的时候，先从session中decode出user_id，然后去查表，然后会发现表中的session跟当前的session不是同一个，那就强制logout。</li>
</ul>
</li>
<li>每个device 都会有一个 session key 吗？<ul>
<li>session key 和 device 不是绑定的关系。 session key 是记录某次登录后所形成的客户端与服务器端的保持通话的记录的 key。同一台机器上的不同的浏览器登录以后的 session key一般就是不同的。像 Google Chrome 这种支持多用户的浏览器，切换用户以后，就相当于切换浏览器一样，session 记录也是不同的。</li>
</ul>
</li>
<li>如果一个ipad来登陆来了，如何把iphone的session key给expire还是删除呢？如何判断，这2个device是一个user？如果问，如何回答。<ul>
<li>用同一个账号登录肯定就是同一个user。如果登录之后发现在session table中该账号有一个active的session，就可以把这个session 给expire了然后写一个新的进去。</li>
</ul>
</li>
<li>登陆之后，发现该账号已经有一个active user，就可以把这个session给expire了。这个“expire”操作具体是怎样进行的？<ul>
<li>这种情况可以直接删除该行记录。</li>
</ul>
</li>
<li>想问一下RESTful API里面比如POST一个新blog的请求会用session_key来验证user吗？<ul>
<li>也会的，只要是需要authorization的操作都需要验证当前用户的session.</li>
</ul>
</li>
</ul>
</blockquote>
<h2 id="Friendship-Storage-amp-Query"><a href="#Friendship-Storage-amp-Query" class="headerlink" title="Friendship Storage &amp; Query"></a>Friendship Storage &amp; Query</h2><p>單向：Twitter, Ins, Weibo</p>
<p>雙向：WeChat, FB, WhatsApp</p>
<blockquote>
<h5 id="单选题-为什么要区分-smaller-user-id-和-bigger-user-id？"><a href="#单选题-为什么要区分-smaller-user-id-和-bigger-user-id？" class="headerlink" title="[单选题]为什么要区分 smaller_user_id 和 bigger_user_id？"></a>[单选题]为什么要区分 smaller_user_id 和 bigger_user_id？</h5><p>A.否则查询 A 和 B 是否为好友的时候会变慢55.84% 选择</p>
<p>B.否则查询 A 的所有好友的时候会变慢32.22% 选择</p>
<p>C.猜不到11.94% 选择</p>
<p><img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBzdGFuZGFsb25lPSJubyI/PjwhRE9DVFlQRSBzdmcgUFVCTElDICItLy9XM0MvL0RURCBTVkcgMS4xLy9FTiIgImh0dHA6Ly93d3cudzMub3JnL0dyYXBoaWNzL1NWRy8xLjEvRFREL3N2ZzExLmR0ZCI+PHN2ZyB0PSIxNTM0MTgxMjgxODM5IiBjbGFzcz0iaWNvbiIgc3R5bGU9IiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgdmVyc2lvbj0iMS4xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHAtaWQ9IjM3NjIiIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB3aWR0aD0iMzIiIGhlaWdodD0iMzIiPjxkZWZzPjxzdHlsZSB0eXBlPSJ0ZXh0L2NzcyI+PC9zdHlsZT48L2RlZnM+PHBhdGggZD0iTTUxOC4xMiA1MTYuMTZtLTQ5MCAwYTQ5MCA0OTAgMCAxIDAgOTgwIDAgNDkwIDQ5MCAwIDEgMC05ODAgMFoiIGZpbGw9IiM1NkI0MzIiIHAtaWQ9IjM3NjMiPjwvcGF0aD48cGF0aCBkPSJNMzkzLjIxMzYxOSA2NjQuMzM1NDk1bTI4LjI4NDI3MS0yOC4yODQyNzFsMjk2Ljk4NDg0OS0yOTYuOTg0ODQ4cTI4LjI4NDI3MS0yOC4yODQyNzEgNTYuNTY4NTQyIDBsMCAwcTI4LjI4NDI3MSAyOC4yODQyNzEgMCA1Ni41Njg1NDJsLTI5Ni45ODQ4NDggMjk2Ljk4NDg0OHEtMjguMjg0MjcxIDI4LjI4NDI3MS01Ni41Njg1NDMgMGwwIDBxLTI4LjI4NDI3MS0yOC4yODQyNzEgMC01Ni41Njg1NDJaIiBmaWxsPSIjRkZGRkZGIiBwLWlkPSIzNzY0Ij48L3BhdGg+PHBhdGggZD0iTTI4OS40Njk4NCA0NTIuODQ3ODgzbTI4LjI4NDI3MSAyOC4yODQyNzFsMTU1LjU2MzQ5MiAxNTUuNTYzNDkycTI4LjI4NDI3MSAyOC4yODQyNzEgMCA1Ni41Njg1NDNsMCAwcS0yOC4yODQyNzEgMjguMjg0MjcxLTU2LjU2ODU0MyAwbC0xNTUuNTYzNDkxLTE1NS41NjM0OTJxLTI4LjI4NDI3MS0yOC4yODQyNzEgMC01Ni41Njg1NDNsMCAwcTI4LjI4NDI3MS0yOC4yODQyNzEgNTYuNTY4NTQyIDBaIiBmaWxsPSIjRkZGRkZGIiBwLWlkPSIzNzY1Ij48L3BhdGg+PC9zdmc+" alt="img">答对了，您选择的答案是A</p>
<p><strong>正确答案:</strong>A</p>
<p><strong>解析:</strong></p>
<p>查询 A 的所有好友不会变慢，因为依然是 select * from friendship where user_id1=A or user_id2=A。</p>
</blockquote>
<blockquote>
<ul>
<li>smaller_user_id，bigger_user_id这里，没有太理解为什么有可能多存一份好友关系。如果已建立好友关系，在什么情况下会出现再次插入同样的好友关系呢？UI端不是应该不支持再次建立好友关系的操作了吗？还是说为了逻辑上更严谨，使A和B成为好友关系只有一种数据存储模式？<ul>
<li>作为一个有经验的工程师，除了在前端要避免重复创建好友以外，后端也是需要相同逻辑的（比如预防一些别有用心的黑客）<br>当你要存 1 和 2 是好友的时候，你可能存为 &lt;1,2&gt; 也可能存为 &lt;2,1&gt;。我们只存成 &lt;1,2&gt; 的形式，原因有两个，第一是方便查询，否则你查询的时候得分别差 &lt;1,2&gt; 是否存在和 &lt;2,1&gt; 是否存在。第二个是节省一半的存储空间。</li>
</ul>
</li>
</ul>
</blockquote>
<p>雙向好友存成兩條還是比較好，雖然多一倍的量，但查詢時不需要 smaller_user_id = x or  bigger_uesr_id = x ，那個 or 的查詢操作很花時間。在線的服務需要簡單快速的查詢語句。可能明年hardware自己就快了一倍，會讓現在的速度優化沒意思。</p>
<blockquote>
<ul>
<li>数据库存的数据越多，不会查询越慢吗？<ul>
<li>会。但是由于据库或者有索引（索引就是用来加快数据查询速度的额外数据结构），又或者本身就是in-memory的hashtable，其查询时长随数据量的增加而增加的曲线其实非常平缓。</li>
</ul>
</li>
</ul>
</blockquote>
<p>transaction - 事务。代表一些列操作要打包在一起，同时成果或者同时失败。比如我转你 10 块钱，你的余额要 +10，我的余额要 -10。这是两条数据库操作，必须同时成功或者同时失败。不能只有一条操作成功。这种打包，就叫做 Transaction。    </p>
<blockquote>
<ul>
<li>NoSQL支持transaction吗？<ul>
<li>有一些支持，有一些不支持</li>
</ul>
</li>
<li>保证一个数据库中同时成功或者同时失败的语句是什么？<ul>
<li>这个要靠数据库的transaction机制</li>
</ul>
</li>
</ul>
</blockquote>
<h2 id="Cassandra-as-NoSQL"><a href="#Cassandra-as-NoSQL" class="headerlink" title="Cassandra as NoSQL"></a>Cassandra as NoSQL</h2><blockquote>
<h5 id="多选题-什么是序列化-Serialization，下列说法正确的是"><a href="#多选题-什么是序列化-Serialization，下列说法正确的是" class="headerlink" title="[多选题]什么是序列化 Serialization，下列说法正确的是"></a>[多选题]什么是序列化 Serialization，下列说法正确的是</h5><p>A.将内存中的数据（或者某个 class 的 object）变成一个字符串的过程36.89% 选择</p>
<p>B.JSON 是一种序列化格式27.30% 选择</p>
<p>C.序列化的作用是让数据可以进行传输和存储34.58% 选择</p>
<p>D.我不懂什么是序列化，请多给我讲讲1.24% 选择</p>
<p><img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBzdGFuZGFsb25lPSJubyI/PjwhRE9DVFlQRSBzdmcgUFVCTElDICItLy9XM0MvL0RURCBTVkcgMS4xLy9FTiIgImh0dHA6Ly93d3cudzMub3JnL0dyYXBoaWNzL1NWRy8xLjEvRFREL3N2ZzExLmR0ZCI+PHN2ZyB0PSIxNTQxNzAwNjYyNTQzIiBjbGFzcz0iaWNvbiIgc3R5bGU9IiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgdmVyc2lvbj0iMS4xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHAtaWQ9IjEwODgiIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB3aWR0aD0iNjQiIGhlaWdodD0iNjQiPjxkZWZzPjxzdHlsZSB0eXBlPSJ0ZXh0L2NzcyI+PC9zdHlsZT48L2RlZnM+PHBhdGggZD0iTTUxMiAwYTUxMiA1MTIgMCAxIDAgMCAxMDI0QTUxMiA1MTIgMCAwIDAgNTEyIDB6IG0xNjUuOTUyIDYzNy43NmwxNS4wNCAxNC45NzZhMjguNDE2IDI4LjQxNiAwIDEgMS00MC4yNTYgNDAuMjU2bC0xNC45NzYtMTUuMDRMNTA5LjUwNCA1NDkuNzYgMzcxLjIgNjg4YTI4LjQxNiAyOC40MTYgMCAxIDEtNDAuMjU2LTQwLjI1NmwxMzguMzA0LTEzOC4yNC0xMjMuMi0xMjMuMi0xNS4xMDQtMTUuMTA0YTI4LjU0NCAyOC41NDQgMCAwIDEgMC00MC4yNTYgMjguNTQ0IDI4LjU0NCAwIDAgMSA0MC4yNTYgMGwxNS4wNCAxNS4xMDRMNTA5LjQ0IDQ2OS4yNDhsMTQzLjIzMi0xNDMuMjk2YTI4LjQxNiAyOC40MTYgMCAxIDEgNDAuMjU2IDQwLjI1Nkw1NDkuNzYgNTA5LjUwNGwxMjguMTkyIDEyOC4yNTZ6IiBmaWxsPSIjRjY1RTVFIiBwLWlkPSIxMDg5Ij48L3BhdGg+PC9zdmc+" alt="img">答错了，您选择的答案是AC</p>
<p><strong>正确答案:</strong>ABC</p>
<p><strong>相关知识点:</strong>什么是序列化 Serialization</p>
</blockquote>
<ul>
<li><p>Row key : hash key, partition key, 去算存在哪個機器上。NoSQL主要是要實現分布式，不同機器上，不能每台機器上存一份，需要一個sharding或partition的算法。Cassandra會根據row key去算一個hash。不支援範圍查詢。</p>
</li>
<li><p>col key : 是排序的，類似用B+樹作有序是叫LSM Tree。在同個row key之下。可以是多元組排序。</p>
</li>
</ul>
<blockquote>
<ul>
<li>sql型数据库是只要建了index就可以支持范围查询的。— 那sql型数据库，是自动每一个列都建index么？因为貌似每一个列都是可以range 查询的吧<ul>
<li>准确地说是sql型数据库是建立了index就可以支持<strong>快速的范围查询</strong>，即使没有index也是支持范围查询的，只不过会很慢。<br>你需要手动指定为哪些列创建index，因为index是有一定开销的，除了磁盘占用会多一点之外，你每增加删除一条记录的时候数据库也都要维护相应的index。换句话说，快速的范围查询是有一定代价的，所以需要用户自己去权衡应不应该给某一个列加index。</li>
</ul>
</li>
<li>如果把user_id作为row_key, 那么在column_key里再把它放进去其实没什么意义吧？因为查的时候user_id肯定是一个确定的值、而非范围了。<ul>
<li>对，不需要重复访进去。这里只是举个例子。因为有的时候 row_key 不是 user_id。这页 PPT 和上一页在分别讲两件事情。</li>
</ul>
</li>
<li>类似JSON？<ul>
<li>是的，可以通过 JSON Serialize 到 value 里</li>
</ul>
</li>
<li>在NoSQL里有primary key的概念吗？应该如何避免同一个数据被存了两次<ul>
<li>在NoSQL里有primary key的概念吗？应该如何避免同一个数据被存了两次</li>
</ul>
</li>
<li>我通过row_key(user_id) 知道数据存在那一台机器上之后，该台机器上应该是存了很多user的信息的，那我还是在进行一个for循环找到所有该用户的rows吗？再通过friend_user_id 来查找。<ul>
<li>不是的。同一台机器上的数据是按照 row_key + column_key 排好序的，你可以理解为你可以在一台机器上按照 index 去找到你要的 row_key 的那些数据。</li>
</ul>
</li>
</ul>
</blockquote>
<p>NoSQL是以格子為單位的，不是以行為一筆的。</p>
<blockquote>
<h5 id="单选题-查询最近一天之内关注的好友该怎么办？"><a href="#单选题-查询最近一天之内关注的好友该怎么办？" class="headerlink" title="[单选题]查询最近一天之内关注的好友该怎么办？"></a>[单选题]查询最近一天之内关注的好友该怎么办？</h5><p>A.将 timestamp 设置为 row_key7.75% 选择</p>
<p>B.将 timestamp 设置为 column_key91.15% 选择</p>
<p>C.不会1.10% 选择</p>
<p><img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBzdGFuZGFsb25lPSJubyI/PjwhRE9DVFlQRSBzdmcgUFVCTElDICItLy9XM0MvL0RURCBTVkcgMS4xLy9FTiIgImh0dHA6Ly93d3cudzMub3JnL0dyYXBoaWNzL1NWRy8xLjEvRFREL3N2ZzExLmR0ZCI+PHN2ZyB0PSIxNTM0MTgxMjgxODM5IiBjbGFzcz0iaWNvbiIgc3R5bGU9IiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgdmVyc2lvbj0iMS4xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHAtaWQ9IjM3NjIiIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB3aWR0aD0iMzIiIGhlaWdodD0iMzIiPjxkZWZzPjxzdHlsZSB0eXBlPSJ0ZXh0L2NzcyI+PC9zdHlsZT48L2RlZnM+PHBhdGggZD0iTTUxOC4xMiA1MTYuMTZtLTQ5MCAwYTQ5MCA0OTAgMCAxIDAgOTgwIDAgNDkwIDQ5MCAwIDEgMC05ODAgMFoiIGZpbGw9IiM1NkI0MzIiIHAtaWQ9IjM3NjMiPjwvcGF0aD48cGF0aCBkPSJNMzkzLjIxMzYxOSA2NjQuMzM1NDk1bTI4LjI4NDI3MS0yOC4yODQyNzFsMjk2Ljk4NDg0OS0yOTYuOTg0ODQ4cTI4LjI4NDI3MS0yOC4yODQyNzEgNTYuNTY4NTQyIDBsMCAwcTI4LjI4NDI3MSAyOC4yODQyNzEgMCA1Ni41Njg1NDJsLTI5Ni45ODQ4NDggMjk2Ljk4NDg0OHEtMjguMjg0MjcxIDI4LjI4NDI3MS01Ni41Njg1NDMgMGwwIDBxLTI4LjI4NDI3MS0yOC4yODQyNzEgMC01Ni41Njg1NDJaIiBmaWxsPSIjRkZGRkZGIiBwLWlkPSIzNzY0Ij48L3BhdGg+PHBhdGggZD0iTTI4OS40Njk4NCA0NTIuODQ3ODgzbTI4LjI4NDI3MSAyOC4yODQyNzFsMTU1LjU2MzQ5MiAxNTUuNTYzNDkycTI4LjI4NDI3MSAyOC4yODQyNzEgMCA1Ni41Njg1NDNsMCAwcS0yOC4yODQyNzEgMjguMjg0MjcxLTU2LjU2ODU0MyAwbC0xNTUuNTYzNDkxLTE1NS41NjM0OTJxLTI4LjI4NDI3MS0yOC4yODQyNzEgMC01Ni41Njg1NDNsMCAwcTI4LjI4NDI3MS0yOC4yODQyNzEgNTYuNTY4NTQyIDBaIiBmaWxsPSIjRkZGRkZGIiBwLWlkPSIzNzY1Ij48L3BhdGg+PC9zdmc+" alt="img">答对了，您选择的答案是B</p>
<p><strong>正确答案:</strong>B</p>
</blockquote>
<blockquote>
<ul>
<li><em>column key能放多个值吗? 同时放friendID和timestamp</em><ul>
<li><em>yes</em></li>
</ul>
</li>
<li><em>可以设多个Column Key吗？</em><ul>
<li><em>可以的 列存储可以有很多column的</em></li>
</ul>
</li>
<li><em>如果有的时候想sort by timestamp 有的时候想sort by id怎么办</em><ul>
<li><em>建两张表，一张 sort by timestamp，一张 sort by id。插入或者修改数据的时候，两张表都操作一下。</em></li>
</ul>
</li>
<li><em>想请问一下，当查询某个user的newsfeed的时候，我们只已知user_id和想查询的时间段，但是我们不知道会有哪些tweet id。Cassandra的查询不是需要提供row key &amp; column key，才能得知value吗？ 既然我不知道会有哪些tweet id，这样我就无法得知column key是什么</em><ul>
<li><em>在newsfeed的column key里，第一项是 timestamp，第二项可以是 tweet id 也可以把 tweet id放在 value 里。 Cassandra的查询是不需要指定 column key 的第二项的。只要有 column key 的第一项的 timestamp 的 range 就可以了。</em></li>
</ul>
</li>
<li><em>column_key都是cache的吗？那value是在disk上吗？</em><ul>
<li><em>这里主要是想解释为什么把tweet_id放在column key里面好一点。原因是weet_id所对应的tweet data可能已经在cache里了，如果把tweet id放在value中的话，那么就必须要row_key, column_key和value都读出来，这样不能充分利用cache里面的数据。但如果是把tweet id放在column key里面的话，那么读到column key的时候如果发现tweet id对应的tweet data已经在cache中了那就不需要继续去读value了，这样可以节省一步NoSQL读操作。</em></li>
</ul>
</li>
<li><em>复合型的column key是将几个column组合成一个key？还是将原本几个column合成一个column，然后将这单个的column当key (比如合成后的单column 里数据的格式为：timestamp_tweetID)?</em><ul>
<li><em>前者。几个 column 组成一个 key。类似 SQL 里的 multi-column index （composite index）</em></li>
</ul>
</li>
<li><em>这里的column_key,为什么是created_at1,tweet_id1, 这是一个复合的。第一个是按时间，第二个是按tweet id排序，是吗？</em><ul>
<li><em>column_key 可以是一个复合 key。你可以认为是一个二元组，然后按照这个二元组进行排序。那么 column key 在排序的时候就会先按照 created_at 排序，如果created_at 相同的才按照 tweet_id 排序。这里其实不把 tweet_id 放在 column_key 里也没有关系，最主要是需要按照 created_at 排序。</em></li>
</ul>
</li>
</ul>
</blockquote>
<img src="https://tva1.sinaimg.cn/large/00831rSTgy1gdb5m0zj17j30re0i0n3l.jpg" alt="image-20200329221212550" style="zoom:67%;" />

<blockquote>
<ul>
<li>SQL不支持分布式吗？<ul>
<li>是支持的，但是一般需要你手动做sharding之类的工作，用起来没有NoSQL的分布式那么简单。而NoSQL大多支持“开箱即用”的分布式。</li>
</ul>
</li>
<li><em>NoSQL 快是因为用的hash吗？SQL慢是因为不是hash吗？</em><ul>
<li><em>NoSQL快是因为其相对SQL来说少了很多功能，更轻量级。比如NoSQL通常不支持ACID的transaction, 并且大多数据模型很简单（比如memcached就只是存储key-value)，大多不支持自建index，不支持compound index， 有些甚至不支持持久化。少了很多负担，自然就多了很多优化的余地。</em></li>
</ul>
</li>
<li><em>cassandra可以有好几个column key，用起来和SQL的multi key有什么不同？</em><ul>
<li><em>你说的这个是compound key吧？这个是两个不同的概念，compound key指的是在一个表中，可以用两个或多个column的组合来作为primary key，比如一个表中存了某个物体的：（x坐标，y坐标，z坐标，形状，其它信息），那么就可以以(x坐标，y坐标，z坐标）这三个column的组合来作为一个compound key，以此唯一索引一个物体。</em><br><em>而Cassandra可以被认为是一个巨大的二维数组，row key是第一维下标，column key是第二维下标，因此db[row key][column key]唯一决定了一个数组元素，比如db[user_name][email].</em></li>
</ul>
</li>
</ul>
</blockquote>
<img src="https://tva1.sinaimg.cn/large/00831rSTgy1gdb5ivnrq3j30lu0gqgms.jpg" alt="image-20200329220834459" style="zoom:67%;" />

<blockquote>
<ul>
<li>cassandra 第二个表没有user_id 是怎么从user_name 找到 user_id 的？<ul>
<li>第二个表里 username 是 key，user_id 是value，直接就查到了。</li>
</ul>
</li>
<li>在同时创建多张表单时，Cassandra的row_key是email/phone/username,user_id是不是应该放在column_key里？要不怎么找到对应的user_id。<ul>
<li>user_id 放在 column_key 或者放在 value 里都可以的。如果你放在 value 里，可以把 column_key 设置为一直是 null。也就是其实你用不上 Cassandra Column Key 排序的特性。另外一个替代的数据库是 RocksDB，这个就是纯 key-value 了。直接key=username, value=user_id 就可以。</li>
</ul>
</li>
</ul>
</blockquote>
<img src="https://tva1.sinaimg.cn/large/00831rSTgy1gdb5kszh1nj30n60g4js8.jpg" alt="image-20200329221059107" style="zoom:67%;" />

<blockquote>
<ul>
<li>如果A和B的好友比较多，这样耗时比较多吧？<ul>
<li>一般共同好友的功能在双向好友关系的社交网络中才比较有有意义。单向的话，会是“共同关注”，或者你的好友里谁关注了他，一般不会有“共同粉丝”的功能。因此这个“关注” 或者好友的量级一般都在千人这个级别（FB和微信都差不多是5k的好友限制）因此并不慢。</li>
</ul>
</li>
</ul>
</blockquote>
<img src="https://tva1.sinaimg.cn/large/00831rSTgy1gdb5sm2nyoj30vs0km3zp.jpg" alt="image-20200329221827305" style="zoom:67%;" />

<img src="https://tva1.sinaimg.cn/large/00831rSTgy1gdb5t57414j30wc0f676n.jpg" alt="image-20200329221858313" style="zoom:67%;" />

<blockquote>
<ul>
<li>直接在A的二度里查B不可以吗？<ul>
<li>在 A 的二度里查询 B 查到了是二度关系，查不到是 &gt;= 3度的关系。这里问题的需求3度也需要知道是不是3度，&gt;3度的标记为 3+。因此只在 A的二度里查B还不够。</li>
</ul>
</li>
</ul>
</blockquote>
<blockquote>
<ul>
<li><p>如果一个用户没有进行登录或者注册，如何识别两次 Request 来自同一个用户呢？</p>
<ul>
<li><p>IP Address 是不可以的，因为在同一个局域网下的不同用户会共享同一个对外的 IP Address。</p>
<p>正确的做法，是为用户生成一个 uuid （Universal Unique ID）作为他的标识，有很多库函数可以生成这个 uuid，这是一个字符串，可以认为不同的用户一定会生成不同的 uuid。服务器端生成这个 uuid 之后返回给浏览器端，浏览器端存储在 cookie 里，之后每次请求都会带上。如果服务器发现 cookie 里没有这个 uuid 就说明可能是一个新用户，就为其分配新的 uuid，否则不改变这个 uuid。这样我们就可以用 uuid 来识别一个未登录的用户了。</p>
<p>这样的方法如果你清空 cookie 或者换了浏览器以后，可能会被分配到一个新的 uuid，那么你之前的 requests 和之后的 requests 就可能会被服务器识别为两个不同的用户。这个是没有办法解决的了。因为神仙也无法知道你换了浏览器以后坐在电脑前的是不是还是你自己。</p>
</li>
</ul>
</li>
</ul>
</blockquote>
</div><hr></div><nav id="pagination"><div class="pagination"><a class="extend prev" rel="prev" href="/page/50/"><i class="fa fa-chevron-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/50/">50</a><span class="page-number current">51</span><a class="page-number" href="/page/52/">52</a><span class="space">&hellip;</span><a class="page-number" href="/page/60/">60</a><a class="extend next" rel="next" href="/page/52/"><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2013 - 2020 By Joe Huang</div><div class="framework-info"><span>Driven - </span><a href="http://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody" target="_blank" rel="noopener"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_site_uv"><i class="fa fa-user"></i><span id="busuanzi_value_site_uv"></span><span></span></span><span class="footer-separator">|</span><span id="busuanzi_container_site_pv"><i class="fa fa-eye"></i><span id="busuanzi_value_site_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.6.1"></script><script src="/js/fancybox.js?version=1.6.1"></script><script src="/js/sidebar.js?version=1.6.1"></script><script src="/js/copy.js?version=1.6.1"></script><script src="/js/fireworks.js?version=1.6.1"></script><script src="/js/transition.js?version=1.6.1"></script><script src="/js/scroll.js?version=1.6.1"></script><script src="/js/head.js?version=1.6.1"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script></body></html>